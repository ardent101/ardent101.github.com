<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов | Ardent101</title><meta name=keywords content="Active Directory,Kerberos,Pentest,Теория,Делегирование"><meta name=description content="Ранее были рассмотрены механизмы неограниченного и ограниченного делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.
Устройство ограниченного на основе ресурсов делегирования Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.
Для настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии SeEnableDelegation, которой по умолчанию обладали только учетные записи с правами уровня администратора домена."><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.io/posts/kerberos_rbcd/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.io/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.io/static/favicon-32x32.png><link rel=apple-touch-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов"><meta property="og:description" content="Ранее были рассмотрены механизмы неограниченного и ограниченного делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.
Устройство ограниченного на основе ресурсов делегирования Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.
Для настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии SeEnableDelegation, которой по умолчанию обладали только учетные записи с правами уровня администратора домена."><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.io/posts/kerberos_rbcd/"><meta property="og:image" content="https://ardent101.github.io/posts/kerberos_rbcd/images/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-20T09:31:03+00:00"><meta property="article:modified_time" content="2022-10-20T09:31:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.io/posts/kerberos_rbcd/images/logo.png"><meta name=twitter:title content="Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов"><meta name=twitter:description content="Ранее были рассмотрены механизмы неограниченного и ограниченного делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.
Устройство ограниченного на основе ресурсов делегирования Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.
Для настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии SeEnableDelegation, которой по умолчанию обладали только учетные записи с правами уровня администратора домена."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов","item":"https://ardent101.github.io/posts/kerberos_rbcd/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов","name":"Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов","description":"Ранее были рассмотрены механизмы неограниченного и ограниченного делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.\nУстройство ограниченного на основе ресурсов делегирования Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.\nДля настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии SeEnableDelegation, которой по умолчанию обладали только учетные записи с правами уровня администратора домена.","keywords":["Active Directory","Kerberos","Pentest","Теория","Делегирование"],"articleBody":"Ранее были рассмотрены механизмы неограниченного и ограниченного делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.\nУстройство ограниченного на основе ресурсов делегирования Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.\nДля настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии SeEnableDelegation, которой по умолчанию обладали только учетные записи с правами уровня администратора домена. При делегировании, ограниченном на основе ресурсов, сервис напротив самостоятельно определяет, кто может обращаться к нему от имени других пользователей.\n Примечание: далее вместо “ограниченное на основе ресурсов делегирование” может использоваться общепринятая аббревиатура RBCD (от англ. Resource Based Constrained Delegation)\n \r\r\rОбщая идея делегирования, ограниченного на основе ресурсов\r\r\rПояснение простыми словами - раньше назначался ответственный, который сам решал к кому и от имени кого он может обращаться. Теперь каждый сам решает, кто может обращаться к нему от имени других.\n\r\r\rИллюстрация различий между ограниченным делегированием и RBCD\r\r\rДля настройки RBCD требуется право на запись в атрибут msDS-AllowedToActOnBehalfOfOtherIdentity учетной записи. В указанном атрибуте записываются и хранятся в двоичном виде идентификаторы безопасности (SID) учетных записей, сервисам которых разрешено олицетворять других пользователей при обращении к сервисам учетной записи с настроенным RBCD.\nРассмотрим пример. Удобный графический интерфейс для настройки RBCD отсутствует, поэтому приходится использовать Powershell:\n\r\r\rПример настройки у SQL01 RBCD для WEB01\r\r\r\r\r\rЗначение атрибута msDS-AllowedToActOnBehalfOfOtherIdentity в читаемом виде\r\r\rДля работы механизма ограниченного на основе ресурсов делегирования также используются расширения S4U2Self и S4U2Proxy.\nРассмотрим работу указанных расширений при RBCD на следующем примере: пусть у учетной записи “Владелец Б” настроено RBCD, позволяющее любому сервису учетной записи “Владелец А” олицетворять незащищенных пользователей при обращении к любому своему сервису.\n\r\r\rИллюстрация обмена сообщений при RBCD\r\r\rРассмотрим процесс RBCD по пунктам:\nКаким образом User прошел аутентификацию к Сервису А неважно, допустим, что с использованием отличного от Kerberos протокола NTLM. Сервис А обращается к контроллеру домену для получения TGS-билета “на себя” от имени пользователя User. Контроллер домена проверяет, что у учетной записи “Владелец А” активен флаг TRUSTED_TO_AUTH_FOR_DELEGATION. Указанный флаг не активен, поэтому в ответ отправляется обычный nonforwardable TGS-билет без права передачи для User к Сервису А. Таким образом S4U2Self работает также, как и в случае классического ограниченного делегирования. С использованием полученного TGS-билета Сервис А обращается к контроллеру домена для получения Forwardable TGS-билета к Сервису Б от имени User. Контроллер домена проверяет, что в атрибуте msDS-AllowedToActOnBehalfOfOtherIdentity учетной записи “Владелец Б” установлен SID учетной записи “Владелец А”. Также контроллер домена проверяет, что “Владелец А” обладает хотя бы одним SPN. В результате контроллер домена отправляет в ответ Forwardable TGS-билет.   Указанное поведение является важной отличительной особенностью. При RBCD S4U2Proxy возвращает Forwardable TGS-билет при предоставлении Nonforwardable билета, в то время как при ограниченном делегировании S4U2Proxy возвращает Forwardable TGS-билет только при предоставлении Forwardable билета.\n Сервис А обращается от имени User к Сервису Б с использованием полученного Forwardable TGS-билета.   Еще раз отметим:\n S4U2Self при RBCD возвращает Nonforwardable TGS-билет. S4U2Proxy всегда в случае успеха возвращает Forwardable TGS-билет.   \r\r\rПример сетевого трафика при делегировании ограниченном на основе ресурсов\r\r\rКлассическая атака на RBCD Условия для проведения атаки:\n Возможность изменять содержимое атрибута msDS-AllowedToActOnBehalfOfOtherIdentity атакуемой учетной записи. Контроль над учетной записью, обладающей SPN.  Результат успешной атаки: доступ с административными правами к серверу, предназначенному для функционирования сервиса, работающего от имени учетной записи с настроенным RBCD.\nНа первом шаге атакующий записывает SID подконтрольной учетной записи, обладающей SPN, в атрибут msDS-AllowedToActOnBehalfOfOtherIdentity атакуемой учетной записи. Таким образом для подконтрольной учетной записи предоставляется право на олицетворение практически любого пользователя при обращении к сервису атакуемой учетной записи.\nrbcd.py 'DomainFQDN'/'Username':'Password' -delegate-from 'ControlledAccountWithSPN' -delegate-to 'Target$' -dc-ip 'DC_IP' -action write На втором шаге атакующий выполняет S4U2Self запрос TGS-билета от имени административного пользователя к сервису работающему из-под контролируемой учетной записи. В результате запроса атакующий получает Nonforwardable TGS-билет.\ngetST.py -spn \"cifs/target\" -impersonate $AdminAccountName -dc-ip $DomainController $DomainFQDN/$ControlledAccountWithSPN:$Password На третьем шаге атакующий c использованием полученного Nonforwardable TGS-билета выполняет S4U2Proxy запрос. В результате успешного запроса атакующий получает Forwardable TGS-билет к сервису атакуемой учетной записи от имени административного пользователя. На этом атака считается завершенной.\nНа первый взгляд атака может показаться не очень применимой на практике. Действительно, условие наличия возможности изменения атрибута msDS-AllowedToActOnBehalfOfOtherIdentity у атакуемой учетной записи, выглядит довольно требовательным, не смотря на то, что наличие специальной привилегии уровня администратора домена для изменения указанного атрибута не требуется. Кроме того не очень понятно, как получить учетную запись, обладающую SPN.\nТем не менее существует ряд особенностей, расширяющих перечень условий для успешной реализации рассмотренной атаки. Рассмотрим некоторые из них.\nКак получить учетную запись с SPN На уровне домена существует атрибут ms-DS-MachineAccountQuota (MAQ), который отвечает за количество машинных учетных записей, которое непривилегированный пользователь указанного домена может добавить.\n В разделе “общая теория” описывалась разница между пользовательскими и машинными учетными записями.\n По умолчанию значение атрибута ms-DS-MachineAccountQuota равно 10.\n\r\r\rПример содержимого MAQ\r\r\rПроверить текущее значение MAQ можно например с помощью специального модуля к CrackMapExec:\ncrackmapexec ldap $DC -u $Username -p $Password -d $DomainFQDN -M MAQ Как правило, машинная учетная запись сразу после создания уже имеет несколько SPN. Кроме того создатель машинной учетной записи обладает рядом прав в отношение указанной учетной записи, в том числе позволяющих добавить новые SPN.\nТаким образом, захватив пользовательскую непривилегированную учетную запись, атакующий может добавить машинную учетную запись для дальнейшего использования при проведении атак на RBCD.\naddcomputer.py -computer-name 'evilcomputer$' -computer-pass $GeneratedPass -dc-ip $DC_IP $Domain_FQDN/$Username:$Password В скрипте addcomputer.py присутствует параметр -method, который отвечает за выбор протокола с использованием которого будет осуществляться добавление машинной учетной записи. Есть две опции: SAMR или LDAPS. По умолчанию используется SAMR, так как LDAPS не всегда может быть доступен. Важно отметить, что в отличие от LDAPS, при добавлении машинной учетной записи с помощью SAMR SPN не создаются. В таком случае необходимо дополнительно задействовать скрипт addspn.py.\naddspn.py -u '$DomainFQDD'\\'evilcomputer$' -p $LM:$NT -s anyRecordName.$DomainFQDN $DC_FQDN Атака без контроля над учетной записью с SPN Не так давно был открыт способ проводить RBCD-атаки и при отсутствии возможности добавлять машинные учетные записи в домен, в том числе когда атрибут ms-DS-MachineAccountQuota равен 0. В этом случае наличие учетной записи с SPN несущественно и для атаки достаточно обладать обычной непривилегированной учетной записью пользователя. Хороший материал на эту тему под названием “Делегируй меня полностью, или Новый взгляд на RBCD-атаки в AD” написал snovvcrash. Не вижу смысла дублировать и настоятельно рекомендую ознакомиться с указанной статьей.\n Один момент, который хочется отметить: рассматриваемый способ подразумевает смену пароля подконтрольной пользовательской учетной записи. Таким образом атака приводит к неработоспособности указанной учетной записи со стороны атакуемой организации, то есть “отказу в обслуживании”, что следует принимать во внимание.\n Изменение msDS-AllowedToActOnBehalfOfOtherIdentity с помощью ACL Обладание одним из прав в отношении атакуемой учетной записи:\n GenericAll GenericWrite WriteDACL WriteOwner  позволяет атакующему изменять атрибут msDS-AllowedToActOnBehalfOfOtherIdentity. Подробнее почему это так можно посмотреть на русском языке в докладе “Другой взгляд атакующего на ACL в AD”.\n Примечание: наличие приведенных прав можно проверить или поискать с помощью Bloodhound.\n Изменение msDS-AllowedToActOnBehalfOfOtherIdentity через Relay-атаки Рассмотрим еще один немаловажный способ. Ранее было отмечено, что атакуемая учетная запись может самостоятельно изменить значение своего атрибута msDS-AllowedToActOnBehalfOfOtherIdentity и наличие административных привилегий для этого не требуется. Но как заставить учетную запись изменить значение своего атрибута msDS-AllowedToActOnBehalfOfOtherIdentity и вписать туда SID учетной записи контролируемой атакующим?\nОтвет: с помощью Relay-атаки.\nЕсли вкратце, то в результате указанной атаки осуществляется перехват NetNTLMv1/2 запроса на аутентификацию и перенаправление полученных аутентификационных данных с последующим выполнением команд от имени атакуемой учетной записи, в частности можно изменить значение атрибута msDS-AllowedToActOnBehalfOfOtherIdentity.\nДля начинающего разбираться во внутреннем тестировании на проникновение читателя приведенная выше формулировка скорее всего будет затруднительна для понимания. Изначально было желание рассмотреть RBCD в связке с Relay-атаками, но тогда возникают следующие проблемы:\n Тема Relay-атак довольно обширна и заслуживает отдельной, может и не одной, статьи. Описание принципа и условий проведения Relay-атак выходит за рамки настоящего материала. Если продолжить без объяснения Relay-атак, то разрывается логика повествования. От читателя начинает требоваться наличие знаний, которые до этого не обсуждались. Ранее в предыдущих статьях материал преподносился последовательно “с нуля” и на мой взгляд это очень важное свойство от которого не хочется отступать.  Таким образом было принято решение завершить статью об атаках на RBCD. Но это не означает, что автор не вернется к этой теме в будущем, например после материала по Relay-атакам.\nДополнительные материалы для дальнейшего изучения  Атака “Bronze Bit” Статья: “Точно ограничили? Обход отсутствия Protocol Transition и группы Protected Users при ограниченном делегировании Kerberos”  Рекомендации  Провести инвентаризацию домена на предмет наличия учетных записей с неиспользуемым настроенным RBCD. Использовать RBCD только при необходимости. Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию “Account is sensitive and cannot be delegated” в атрибутах указанных учетных записей. По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям. Установить атрибут ms-DS-MachineAccountQuota равным 0.  Противодействовать Relay-атакам:\n Подписывать SMB и LDAP сообщения на всех объектах, входящих в состав домена. Настроить и использовать LDAP channel binding. Отключить службу печати «Print Spooler» на всех объектах домена, где использование указанной службы не требуется. Скорректировать настройки межсетевых экранов с целью ограничения возможности осуществления принудительной аутентификации. Хорошая статья на эту тему. Исключить использование протокола NetNTLM v1. По возможности отказаться от использования NetNTLM v2 (труднодостижимо на практике). Использовать актуальные версии ОС с установленными критическими обновлениями, что в частности, помогает защититься от атак “Drop the Mic” или “PrivExchange”. Исключить вхождение группы “Authenticated Users” в предустановленную стандартную группу “Pre-Windows 2000 Compatible Access”. При помощи групповых политик отключить использование на объектах, функционирующих в составе домена, небезопасных широковещательных протоколов NetBIOS, LLMNR, а также службы автоматической настройки прокси (WPAD) и протокола IPv6.   Примечание: к исполнению рекомендаций следует подходить индивидуально. Дело в том, что зачастую нельзя дать универсальную рекомендацию, подходящую для всех сетей и доменов. Прежде чем что-то предпринимать следует убедиться в целесообразности вносимых изменений. Например, протокол IPv6 или служба WPAD могут быть необходимы при работе и тогда вместо отключения следует выполнить корректировку настроек.\n Используемые источники  Статья, заложившая основы для RBCD атак “Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory”. Отличный доклад про делегацию в Kerberos: “You Do (Not) Understand Kerberos Delegation” от Daniel López Jiménez (видео и презентация) Доклад “Delegating Kerberos to bypass Kerberos delegation limitation” от Charlie Bromberg (видео и презентация) Материалы с Hacker Recipes от Charlie Bromberg (Shutdown) Статья: “Kerberos (III): How does delegation work?” от Eloy Pérez Посты из телеграмм канала “СyberSecrets” Delegate or Escalate? The Dangers of Kerberos Delegation (Jared Yeo) - презентация Delegate to the Top: Abusing Kerberos for arbitrary impersonations and RCE (Matan Hart) - доклад презентация  ","wordCount":"1675","inLanguage":"ru","image":"https://ardent101.github.io/posts/kerberos_rbcd/images/logo.png","datePublished":"2022-10-20T09:31:03Z","dateModified":"2022-10-20T09:31:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.io/posts/kerberos_rbcd/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.io/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.io/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов</h1><div class=post-meta><span title="2022-10-20 09:31:03 +0000 +0000">октября 20, 2022</span>&nbsp;·&nbsp;8 мин&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.io/posts/kerberos_rbcd/images/logo_hu4b298d6a77d70b3ab29a729d3c237aac_2912755_360x0_resize_box_3.png 360w ,https://ardent101.github.io/posts/kerberos_rbcd/images/logo_hu4b298d6a77d70b3ab29a729d3c237aac_2912755_480x0_resize_box_3.png 480w ,https://ardent101.github.io/posts/kerberos_rbcd/images/logo_hu4b298d6a77d70b3ab29a729d3c237aac_2912755_720x0_resize_box_3.png 720w ,https://ardent101.github.io/posts/kerberos_rbcd/images/logo_hu4b298d6a77d70b3ab29a729d3c237aac_2912755_1080x0_resize_box_3.png 1080w ,https://ardent101.github.io/posts/kerberos_rbcd/images/logo_hu4b298d6a77d70b3ab29a729d3c237aac_2912755_1500x0_resize_box_3.png 1500w ,https://ardent101.github.io/posts/kerberos_rbcd/images/logo.png 2004w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.io/posts/kerberos_rbcd/images/logo.png alt width=2004 height=1087></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Оглавление</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#устройство-ограниченного-на-основе-ресурсов-делегирования>Устройство ограниченного на основе ресурсов делегирования</a></li><li><a href=#классическая-атака-на-rbcd>Классическая атака на RBCD</a><ul><li><a href=#как-получить-учетную-запись-с-spn>Как получить учетную запись с SPN</a></li><li><a href=#атака-без-контроля-над-учетной-записью-с-spn>Атака без контроля над учетной записью с SPN</a></li><li><a href=#изменение-msds-allowedtoactonbehalfofotheridentity-с-помощью-acl>Изменение <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> с помощью ACL</a></li><li><a href=#изменение-msds-allowedtoactonbehalfofotheridentity-через-relay-атаки>Изменение <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> через Relay-атаки</a></li></ul></li><li><a href=#дополнительные-материалы-для-дальнейшего-изучения>Дополнительные материалы для дальнейшего изучения</a></li><li><a href=#рекомендации>Рекомендации</a></li><li><a href=#используемые-источники>Используемые источники</a></li></ul></nav></div></details></div><div class=post-content><p>Ранее были рассмотрены механизмы <a href=/posts/kerberos_delegation/>неограниченного</a> и <a href=/posts/kerberos_constrained/>ограниченного</a> делегирования в Active Directory с помощью протокола Kerberos. Теперь перейдем к наиболее интересному с точки зрения проведения атак виду делегирования, а именно ограниченному на основе ресурсов.</p><h2 id=устройство-ограниченного-на-основе-ресурсов-делегирования>Устройство ограниченного на основе ресурсов делегирования<a hidden class=anchor aria-hidden=true href=#устройство-ограниченного-на-основе-ресурсов-делегирования>#</a></h2><p>Делегирование, ограниченное на основе ресурсов, появилось в Windows Server 2012.</p><p>Для настройки неограниченного и ограниченного видов делегирования требовалось наличие привилегии <em>SeEnableDelegation</em>, которой по умолчанию обладали только учетные записи с правами уровня администратора домена. При делегировании, ограниченном на основе ресурсов, сервис напротив самостоятельно определяет, кто может обращаться к нему от имени других пользователей.</p><blockquote><p>Примечание: далее вместо &ldquo;<em>ограниченное на основе ресурсов делегирование</em>&rdquo; может использоваться общепринятая аббревиатура RBCD (от англ. Resource Based Constrained Delegation)</p></blockquote><p><figure><img src=images/rbcd_concept.svg alt=rbcd_concept><figcaption><p style=text-align:center>Общая идея делегирования, ограниченного на основе ресурсов</p></figcaption></figure></p><p>Пояснение простыми словами - раньше назначался ответственный, который сам решал к кому и от имени кого он может обращаться. Теперь каждый сам решает, кто может обращаться к нему от имени других.</p><p><figure><img src=images/rbcd_vs_kcd.svg alt=rbcd_vs_kcd><figcaption><p style=text-align:center>Иллюстрация различий между ограниченным делегированием и RBCD</p></figcaption></figure></p><p>Для настройки RBCD требуется право на запись в атрибут <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> учетной записи. В указанном атрибуте записываются и хранятся в двоичном виде идентификаторы безопасности (SID) учетных записей, сервисам которых разрешено олицетворять других пользователей при обращении к сервисам учетной записи с настроенным RBCD.</p><p>Рассмотрим пример. Удобный графический интерфейс для настройки RBCD отсутствует, поэтому приходится использовать Powershell:</p><p><figure><img src=images/rbcd_gui.png alt=rbcd_gui><figcaption><p style=text-align:center>Пример настройки у SQL01 RBCD для WEB01</p></figcaption></figure></p><p><figure><img src=images/rbcd_gui_powershell.png alt=rbcd_gui_powershell><figcaption><p style=text-align:center>Значение атрибута msDS-AllowedToActOnBehalfOfOtherIdentity в читаемом виде</p></figcaption></figure></p><p>Для работы механизма ограниченного на основе ресурсов делегирования также используются расширения <em>S4U2Self</em> и <em>S4U2Proxy</em>.</p><p>Рассмотрим работу указанных расширений при RBCD на следующем примере: пусть у учетной записи &ldquo;Владелец Б&rdquo; настроено RBCD, позволяющее <strong>любому</strong> сервису учетной записи &ldquo;Владелец А&rdquo; олицетворять незащищенных пользователей при обращении к <strong>любому</strong> своему сервису.</p><p><figure><img src=images/rbcd_general_edited.svg alt=rbcd_general><figcaption><p style=text-align:center>Иллюстрация обмена сообщений при RBCD</p></figcaption></figure></p><p>Рассмотрим процесс RBCD по пунктам:</p><ol start=0><li>Каким образом User прошел аутентификацию к Сервису А неважно, допустим, что с использованием отличного от Kerberos протокола NTLM.</li><li>Сервис А обращается к контроллеру домену для получения TGS-билета &ldquo;на себя&rdquo; от имени пользователя User.</li><li>Контроллер домена проверяет, что у учетной записи &ldquo;Владелец А&rdquo; активен флаг <em>TRUSTED_TO_AUTH_FOR_DELEGATION</em>. Указанный флаг <strong>не активен</strong>, поэтому в ответ отправляется обычный <em>nonforwardable</em> TGS-билет без права передачи для User к Сервису А. Таким образом S4U2Self работает также, как и в случае классического ограниченного делегирования.</li><li>С использованием полученного TGS-билета Сервис А обращается к контроллеру домена для получения <em>Forwardable</em> TGS-билета к Сервису Б от имени User. Контроллер домена проверяет, что в атрибуте <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> учетной записи &ldquo;Владелец Б&rdquo; установлен SID учетной записи &ldquo;Владелец А&rdquo;. Также контроллер домена проверяет, что &ldquo;Владелец А&rdquo; обладает хотя бы одним SPN. В результате контроллер домена отправляет в ответ <em>Forwardable</em> TGS-билет.</li></ol><blockquote><p>Указанное поведение является важной отличительной особенностью. При RBCD <em>S4U2Proxy</em> возвращает <em>Forwardable</em> TGS-билет при предоставлении <em>Nonforwardable</em> билета, в то время как при ограниченном делегировании <em>S4U2Proxy</em> возвращает <em>Forwardable</em> TGS-билет только при предоставлении <em>Forwardable</em> билета.</p></blockquote><ol start=4><li>Сервис А обращается от имени User к Сервису Б с использованием полученного <em>Forwardable</em> TGS-билета.</li></ol><blockquote><p>Еще раз отметим:</p><ul><li><em>S4U2Self</em> при RBCD возвращает <em>Nonforwardable</em> TGS-билет.</li><li><em>S4U2Proxy</em> всегда в случае успеха возвращает <em>Forwardable</em> TGS-билет.</li></ul></blockquote><p><figure><img src=images/rbcd_traffic.png alt=rbcd_traffic><figcaption><p style=text-align:center>Пример сетевого трафика при делегировании ограниченном на основе ресурсов</p></figcaption></figure></p><h2 id=классическая-атака-на-rbcd>Классическая атака на RBCD<a hidden class=anchor aria-hidden=true href=#классическая-атака-на-rbcd>#</a></h2><p><strong>Условия для проведения атаки</strong>:</p><ul><li>Возможность изменять содержимое атрибута <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> атакуемой учетной записи.</li><li>Контроль над учетной записью, обладающей SPN.</li></ul><p><strong>Результат успешной атаки</strong>: доступ с административными правами к серверу, предназначенному для функционирования сервиса, работающего от имени учетной записи с настроенным RBCD.</p><p>На первом шаге атакующий записывает SID подконтрольной учетной записи, обладающей SPN, в атрибут <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> атакуемой учетной записи. Таким образом для подконтрольной учетной записи предоставляется право на олицетворение практически любого пользователя при обращении к сервису атакуемой учетной записи.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>rbcd.py <span class=s1>&#39;DomainFQDN&#39;</span>/<span class=s1>&#39;Username&#39;</span>:<span class=s1>&#39;Password&#39;</span> -delegate-from <span class=s1>&#39;ControlledAccountWithSPN&#39;</span> -delegate-to <span class=s1>&#39;Target$&#39;</span> -dc-ip <span class=s1>&#39;DC_IP&#39;</span> -action write 
</span></span></code></pre></div><p>На втором шаге атакующий выполняет S4U2Self запрос TGS-билета от имени административного пользователя к сервису работающему из-под контролируемой учетной записи. В результате запроса атакующий получает Nonforwardable TGS-билет.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getST.py -spn <span class=s2>&#34;cifs/target&#34;</span> -impersonate <span class=nv>$AdminAccountName</span> -dc-ip <span class=nv>$DomainController</span> <span class=nv>$DomainFQDN</span>/<span class=nv>$ControlledAccountWithSPN</span>:<span class=nv>$Password</span>
</span></span></code></pre></div><p>На третьем шаге атакующий c использованием полученного Nonforwardable TGS-билета выполняет S4U2Proxy запрос. В результате успешного запроса атакующий получает Forwardable TGS-билет к сервису атакуемой учетной записи от имени административного пользователя. На этом атака считается завершенной.</p><p>На первый взгляд атака может показаться не очень применимой на практике. Действительно, условие наличия возможности изменения атрибута <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> у атакуемой учетной записи, выглядит довольно требовательным, не смотря на то, что наличие специальной привилегии уровня администратора домена для изменения указанного атрибута не требуется. Кроме того не очень понятно, как получить учетную запись, обладающую SPN.</p><p>Тем не менее существует ряд особенностей, расширяющих перечень условий для успешной реализации рассмотренной атаки. Рассмотрим некоторые из них.</p><h3 id=как-получить-учетную-запись-с-spn>Как получить учетную запись с SPN<a hidden class=anchor aria-hidden=true href=#как-получить-учетную-запись-с-spn>#</a></h3><p>На уровне домена существует атрибут <em>ms-DS-MachineAccountQuota</em> (<em>MAQ</em>), который отвечает за количество машинных учетных записей, которое непривилегированный пользователь указанного домена может добавить.</p><blockquote><p>В разделе <a href=/posts/kerberos_delegation/#%D0%BE%D0%B1%D1%89%D0%B0%D1%8F-%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F>&ldquo;общая теория&rdquo;</a> описывалась разница между пользовательскими и машинными учетными записями.</p></blockquote><p>По умолчанию значение атрибута <em>ms-DS-MachineAccountQuota</em> равно 10.</p><p><figure><img src=images/MAQ.png alt=MAQ><figcaption><p style=text-align:center>Пример содержимого MAQ</p></figcaption></figure></p><p>Проверить текущее значение <em>MAQ</em> можно например с помощью специального модуля к CrackMapExec:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>crackmapexec ldap <span class=nv>$DC</span> -u <span class=nv>$Username</span> -p <span class=nv>$Password</span> -d <span class=nv>$DomainFQDN</span> -M MAQ
</span></span></code></pre></div><p>Как правило, машинная учетная запись сразу после создания уже имеет несколько SPN. Кроме того создатель машинной учетной записи обладает рядом прав в отношение указанной учетной записи, в том числе позволяющих добавить новые SPN.</p><p>Таким образом, захватив пользовательскую непривилегированную учетную запись, атакующий может добавить машинную учетную запись для дальнейшего использования при проведении атак на RBCD.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>addcomputer.py -computer-name <span class=s1>&#39;evilcomputer$&#39;</span> -computer-pass <span class=nv>$GeneratedPass</span> -dc-ip <span class=nv>$DC_IP</span> <span class=nv>$Domain_FQDN</span>/<span class=nv>$Username</span>:<span class=nv>$Password</span>
</span></span></code></pre></div><p>В скрипте addcomputer.py присутствует параметр -method, который отвечает за выбор протокола с использованием которого будет осуществляться добавление машинной учетной записи. Есть две опции: SAMR или LDAPS. По умолчанию используется SAMR, так как LDAPS не всегда может быть доступен. Важно отметить, что в отличие от LDAPS, при добавлении машинной учетной записи с помощью SAMR SPN не создаются. В таком случае необходимо дополнительно задействовать скрипт addspn.py.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>addspn.py -u <span class=s1>&#39;$DomainFQDD&#39;</span><span class=se>\&#39;</span>evilcomputer$<span class=err>&#39;</span> -p <span class=nv>$LM</span>:<span class=nv>$NT</span> -s anyRecordName.<span class=nv>$DomainFQDN</span> <span class=nv>$DC_FQDN</span>
</span></span></code></pre></div><h3 id=атака-без-контроля-над-учетной-записью-с-spn>Атака без контроля над учетной записью с SPN<a hidden class=anchor aria-hidden=true href=#атака-без-контроля-над-учетной-записью-с-spn>#</a></h3><p>Не так давно был <a href=https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html>открыт</a> способ проводить RBCD-атаки и при отсутствии возможности добавлять машинные учетные записи в домен, в том числе когда атрибут <em>ms-DS-MachineAccountQuota</em> равен 0. В этом случае наличие учетной записи с SPN несущественно и для атаки достаточно обладать обычной непривилегированной учетной записью пользователя. Хороший <a href=https://habr.com/ru/company/angarasecurity/blog/680138/>материал</a> на эту тему под названием &ldquo;Делегируй меня полностью, или Новый взгляд на RBCD-атаки в AD&rdquo; написал snovvcrash. Не вижу смысла дублировать и настоятельно рекомендую ознакомиться с указанной статьей.</p><blockquote><p>Один момент, который хочется отметить: рассматриваемый способ подразумевает смену пароля подконтрольной пользовательской учетной записи. Таким образом атака приводит к неработоспособности указанной учетной записи со стороны атакуемой организации, то есть &ldquo;отказу в обслуживании&rdquo;, что следует принимать во внимание.</p></blockquote><h3 id=изменение-msds-allowedtoactonbehalfofotheridentity-с-помощью-acl>Изменение <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> с помощью ACL<a hidden class=anchor aria-hidden=true href=#изменение-msds-allowedtoactonbehalfofotheridentity-с-помощью-acl>#</a></h3><p>Обладание одним из прав в отношении атакуемой учетной записи:</p><ul><li>GenericAll</li><li>GenericWrite</li><li>WriteDACL</li><li>WriteOwner</li></ul><p>позволяет атакующему изменять атрибут <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em>. Подробнее почему это так можно посмотреть на русском языке в докладе <a href="https://www.youtube.com/watch?v=1Abt_Jpx2nM">&ldquo;Другой взгляд атакующего на ACL в AD&rdquo;</a>.</p><blockquote><p>Примечание: наличие приведенных прав можно проверить или поискать с помощью Bloodhound.</p></blockquote><h3 id=изменение-msds-allowedtoactonbehalfofotheridentity-через-relay-атаки>Изменение <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> через Relay-атаки<a hidden class=anchor aria-hidden=true href=#изменение-msds-allowedtoactonbehalfofotheridentity-через-relay-атаки>#</a></h3><p>Рассмотрим еще один немаловажный способ. Ранее было отмечено, что атакуемая учетная запись может самостоятельно изменить значение своего атрибута <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> и наличие административных привилегий для этого не требуется. Но как заставить учетную запись изменить значение своего атрибута <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em> и вписать туда SID учетной записи контролируемой атакующим?</p><p>Ответ: с помощью Relay-атаки.</p><p>Если вкратце, то в результате указанной атаки осуществляется перехват NetNTLMv1/2 запроса на аутентификацию и перенаправление полученных аутентификационных данных с последующим выполнением команд от имени атакуемой учетной записи, в частности можно изменить значение атрибута <em>msDS-AllowedToActOnBehalfOfOtherIdentity</em>.</p><p>Для начинающего разбираться во внутреннем тестировании на проникновение читателя приведенная выше формулировка скорее всего будет затруднительна для понимания. Изначально было желание рассмотреть RBCD в связке с Relay-атаками, но тогда возникают следующие проблемы:</p><ul><li>Тема Relay-атак довольно обширна и заслуживает отдельной, может и не одной, статьи. Описание принципа и условий проведения Relay-атак выходит за рамки настоящего материала.</li><li>Если продолжить без объяснения Relay-атак, то разрывается логика повествования. От читателя начинает требоваться наличие знаний, которые до этого не обсуждались. Ранее в предыдущих статьях материал преподносился последовательно &ldquo;с нуля&rdquo; и на мой взгляд это очень важное свойство от которого не хочется отступать.</li></ul><p>Таким образом было принято решение завершить статью об атаках на RBCD. Но это не означает, что автор не вернется к этой теме в будущем, например после материала по Relay-атакам.</p><h2 id=дополнительные-материалы-для-дальнейшего-изучения>Дополнительные материалы для дальнейшего изучения<a hidden class=anchor aria-hidden=true href=#дополнительные-материалы-для-дальнейшего-изучения>#</a></h2><ul><li><a href=https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-overview/>Атака &ldquo;Bronze Bit&rdquo;</a></li><li><a href=https://habr.com/ru/company/tomhunter/blog/683924/>Статья</a>: &ldquo;Точно ограничили? Обход отсутствия Protocol Transition и группы Protected Users при ограниченном делегировании Kerberos&rdquo;</li></ul><h2 id=рекомендации>Рекомендации<a hidden class=anchor aria-hidden=true href=#рекомендации>#</a></h2><ul><li>Провести инвентаризацию домена на предмет наличия учетных записей с неиспользуемым настроенным RBCD. Использовать RBCD только при необходимости.</li><li>Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию &ldquo;Account is sensitive and cannot be delegated&rdquo; в атрибутах указанных учетных записей.</li><li>По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям.</li><li>Установить атрибут ms-DS-MachineAccountQuota равным 0.</li></ul><p>Противодействовать Relay-атакам:</p><ul><li>Подписывать SMB и LDAP сообщения на всех объектах, входящих в состав домена.</li><li>Настроить и использовать LDAP channel binding.</li><li>Отключить службу печати «Print Spooler» на всех объектах домена, где использование указанной службы не требуется.</li><li>Скорректировать настройки межсетевых экранов с целью ограничения возможности осуществления принудительной аутентификации. Хорошая <a href=https://habr.com/ru/post/688682/>статья</a> на эту тему.</li><li>Исключить использование протокола NetNTLM v1. По возможности отказаться от использования NetNTLM v2 (труднодостижимо на практике).</li><li>Использовать актуальные версии ОС с установленными критическими обновлениями, что в частности, помогает защититься от атак &ldquo;Drop the Mic&rdquo; или &ldquo;PrivExchange&rdquo;.</li><li>Исключить вхождение группы &ldquo;Authenticated Users&rdquo; в предустановленную стандартную группу &ldquo;Pre-Windows 2000 Compatible Access&rdquo;.</li><li>При помощи групповых политик отключить использование на объектах, функционирующих в составе домена, небезопасных широковещательных протоколов NetBIOS, LLMNR, а также службы автоматической настройки прокси (WPAD) и протокола IPv6.</li></ul><blockquote><p>Примечание: к исполнению рекомендаций следует подходить индивидуально. Дело в том, что зачастую нельзя дать универсальную рекомендацию, подходящую для всех сетей и доменов. Прежде чем что-то предпринимать следует убедиться в целесообразности вносимых изменений. Например, протокол IPv6 или служба WPAD могут быть необходимы при работе и тогда вместо отключения следует выполнить корректировку настроек.</p></blockquote><h2 id=используемые-источники>Используемые источники<a hidden class=anchor aria-hidden=true href=#используемые-источники>#</a></h2><ul><li><a href=https://eladshamir.com/2019/01/28/Wagging-the-Dog.html>Статья</a>, заложившая основы для RBCD атак &ldquo;Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory&rdquo;.</li><li>Отличный доклад про делегацию в Kerberos: &ldquo;You Do (Not) Understand Kerberos Delegation&rdquo; от Daniel López Jiménez (<a href="https://www.youtube.com/watch?v=p9QFdITuvgU&list=PLwb6et4T42wwlxffjq9-F3KVDNDi9gQFs&index=1">видео</a> и <a href=https://attl4s.github.io/assets/pdf/You_do_(not)_Understand_Kerberos_Delegation.pdf>презентация</a>)</li><li>Доклад &ldquo;Delegating Kerberos to bypass Kerberos delegation limitation&rdquo; от Charlie Bromberg (<a href="https://www.youtube.com/watch?v=byykEId3FUs">видео</a> и <a href="https://firebasestorage.googleapis.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-MHRw3PMJtbDDjbxm5ub%2Fuploads%2F1My6Zro1wos12oiKFvrT%2FInsomnihack%202022%20-%20Delegating%20Kerberos%20To%20Bypass%20Kerberos%20Delegation%20Limitations.pdf?alt=media&token=371ab075-79df-4725-8025-cf4be0609af9">презентация</a>)</li><li><a href=https://www.thehacker.recipes/ad/movement/kerberos/delegations/rbcd>Материалы</a> с Hacker Recipes от Charlie Bromberg (Shutdown)</li><li><a href=https://www.tarlogic.com/blog/kerberos-iii-how-does-delegation-work/>Статья</a>: &ldquo;Kerberos (III): How does delegation work?&rdquo; от Eloy Pérez</li><li>Посты из <a href=https://t.me/cyb3r53cr3t5>телеграмм канала</a> &ldquo;СyberSecrets&rdquo;</li><li>Delegate or Escalate? The Dangers of Kerberos Delegation (Jared Yeo) - <a href=https://www.aisp.sg/document/CRESTConSpeaker/Delegate_or_Escalate.pdf>презентация</a></li><li>Delegate to the Top: Abusing Kerberos for arbitrary impersonations and RCE (Matan Hart) - <a href=https://www.blackhat.com/docs/asia-17/materials/asia-17-Hart-Delegate-To-The-Top-Abusing-Kerberos-For-Arbitrary-Impersonations-And-RCE-wp.pdf>доклад</a> <a href=https://www.blackhat.com/docs/asia-17/materials/asia-17-Hart-Delegate-To-The-Top-Abusing-Kerberos-For-Arbitrary-Impersonations-And-RCE.pdf>презентация</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.io/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.io/tags/kerberos/>Kerberos</a></li><li><a href=https://ardent101.github.io/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.io/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F/>Теория</a></li><li><a href=https://ardent101.github.io/tags/%D0%B4%D0%B5%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/>Делегирование</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on twitter" href="https://twitter.com/intent/tweet/?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f&hashtags=ActiveDirectory%2cKerberos%2cPentest%2c%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f%2c%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2&summary=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2&source=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on whatsapp" href="https://api.whatsapp.com/send?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2%20-%20https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 5. Делегирование, ограниченное на основе ресурсов on telegram" href="https://telegram.me/share/url?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%205.%20%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%2c%20%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%bd%d0%b0%20%d0%be%d1%81%d0%bd%d0%be%d0%b2%d0%b5%20%d1%80%d0%b5%d1%81%d1%83%d1%80%d1%81%d0%be%d0%b2&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_rbcd%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ardent101.github.io/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="копировать";function s(){e.innerText="скопировано!",setTimeout(()=>{e.innerText="копировать"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>