<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Еще 1 раз про пентест 1С | Ardent101</title><meta name=keywords content="Active Directory,Pentest,1C"><meta name=description content="Введение Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.
Продолжу рассуждение в терминах, обозначенных ранее.
По имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена."><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.io/posts/1c/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.io/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.io/static/favicon-32x32.png><link rel=apple-touch-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Еще 1 раз про пентест 1С"><meta property="og:description" content="Введение Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.
Продолжу рассуждение в терминах, обозначенных ранее.
По имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена."><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.io/posts/1c/"><meta property="og:image" content="https://ardent101.github.io/posts/1c/images/logo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-22T08:31:03+00:00"><meta property="article:modified_time" content="2024-02-22T08:31:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.io/posts/1c/images/logo.jpg"><meta name=twitter:title content="Еще 1 раз про пентест 1С"><meta name=twitter:description content="Введение Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.
Продолжу рассуждение в терминах, обозначенных ранее.
По имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Еще 1 раз про пентест 1С","item":"https://ardent101.github.io/posts/1c/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Еще 1 раз про пентест 1С","name":"Еще 1 раз про пентест 1С","description":"Введение Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.\nПродолжу рассуждение в терминах, обозначенных ранее.\nПо имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена.","keywords":["Active Directory","Pentest","1C"],"articleBody":"Введение Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.\nПродолжу рассуждение в терминах, обозначенных ранее.\nПо имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена.\nТем не менее, чтобы улучшить качество мероприятий по тестированию на проникновение есть смысл рассмотреть другие ключевые системы и подходы к построению сценариев применительно к ним. Хорошим примером ключевой системы, отличной от контроллеров домена, является 1С:Предприятие.\nПрименительно к указанной ключевой системе можно выделить следующие негативные для Организации последствия компьютерных атак:\n потеря (хищение) денежных средств нарушение конфиденциальности (утечка) персональных данных  Критериями подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям в рассматриваемом случае могут быть:\n получение административного доступа к серверу, обеспечивающему функционирование системы 1С:Предприятие; получение доступа к действующей административной учетной записи к системе 1С:Предприятие.  Далее будут рассмотрены ряд сценариев компьютерных атак в отношении 1С:Предприятие, а также приведены примеры подтверждения возможности реализации указанных атак на практике.\nКраткие сведения об 1C:Предприятие 1C:Предприятие предназначено для автоматизации, управления и учета в Организации различных видов деятельности и типов финансирования. 1С:Предприятие состоит из технологической платформы (ядра) и разработанных на ее основе прикладных решений (конфигураций), например:\n 1С:Бухгалтерия 8 1С:Документооборот 8 1С:Зарплата и управление персоналом 8 1C:ERP Управление предприятием 2.0  Все прикладные решения 1С имеют однотипный интерфейс и подчиняются общим принципам работы. Более того, решения могут работать совместно, а также производить обмен данными.\nТакже технологическая платформа содержит специальную среду для создания и доработки прикладных решений. Эта часть платформы называется конфигуратор. Конфигуратор используется программистами для настройки и обновления программ.\n\rСтоит отметить, что за 30 лет существования было выпущено множество версий платформы 1С. Более подробно ознакомиться c хронологией выхода и различиями между версиями платформы 1С можно в материалах “Какие бывают версии 1С” или “Обзор версий 1С:Предприятие”.\nВ настоящей момент наиболее актуальные версии платформы начинаются с идентификатора 8.3, поэтому всюду далее полагается, что используются именно они.\nС платформой 1С:Предприятие 8.3 одновременно могут работать тысячи пользователей. С целью обеспечения масштабируемости, баланса нагрузки и отказоустойчивости используется кластерная архитектура.\n\r\r\rИллюстрация архитектуры 1С\r\r\rВ первом приближении отметим, что с использованием различных клиентов можно подключиться к кластеру серверов, в свою очередь обеспечивающему взаимодействие с различными СУБД. Таким образом, именно кластер серверов 1С является ключевой системой при построении сценариев атак в отношение системы 1С:Предприятие.\nБольше об архитектуре платформы 1С рассказывается в статье “Про кластер серверов 1С”.\nСценарии компьютерных атак на 1С Поиск кластера 1C Найти кластеры серверов 1С:Предприятие возможно в результате поиска по следующим портам:\n 1540/tcp (rds) - порт рабочего сервера 1541/tcp (rds2) - порт кластера 1C 1545 80/tcp (http) - порт для подключения через веб-сервис (может быть закрыт, если веб-клиенты 1С не используются)  Общая команда для поиска кластеров серверов 1С:\nnmap -p1540,1541,1545 'subnet/mask' \rТакже следует не забывать обращать внимание на DNS-имена, содержащие в названии “1С”. Если же речь идет о домене, то можно поискать сведения о 1С в комментариях учетных записей (смотри Сypher запросы к BloodHoud ниже).\nMATCH (c:Computer) WHERE ANY (x IN c.description WHERE toUpper(x) CONTAINS '1С') RETURN c\rMATCH (c) WHERE toUpper(c.name) CONTAINS '1C' RETURN c.name Получение первоначального доступа Эксплуатация отсутствия пароля Один из главных и часто встречающихся недостатков заключаются в том, что по умолчанию пароль для доступа к консоли администрирования кластера серверов 1С отсутствует. Рассмотрим варианты эксплуатации указанного недостатка на практике.\nДопустим кластер серверов обнаружен. Проверить отсутствие пароля можно просто попробовав подключиться к выявленному кластеру. Для подключения необходима утилиту Администрирование серверов 1С: Предприятия с версией соответствующей версии кластера 1С.\nЕсли открыт порт 1545 (встречается редко), то определить версию клиента 1С можно с помощью утилиты rasoff, в противном случае всегда можно попробовать подключиться произвольным клиентом 1С и получить ошибку с информацией об используемой версии.\n\r\r\rПример выявления версии клиента по ошибке соединения\r\r\rДалее необходимо найти и установить клиент соответствующей версии. По-хорошему для этого необходимо обладать платным доступом к порталу 1С, но также можно посмотреть здесь.\nКроме того, целесообразно посмотреть файлы, распространяемые с помощью групповых политик, например в PingCastle. В этом случае можно найти общедоступные сетевые папки, откуда сразу взять необходимые клиенты, в том числе и для других кластеров 1С, если их в Организации несколько.\n\r\r\rПример обнаружения установщика клиента 1С из групповых политик\r\r\rДопустим установщик клиента с необходимой версией был получен. Дальше при установке надо дополнительно добавить модуль администрирования (см. ниже).\n\rПеред первым запуском консоли, её необходимо зарегистрировать с использованием скрипта «Регистрация утилиты администрирования». По завершению можно запускать указанную утилиту:\n\rДалее в интерфейсе утилиты следует указать кластер серверов 1С. Для этого потребуются IP-адрес и порт, выясненные ранее в ходе разведки:\n\r\rПри отсутствии пароля при подключении к указанному кластеру серверов 1С будет получена подобная картина:\n\rПри наличии требования пароля будет открыто следующее окно:\n\rДалее продолжим рассматривать случай, когда пароль отсутствует. Подключившись к кластеру серверов 1С с использованием утилиты администрирования можно:\n узнать названия информационных баз, а также в ряде случаев при попытке подключения к ним получить список идентификаторов учетных записей (полезно при подборе паролей) выявить тестовые информационные базы в которые можно зайти без пароля и залить “полезную” внешнюю обработку создать новую информационную базу с конфигурацией эмулирующей командную строку и таким образом получить возможность удаленного выполнения кода на кластере 1С с правами пользователя от которого запущена соответствующая служба  Наиболее предпочтительным вариантом постэксплуатации является создание новой информационной базы, так как тогда не происходит перезаписи ранее имеющихся данных. В этом случае общий порядок действий следующий:\n Подготовить базу данных PostgresSQL на подконтрольном сервере, в частности можно использовать свою виртуальную машину Создать на кластере 1С новую информационную базу с использованием установленной базы данных PostgresSQL Загрузить конфигурацию с “полезной” нагрузкой  Далее подробно рассмотрим каждый из указанных шагов.\n Примечание: если все же желания создавать новую базу нет и хочется воспользоваться имеющейся информационной базой, то важно помнить, что любая загрузка новой конфигурации подразумевает перезапись старых данных. По этой причине загрузку новой конфигурации в тестовую устаревшую ненужную информационную базу лучше предварительно согласовывать с администратором. Кроме того, следует сделать резервную копию базы, а также убедиться, что активные пользовательские сессии отсутствуют.\n Ранее в кратких сведениях была рассмотрена архитектура платформы 1С. Для создания информационной базы необходимо наличие подконтрольной СУБД. 1С может работать с различными базами данных, в частности с MSSQL. Тем не менее в виду свободной модели распространения удобнее использовать PostgresSQL.\nПо-хорошему можно взять любой дистрибутив PostgresSQL и просто его установить, но даже в этом незамысловатом процессе могут появиться небольшие проблемы.\nПосле установки версии PostgresSQL для Windows, взятой с официального сайта, возникли ошибки связанные с кодировкой. Возможно в Linux было бы по-другому, но в итоге было решено установить дистрибутив PostgresSQL специально предназначенный для работы с 1С.\n\rСогласно одному из руководств перед установкой был отключен протокол IPv6\n\rи включена служба “Вторичный вход в систему”\n\r\rПосле успешной установки можно приступать к непосредственному созданию информационной базы:\n\rВ параметрах следует указать данные созданной СУБД:\n\rТеперь в клиенте можно настроить подключение к созданной информационной базе:\n\r\rВ результате созданные настройки подключения будут сохранены и добавлены в общий список:\n\rДля дальнейшей эксплуатации остается загрузить специальную информационную базу, содержащую полезную нагрузку. В качестве примера можно использовать следующую конфигурацию за авторством компании “Крауд”.\n\rТаким образом будет получена возможность удаленного выполнения кода кластере 1С с правами пользователя от которого запущена соответствующая служба:\n\rДалее возможны различные варианты. В первую очередь следует определиться какими правами и привилегиями обладает учетная запись из-под которой выполняются команды. На практике подобные учетные записи в ряде случаев даже обладали правами уровня администратора домена. Проверить это возможно с помощью BloodHound.\nЧаще все же на подобную удачу рассчитывать не стоит. Более рабочий вариант - посмотреть наличие привилегии SeImpersonatePrivilege, которой достаточно для локального повышения (смотри PrintSpoofer). Далее, локально повысив права, можно поискать сессии административных учетных записей и попробовать их имперсоанизировать.\n\rТакже, иногда учетная запись из-под которой запущена служба 1С, может обладать привилегией на неограниченное делегирование.\n\rНа этот счет рекомендую ознакомиться с этим материалом.\nВ качестве альтернативного варианта постэксплуатации можно загрузить новую внешнюю обработку, например за авторством Levatein. К слову очень рекомендую к ознакомлению доклад на SOC форуме 2023 года “1С глазами пентестера”.\n\rПодобная обработка пригодится, если кластер запущен в операционной системе на базе Linux.\nОтдельный интерес при постэкплуатации кластера 1С представляет содержимое файла 1СV8Clst.lst, как правило расположенного по пути C:\\Program Files\\1cv8\\srvinfo\\reg_xxxx\\:\n\rВ этом файле хранятся идентификаторы и шифрованные пароли административных учетных записей СУБД, использующихся кластером 1С.\n\rВажная особенность заключается в том, что ключ шифрования и инициализационный вектор являются общеизвестными и постоянными. Тем самым получить пароли в открытом виде не составляет особого труда.\nДля расшифровки паролей можно воспользоваться следующей ссылкой:\nhttps://gchq.github.io/CyberChef/#recipe=From_Base64('A-Za-z0-9%2B/%3D',true,false)AES_Decrypt(%7B'option':'Hex','string':'7D5A39D625A10A476FAD6AB519C4E092'%7D,%7B'option':'Hex','string':'6D4A7FD2C4A791B48E4296A6B3CF765D'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)\u0026input=TlMvUnlSOW1rU0daUUw1SElhUUdod2VoaHNKUkZrZ0Y5SDlWbjVXRW04VT0 \rДобытые учетные записи можно использовать для дальнейшего продвижения и удаленного выполнения кода на серверах, обеспечивающих функционирование СУБД:\n\rРекомендация: создать администратора кластера 1С и ограничить доступ к консоли администрирования кластера 1С с использованием пароля.\nПодбор учетных записей Как было показано в кратких сведениях, Организация может использовать WEB-сервер для доступа к кластеру серверов 1С. Указанный WEB-сервер также может быть доступен со стороны сети Интернет. Это бывает удобно, в случаях когда требуется предоставить удаленный доступ ряду сотрудников или есть потребность в использовании мобильных клиентов. Иногда подобные WEB-сервера могут быть доступны только “изнутри”. В любом случае наличие WEB-сервера 1С позволяет осуществлять атаки методом перебора паролей к действующим учетным записям.\nОбнаружить WEB-сервера 1C можно с помощью утилиты gowitness.\nДля успешной аутентификации необходимо знать:\n название информационной базы идентификатор учетной записи пароль  Сперва, если наименование информационной базы неизвестно, то его необходимо подобрать, например с использованием словарей 1C-Finder от Kraud.\nДалее, если у пользователя включена настройка “показывать в списке выбора”, то при попытке подключения к выявленной базе будет отображаться его идентификатор. Таким образом, можно получить некоторый не обязательно полный перечень названий учетных записей:\n\rВыгрузить весь список доступных идентификаторов можно по следующему URL:\nhttp://://en_US/e1cib/users Учетные данные передаются на WEB-сервер 1С POST-запросом на URL следующего вида:\nhttp://://en_US/e1cib/login?version=8.3.XX.XXXX\u0026cred=base64(идентификатор)08base64(пароль) 08 - выступает в качестве разделителя между идентификатором и паролем\nТаким образом, с помощью обычных фаззеров методом POST по приведенному URL можно подбирать действующие учетные записи. Автоматизировать подбор можно с помощью Burp Suite, patator, ffuf и других инструментов.\nВ 1С пароли не чувствительны к регистру, то есть “Пароль” и “пАрОль” являются эквивалентами. Кроме того, нередко в 1С применяется недостаточно строгая парольная политика. Часто администраторы не включают проверку сложности паролей пользователей, а также не устанавливают длительность блокировки при превышении количества неуспешных попыток аутентификации или максимальное количество неуспешных попыток аутентификации.\n\r\r\rПример парольной политики с отключенной проверкой сложности\r\r\rВдобавок ко всему, зная некоторый типовой для Организации пароль, можно наоборот попробовать подбирать к нему идентификатор, например взяв за основу перечень почтовых адресов, полученных с помощью данного сайта.\nИногда при успешном подборе пароля выясняется, что он устарел и требуется ввести новый пароль:\n\rТакже следует не забывать, что пароль к некоторым учетным записям может и вовсе быть пустым.\nРекомендация: использовать строгую парольную политику.\nАнализ резервных копий Часто подтвердить возможность захвата кластера 1С можно в результате подтверждения захвата домена, в состав которого входит указанный кластер, но это тривиально, поэтому рассмотрим случай, когда кластер 1С не состоит в домене.\nДопустим каким-то способом был получен доступ к резервным копиям информационных баз. Например, представим что при наличие прав администратора домена подобные копии были обнаружены в открытом виде в системе резервного копирования, входящей в состав указанного домена.\n\rБазы 1С могут хранится в двух следующих форматах: 1cd и dt.\nВ первом случае с помощью утилиты Tool_1CD можно сразу открыть файл 1Cv8.1CD. Далее следует слева выбрать таблицу v8users и выделить ячейку из столбца DATA в строке интересующей учетной записи. В окне данных будут закодированные с помощью base64 SHA-1 хеши от регистр зависимых и независимых версий паролей.\n\rПосле декодирования по SHA-1 хешам можно провести офлайн подбор паролей. Более того для SHA-1 также существуют радужные таблицы.\nНиже для наглядности приведен пример подбора ряда паролей с помощью сайта Crackstation.\nДля офлайн перебора по словарю в Hashcat SHA-1 соответствует -m 100.\n\r Примечание: Также можно попробовать скачать обучающую версию 1С (требуется регистрация на официальном сайте по номеру телефона) и локально импортировать туда выгруженную базу. В последних версиях 1С для входа в базу может потребоваться ввод пароля. Не проверял на практике, поэтому не берусь однозначно утверждать, но в этом случае вроде бы можно переписать хеш пароля администратора и получить доступ к хранящимся в 1С сведениям, в том числе к хешам остальных учетных записей (также см. PasswordChanger1C).\n Если данные хранятся в формате dt, то для их конвертации в формат 1cd можно использовать утилиту. После конвертации задача сводится к рассмотренной ранее.\n Примечание: Версия pfDTTools, расположенная в открытом доступе, не позволяет выполнить конвертацию на текущий момент. Автор утилиты собирался в ближайшее время опубликовать закрытый релиз содержащий указанную возможность.\n Рекомендации: провести инвентаризацию подконтрольных информационных ресурсов на предмет хранения резервных копий 1С в открытом виде в доступных для рядовых пользователей местах (сетевые папки, хранилища, файловые сервера). Хранить резервные копии 1С в защищенном виде, например с помощью криптоконтейнеров, изолированно от основной сети.\nВместо заключения \r\r\rMindmap по возможным атакам на 1С\r\r\rПолезные ссылки  1С глазами пентестера - Анастасия Прядко + pdf 1С глазами злоумышленника - Алексей Старев 1C-Exploit-Kit Взламываем Windows Server через 1С История одного взлома 1С или проверьте вашу систему на безопасность видео Технология восстановления пароля 1С v8 Формат файлов выгрузки DT Консоль кода для управляемых форм (пост + git) Практический опыт построения защищенного контура для 1С-приложений - Олег Филиппов Мастер класс по инструментам кластера 1С для повышения уровня защищённости системы - Антон Дорошкевич Взломать сервер 1С за 15 минут - Антон Дорошкевич Найти и уничтожить Популярные уязвимости в проектах 1С - Олег Тымко НеБезопасный прикладной программный интерфейс сервера - Владимир Бондаревский статья Взломать за 60 секунд! - Антон Дорошкевич  ","wordCount":"2187","inLanguage":"ru","image":"https://ardent101.github.io/posts/1c/images/logo.jpg","datePublished":"2024-02-22T08:31:03Z","dateModified":"2024-02-22T08:31:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.io/posts/1c/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.io/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.io/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Еще 1 раз про пентест 1С</h1><div class=post-meta><span title="2024-02-22 08:31:03 +0000 +0000">февраля 22, 2024</span>&nbsp;·&nbsp;11 мин&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.io/posts/1c/images/logo_hu55af5474fa935438d0c4b4b578365887_356542_360x0_resize_q75_box.jpg 360w ,https://ardent101.github.io/posts/1c/images/logo_hu55af5474fa935438d0c4b4b578365887_356542_480x0_resize_q75_box.jpg 480w ,https://ardent101.github.io/posts/1c/images/logo_hu55af5474fa935438d0c4b4b578365887_356542_720x0_resize_q75_box.jpg 720w ,https://ardent101.github.io/posts/1c/images/logo_hu55af5474fa935438d0c4b4b578365887_356542_1080x0_resize_q75_box.jpg 1080w ,https://ardent101.github.io/posts/1c/images/logo_hu55af5474fa935438d0c4b4b578365887_356542_1500x0_resize_q75_box.jpg 1500w ,https://ardent101.github.io/posts/1c/images/logo.jpg 1797w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.io/posts/1c/images/logo.jpg alt width=1797 height=1109></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Оглавление</span></summary><div class=inner><ul><li><a href=#%d0%b2%d0%b2%d0%b5%d0%b4%d0%b5%d0%bd%d0%b8%d0%b5 aria-label=Введение>Введение</a></li><li><a href=#%d0%ba%d1%80%d0%b0%d1%82%d0%ba%d0%b8%d0%b5-%d1%81%d0%b2%d0%b5%d0%b4%d0%b5%d0%bd%d0%b8%d1%8f-%d0%be%d0%b1-1c%d0%bf%d1%80%d0%b5%d0%b4%d0%bf%d1%80%d0%b8%d1%8f%d1%82%d0%b8%d0%b5 aria-label="Краткие сведения об 1C:Предприятие">Краткие сведения об 1C:Предприятие</a></li><li><a href=#%d1%81%d1%86%d0%b5%d0%bd%d0%b0%d1%80%d0%b8%d0%b8-%d0%ba%d0%be%d0%bc%d0%bf%d1%8c%d1%8e%d1%82%d0%b5%d1%80%d0%bd%d1%8b%d1%85-%d0%b0%d1%82%d0%b0%d0%ba-%d0%bd%d0%b0-1%d1%81 aria-label="Сценарии компьютерных атак на 1С">Сценарии компьютерных атак на 1С</a><ul><li><a href=#%d0%bf%d0%be%d0%b8%d1%81%d0%ba-%d0%ba%d0%bb%d0%b0%d1%81%d1%82%d0%b5%d1%80%d0%b0-1c aria-label="Поиск кластера 1C">Поиск кластера 1C</a></li><li><a href=#%d0%bf%d0%be%d0%bb%d1%83%d1%87%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d0%b5%d1%80%d0%b2%d0%be%d0%bd%d0%b0%d1%87%d0%b0%d0%bb%d1%8c%d0%bd%d0%be%d0%b3%d0%be-%d0%b4%d0%be%d1%81%d1%82%d1%83%d0%bf%d0%b0 aria-label="Получение первоначального доступа">Получение первоначального доступа</a><ul><li><a href=#%d1%8d%d0%ba%d1%81%d0%bf%d0%bb%d1%83%d0%b0%d1%82%d0%b0%d1%86%d0%b8%d1%8f-%d0%be%d1%82%d1%81%d1%83%d1%82%d1%81%d1%82%d0%b2%d0%b8%d1%8f-%d0%bf%d0%b0%d1%80%d0%be%d0%bb%d1%8f aria-label="Эксплуатация отсутствия пароля">Эксплуатация отсутствия пароля</a></li><li><a href=#%d0%bf%d0%be%d0%b4%d0%b1%d0%be%d1%80-%d1%83%d1%87%d0%b5%d1%82%d0%bd%d1%8b%d1%85-%d0%b7%d0%b0%d0%bf%d0%b8%d1%81%d0%b5%d0%b9 aria-label="Подбор учетных записей">Подбор учетных записей</a></li><li><a href=#%d0%b0%d0%bd%d0%b0%d0%bb%d0%b8%d0%b7-%d1%80%d0%b5%d0%b7%d0%b5%d1%80%d0%b2%d0%bd%d1%8b%d1%85-%d0%ba%d0%be%d0%bf%d0%b8%d0%b9 aria-label="Анализ резервных копий">Анализ резервных копий</a></li></ul></li></ul></li><li><a href=#%d0%b2%d0%bc%d0%b5%d1%81%d1%82%d0%be-%d0%b7%d0%b0%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d1%8f aria-label="Вместо заключения">Вместо заключения</a></li><li><a href=#%d0%bf%d0%be%d0%bb%d0%b5%d0%b7%d0%bd%d1%8b%d0%b5-%d1%81%d1%81%d1%8b%d0%bb%d0%ba%d0%b8 aria-label="Полезные ссылки">Полезные ссылки</a></li></ul></div></details></div><div class=post-content><h2 id=введение>Введение<a hidden class=anchor aria-hidden=true href=#введение>#</a></h2><p>Настоящий материал по большей части состоит из общедоступных наработок других людей. Целью было проверить указанные наработки на практике и собрать получившиеся результаты в одном месте. Именно этим объясняется название статьи.</p><p>Продолжу рассуждение в терминах, обозначенных <a href=/posts/manifest/>ранее</a>.</p><p>По имеющемуся опыту для типовой Организации в качестве ключевой системы можно выделить контроллеры домена, а в качестве критерия подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям - получение несанкционированного доступа к учетной записи администратора домена.</p><p>Тем не менее, чтобы улучшить качество мероприятий по тестированию на проникновение есть смысл рассмотреть другие ключевые системы и подходы к построению сценариев применительно к ним. Хорошим примером ключевой системы, отличной от контроллеров домена, является 1С:Предприятие.</p><p>Применительно к указанной ключевой системе можно выделить следующие негативные для Организации последствия компьютерных атак:</p><ul><li>потеря (хищение) денежных средств</li><li>нарушение конфиденциальности (утечка) персональных данных</li></ul><p>Критериями подтверждения возможности реализации компьютерных атак, приводящих к негативным для Организации последствиям в рассматриваемом случае могут быть:</p><ul><li>получение административного доступа к серверу, обеспечивающему функционирование системы 1С:Предприятие;</li><li>получение доступа к действующей административной учетной записи к системе 1С:Предприятие.</li></ul><p>Далее будут рассмотрены ряд сценариев компьютерных атак в отношении 1С:Предприятие, а также приведены примеры подтверждения возможности реализации указанных атак на практике.</p><h2 id=краткие-сведения-об-1cпредприятие>Краткие сведения об 1C:Предприятие<a hidden class=anchor aria-hidden=true href=#краткие-сведения-об-1cпредприятие>#</a></h2><p>1C:Предприятие предназначено для автоматизации, управления и учета в Организации различных видов деятельности и типов финансирования. 1С:Предприятие состоит из технологической платформы (ядра) и разработанных на ее основе прикладных решений (конфигураций), например:</p><ul><li>1С:Бухгалтерия 8</li><li>1С:Документооборот 8</li><li>1С:Зарплата и управление персоналом 8</li><li>1C:ERP Управление предприятием 2.0</li></ul><p>Все прикладные решения 1С имеют однотипный интерфейс и подчиняются общим принципам работы. Более того, решения могут работать совместно, а также производить обмен данными.</p><p>Также технологическая платформа содержит специальную среду для создания и доработки прикладных решений. Эта часть платформы называется конфигуратор. Конфигуратор используется программистами для настройки и обновления программ.</p><p><img src=images/1C_40.png alt=1C_40.png></p><p>Стоит отметить, что за 30 лет существования было выпущено множество версий платформы 1С. Более подробно ознакомиться c хронологией выхода и различиями между версиями платформы 1С можно в материалах <a href=https://wiseadvice-it.ru/o-kompanii/blog/articles/kakie-byvaut-versii-1s/>&ldquo;Какие бывают версии 1С&rdquo;</a> или <a href="https://www.dmosk.ru/faq.php?object=version-1c">&ldquo;Обзор версий 1С:Предприятие&rdquo;</a>.</p><p>В настоящей момент наиболее актуальные версии платформы начинаются с идентификатора 8.3, поэтому всюду далее полагается, что используются именно они.</p><p>С платформой 1С:Предприятие 8.3 одновременно могут работать тысячи пользователей. С целью обеспечения масштабируемости, баланса нагрузки и отказоустойчивости используется кластерная архитектура.</p><p><figure><img src=images/1c_cluster_scheme.png alt=1c_cluster_scheme.png><figcaption><p style=text-align:center>Иллюстрация архитектуры 1С</p></figcaption></figure></p><p>В первом приближении отметим, что с использованием различных клиентов можно подключиться к кластеру серверов, в свою очередь обеспечивающему взаимодействие с различными СУБД. Таким образом, именно кластер серверов 1С является ключевой системой при построении сценариев атак в отношение системы 1С:Предприятие.</p><p>Больше об архитектуре платформы 1С рассказывается в статье <a href=https://habr.com/ru/companies/1c/articles/493008/>&ldquo;Про кластер серверов 1С&rdquo;</a>.</p><h2 id=сценарии-компьютерных-атак-на-1с>Сценарии компьютерных атак на 1С<a hidden class=anchor aria-hidden=true href=#сценарии-компьютерных-атак-на-1с>#</a></h2><h3 id=поиск-кластера-1c>Поиск кластера 1C<a hidden class=anchor aria-hidden=true href=#поиск-кластера-1c>#</a></h3><p>Найти кластеры серверов 1С:Предприятие возможно в результате поиска по следующим портам:</p><ul><li>1540/tcp (rds) - порт рабочего сервера</li><li>1541/tcp (rds2) - порт кластера 1C</li><li>1545</li><li>80/tcp (http) - порт для подключения через веб-сервис (может быть закрыт, если веб-клиенты 1С не используются)</li></ul><p>Общая команда для поиска кластеров серверов 1С:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>nmap -p1540,1541,1545 <span class=s1>&#39;subnet/mask&#39;</span>
</span></span></code></pre></div><p><img src=images/1C_2.png alt=1C_2.png></p><p>Также следует не забывать обращать внимание на DNS-имена, содержащие в названии &ldquo;1С&rdquo;. Если же речь идет о домене, то можно поискать сведения о 1С в комментариях учетных записей (смотри Сypher запросы к BloodHoud ниже).</p><pre tabindex=0><code class=language-cypher data-lang=cypher>MATCH (c:Computer) WHERE ANY (x IN c.description WHERE toUpper(x) CONTAINS &#39;1С&#39;) RETURN c

MATCH (c) WHERE toUpper(c.name) CONTAINS &#39;1C&#39; RETURN c.name
</code></pre><h3 id=получение-первоначального-доступа>Получение первоначального доступа<a hidden class=anchor aria-hidden=true href=#получение-первоначального-доступа>#</a></h3><h4 id=эксплуатация-отсутствия-пароля>Эксплуатация отсутствия пароля<a hidden class=anchor aria-hidden=true href=#эксплуатация-отсутствия-пароля>#</a></h4><p>Один из главных и часто встречающихся недостатков заключаются в том, что
по умолчанию пароль для доступа к консоли администрирования кластера серверов 1С отсутствует. Рассмотрим варианты эксплуатации указанного недостатка на практике.</p><p>Допустим кластер серверов обнаружен. Проверить отсутствие пароля можно просто попробовав подключиться к выявленному кластеру. Для подключения необходима утилиту <code>Администрирование серверов 1С: Предприятия</code> с версией соответствующей версии кластера 1С.</p><p>Если открыт порт <code>1545</code> (встречается редко), то определить версию клиента 1С можно с помощью утилиты <a href=https://github.com/sdnv0x4d/rasoff#rasoff>rasoff</a>, в противном случае всегда можно попробовать подключиться произвольным клиентом 1С и получить ошибку с информацией об используемой версии.</p><p><figure><img src=images/1C_3.png alt=1C_3.png><figcaption><p style=text-align:center>Пример выявления версии клиента по ошибке соединения</p></figcaption></figure></p><p>Далее необходимо найти и установить клиент соответствующей версии. По-хорошему для этого необходимо обладать платным доступом к порталу 1С, но также можно посмотреть <a href=https://t.me/onecserver>здесь</a>.</p><p>Кроме того, целесообразно посмотреть файлы, распространяемые с помощью групповых политик, например в PingCastle. В этом случае можно найти общедоступные сетевые папки, откуда сразу взять необходимые клиенты, в том числе и для других кластеров 1С, если их в Организации несколько.</p><p><figure><img src=images/1C_4.png alt=1C_4.png><figcaption><p style=text-align:center>Пример обнаружения установщика клиента 1С из групповых политик</p></figcaption></figure></p><p>Допустим установщик клиента с необходимой версией был получен. Дальше при установке надо дополнительно добавить модуль администрирования (см. ниже).</p><p><img src=images/1C_5.jpg alt=1C_5.jpg></p><p>Перед первым запуском консоли, её необходимо зарегистрировать с использованием скрипта «Регистрация утилиты администрирования». По завершению можно запускать указанную утилиту:</p><p><img src=images/1%d0%a1_8.jpg alt=1С_8.jpg></p><p>Далее в интерфейсе утилиты следует указать кластер серверов 1С. Для этого потребуются IP-адрес и порт, выясненные ранее в ходе разведки:</p><p><img src=images/1%d0%a1_9.jpg alt=1С_9.jpg></p><p><img src=images/1%d0%a1_10.jpg alt=1С_10.jpg></p><p>При отсутствии пароля при подключении к указанному кластеру серверов 1С
будет получена подобная картина:</p><p><img src=images/1%d0%a1_7.png alt=1С_7.png></p><p>При наличии требования пароля будет открыто следующее окно:</p><p><img src=images/1%d0%a1_6.png alt=1С_6.png></p><p>Далее продолжим рассматривать случай, когда пароль отсутствует. Подключившись к кластеру серверов 1С с использованием утилиты администрирования можно:</p><ul><li>узнать названия информационных баз, а также в ряде случаев при попытке подключения к ним получить список идентификаторов учетных записей (полезно при подборе паролей)</li><li>выявить тестовые информационные базы в которые можно зайти без пароля и залить &ldquo;полезную&rdquo; внешнюю обработку</li><li>создать новую информационную базу с конфигурацией эмулирующей командную строку и таким образом получить возможность удаленного выполнения кода на кластере 1С с правами пользователя от которого запущена соответствующая служба</li></ul><p>Наиболее предпочтительным вариантом постэксплуатации является создание новой информационной базы, так как тогда не происходит перезаписи ранее имеющихся данных. В этом случае общий порядок действий следующий:</p><ol><li>Подготовить базу данных PostgresSQL на подконтрольном сервере, в частности можно использовать свою виртуальную машину</li><li>Создать на кластере 1С новую информационную базу с использованием установленной базы данных PostgresSQL</li><li>Загрузить конфигурацию с &ldquo;полезной&rdquo; нагрузкой</li></ol><p>Далее подробно рассмотрим каждый из указанных шагов.</p><blockquote><p><strong>Примечание:</strong> если все же желания создавать новую базу нет и хочется воспользоваться имеющейся информационной базой, то важно помнить, что любая загрузка новой конфигурации подразумевает перезапись старых данных. По этой причине загрузку новой конфигурации в тестовую устаревшую ненужную информационную базу лучше предварительно согласовывать с администратором. Кроме того, следует сделать резервную копию базы, а также убедиться, что активные пользовательские сессии отсутствуют.</p></blockquote><p>Ранее <a href=#%D0%BA%D1%80%D0%B0%D1%82%D0%BA%D0%B8%D0%B5-%D1%81%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BE%D0%B1-1c%D0%BF%D1%80%D0%B5%D0%B4%D0%BF%D1%80%D0%B8%D1%8F%D1%82%D0%B8%D0%B5>в кратких сведениях</a> была рассмотрена архитектура платформы 1С. Для создания информационной базы необходимо наличие подконтрольной СУБД. 1С может работать с различными базами данных, в частности с MSSQL. Тем не менее в виду свободной модели распространения удобнее использовать PostgresSQL.</p><p>По-хорошему можно взять любой дистрибутив PostgresSQL и просто его установить, но даже в этом незамысловатом процессе могут появиться небольшие проблемы.</p><p>После установки версии PostgresSQL для Windows, взятой с официального сайта, возникли ошибки связанные с кодировкой. Возможно в Linux было бы по-другому, но в итоге было решено установить дистрибутив PostgresSQL специально предназначенный для работы с 1С.</p><p><img src=images/1%d0%a1_13.png alt=1С_13.png></p><p>Согласно <a href=https://infostart.ru/1c/articles/1180438/>одному</a> из руководств перед установкой был отключен протокол IPv6</p><p><img src=images/1%d0%a1_16.png alt=1С_16.png></p><p>и включена служба &ldquo;Вторичный вход в систему&rdquo;</p><p><img src=images/1%d0%a1_14.png alt=1С_14.png></p><p><img src=images/1%d0%a1_15.png alt=1С_15.png></p><p>После успешной установки можно приступать к непосредственному созданию информационной базы:</p><p><img src=images/1%d0%a1_11.jpg alt=1С_11.jpg></p><p>В параметрах следует указать данные созданной СУБД:</p><p><img src=images/1C_12.png alt=1C_12.png></p><p>Теперь в клиенте можно настроить подключение к созданной информационной базе:</p><p><img src=images/1%d0%a1_17.png alt=1С_17.png></p><p><img src=images/1%d0%a1_18.png alt=1С_18.png></p><p>В результате созданные настройки подключения будут сохранены и добавлены в общий список:</p><p><img src=images/1%d0%a1_19.png alt=1С_19.png></p><p>Для дальнейшей эксплуатации остается загрузить специальную информационную базу, содержащую полезную нагрузку. В качестве примера можно использовать следующую <a href=https://github.com/KraudSecurity/1C-Exploit-Kit/tree/master/1C-Shell>конфигурацию</a> за авторством компании &ldquo;Крауд&rdquo;.</p><p><img src=images/1%d0%a1_20.png alt=1С_20.png></p><p>Таким образом будет получена возможность удаленного выполнения кода кластере 1С с правами пользователя от которого запущена соответствующая служба:</p><p><img src=images/1%d0%a1_21.png alt=1С_21.png></p><p>Далее возможны различные варианты. В первую очередь следует определиться какими правами и привилегиями обладает учетная запись из-под которой выполняются команды. На практике подобные учетные записи в ряде случаев даже обладали правами уровня администратора домена. Проверить это возможно с помощью BloodHound.</p><p>Чаще все же на подобную удачу рассчитывать не стоит. Более рабочий вариант - посмотреть наличие привилегии <code>SeImpersonatePrivilege</code>, которой достаточно для локального повышения (смотри <a href=https://github.com/itm4n/PrintSpoofer>PrintSpoofer</a>). Далее, локально повысив права, можно поискать сессии административных учетных записей и попробовать их имперсоанизировать.</p><p><img src=images/1%d0%a1_22.png alt=1С_22.png></p><p>Также, иногда учетная запись из-под которой запущена служба 1С, может обладать привилегией на неограниченное делегирование.</p><p><img src=images/1C_43.png alt=1C_43.png></p><p>На этот счет рекомендую ознакомиться с <a href=/posts/kerberos_delegation/>этим</a> материалом.</p><p>В качестве альтернативного варианта постэксплуатации можно загрузить новую внешнюю обработку, например за авторством <a href=https://github.com/Levatein/1C_shell>Levatein</a>. К слову очень рекомендую к ознакомлению доклад на SOC форуме 2023 года <a href=https://vk.com/video-221945088_456239212>&ldquo;1С глазами пентестера&rdquo;</a>.</p><p><img src=images/1%d0%a1_25.jpg alt=1С_25.jpg></p><p>Подобная обработка пригодится, если кластер запущен в операционной системе на базе Linux.</p><p>Отдельный интерес при постэкплуатации кластера 1С представляет содержимое файла <code>1СV8Clst.lst</code>, как правило расположенного по пути
<code>C:\Program Files\1cv8\srvinfo\reg_xxxx\</code>:</p><p><img src=images/1%d0%a1_24.png alt=1С_24.png></p><p>В этом файле хранятся идентификаторы и шифрованные пароли административных учетных записей СУБД, использующихся кластером 1С.</p><p><img src=images/1%d0%a1_27.png alt=1С_27.png></p><p>Важная особенность заключается в том, что ключ шифрования и инициализационный вектор являются общеизвестными и постоянными. Тем самым получить пароли в открытом виде не составляет особого труда.</p><p>Для расшифровки паролей можно воспользоваться следующей ссылкой:</p><pre tabindex=0><code class=language-url data-lang=url>https://gchq.github.io/CyberChef/#recipe=From_Base64(&#39;A-Za-z0-9%2B/%3D&#39;,true,false)AES_Decrypt(%7B&#39;option&#39;:&#39;Hex&#39;,&#39;string&#39;:&#39;7D5A39D625A10A476FAD6AB519C4E092&#39;%7D,%7B&#39;option&#39;:&#39;Hex&#39;,&#39;string&#39;:&#39;6D4A7FD2C4A791B48E4296A6B3CF765D&#39;%7D,&#39;CBC&#39;,&#39;Raw&#39;,&#39;Raw&#39;,%7B&#39;option&#39;:&#39;Hex&#39;,&#39;string&#39;:&#39;&#39;%7D,%7B&#39;option&#39;:&#39;Hex&#39;,&#39;string&#39;:&#39;&#39;%7D)&amp;input=TlMvUnlSOW1rU0daUUw1SElhUUdod2VoaHNKUkZrZ0Y5SDlWbjVXRW04VT0
</code></pre><p><img src=images/1%d0%a1_28.png alt=1С_28.png></p><p>Добытые учетные записи можно использовать для дальнейшего продвижения и удаленного выполнения кода на серверах, обеспечивающих функционирование СУБД:</p><p><img src=images/1%d0%a1_29.jpg alt=1С_29.jpg></p><p><strong>Рекомендация:</strong> создать администратора кластера 1С и ограничить доступ к консоли администрирования кластера 1С с использованием пароля.</p><h4 id=подбор-учетных-записей>Подбор учетных записей<a hidden class=anchor aria-hidden=true href=#подбор-учетных-записей>#</a></h4><p>Как было показано в <a href=#%D0%BA%D1%80%D0%B0%D1%82%D0%BA%D0%B8%D0%B5-%D1%81%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BE%D0%B1-1c%D0%BF%D1%80%D0%B5%D0%B4%D0%BF%D1%80%D0%B8%D1%8F%D1%82%D0%B8%D0%B5>кратких сведениях</a>, Организация может использовать WEB-сервер для доступа к кластеру серверов 1С. Указанный WEB-сервер также может быть доступен со стороны сети Интернет. Это бывает удобно, в случаях когда требуется предоставить удаленный доступ ряду сотрудников или есть потребность в использовании мобильных клиентов. Иногда подобные WEB-сервера могут быть доступны только &ldquo;изнутри&rdquo;. В любом случае наличие WEB-сервера 1С позволяет осуществлять атаки методом перебора паролей к действующим учетным записям.</p><p>Обнаружить WEB-сервера 1C можно с помощью утилиты <a href=https://github.com/sensepost/gowitness>gowitness</a>.</p><p>Для успешной аутентификации необходимо знать:</p><ul><li>название информационной базы</li><li>идентификатор учетной записи</li><li>пароль</li></ul><p>Сперва, если наименование информационной базы неизвестно, то его необходимо подобрать, например с использованием словарей <a href=https://github.com/KraudSecurity/1C-Exploit-Kit/tree/master/1C-Finder>1C-Finder</a> от Kraud.</p><p>Далее, если у пользователя включена настройка &ldquo;показывать в списке выбора&rdquo;, то при попытке подключения к выявленной базе будет отображаться его идентификатор. Таким образом, можно получить некоторый не обязательно полный перечень названий учетных записей:</p><p><img src=images/1%d0%a1_41.png alt=1С_41.png></p><p>Выгрузить весь список доступных идентификаторов можно по следующему URL:</p><pre tabindex=0><code class=language-url data-lang=url>http://&lt;server-IP-or-DNS&gt;:&lt;port&gt;/&lt;db_name&gt;/en_US/e1cib/users
</code></pre><p>Учетные данные передаются на WEB-сервер 1С POST-запросом на URL следующего вида:</p><pre tabindex=0><code class=language-url data-lang=url>http://&lt;server-IP-or-DNS&gt;:&lt;port&gt;/&lt;db_name&gt;/en_US/e1cib/login?version=8.3.XX.XXXX&amp;cred=base64(идентификатор)08base64(пароль)
</code></pre><p><code>08</code> - выступает в качестве разделителя между идентификатором и паролем</p><p>Таким образом, с помощью обычных фаззеров методом POST по приведенному URL можно подбирать действующие учетные записи. Автоматизировать подбор можно с помощью Burp Suite, patator, ffuf и других инструментов.</p><p>В 1С пароли не чувствительны к регистру, то есть &ldquo;Пароль&rdquo; и &ldquo;пАрОль&rdquo; являются эквивалентами. Кроме того, нередко в 1С применяется недостаточно строгая парольная политика. Часто администраторы не включают проверку сложности паролей пользователей, а также не устанавливают длительность блокировки при превышении количества неуспешных попыток аутентификации или максимальное количество неуспешных попыток аутентификации.</p><p><figure><img src=images/1C_37.png alt=1C_37.png><figcaption><p style=text-align:center>Пример парольной политики с отключенной проверкой сложности</p></figcaption></figure></p><p>Вдобавок ко всему, зная некоторый типовой для Организации пароль, можно наоборот попробовать подбирать к нему идентификатор, например взяв за основу перечень почтовых адресов, полученных с помощью данного <a href=phonebook.cz>сайта</a>.</p><p>Иногда при успешном подборе пароля выясняется, что он устарел и требуется ввести новый пароль:</p><p><img src=images/1%d0%a1_23.png alt=1С_23.png></p><p>Также следует не забывать, что пароль к некоторым учетным записям может и вовсе быть пустым.</p><p><strong>Рекомендация:</strong> использовать строгую парольную политику.</p><h4 id=анализ-резервных-копий>Анализ резервных копий<a hidden class=anchor aria-hidden=true href=#анализ-резервных-копий>#</a></h4><p>Часто подтвердить возможность захвата кластера 1С можно в результате подтверждения захвата домена, в состав которого входит указанный кластер, но это тривиально, поэтому рассмотрим случай, когда кластер 1С не состоит в домене.</p><p>Допустим каким-то способом был получен доступ к резервным копиям информационных баз. Например, представим что при наличие прав администратора домена подобные копии были обнаружены в открытом виде в системе резервного копирования, входящей в состав указанного домена.</p><p><img src=images/1%d0%a1_42.png alt=1С_42.png></p><p>Базы 1С могут хранится в двух следующих форматах: <code>1cd</code> и <code>dt</code>.</p><p>В первом случае с помощью утилиты <a href=https://koder.by/download_tool_1cd.php>Tool_1CD</a> можно сразу открыть файл 1Cv8.1CD. Далее следует слева выбрать таблицу v8users и выделить ячейку из столбца DATA в строке интересующей учетной записи. В окне данных будут закодированные с помощью base64 SHA-1 хеши от регистр зависимых и независимых версий паролей.</p><p><img src=images/1C_35.png alt=1C_35.png></p><p>После декодирования по SHA-1 хешам можно провести офлайн подбор паролей. Более того для SHA-1 также существуют <a href=http://project-rainbowcrack.com/table.htm>радужные таблицы</a>.</p><p>Ниже для наглядности приведен пример подбора ряда паролей с помощью сайта <a href=https://crackstation.net/>Crackstation</a>.</p><p>Для офлайн перебора по словарю в <code>Hashcat</code> SHA-1 соответствует <code>-m 100</code>.</p><p><img src=images/1C_36.png alt=1C_36.png></p><blockquote><p><strong>Примечание:</strong> Также можно попробовать скачать обучающую версию 1С (требуется регистрация на официальном сайте по номеру телефона) и локально импортировать туда выгруженную базу. В последних версиях 1С для входа в базу может потребоваться ввод пароля. Не проверял на практике, поэтому не берусь однозначно утверждать, но в этом случае вроде бы можно переписать хеш пароля администратора и получить доступ к хранящимся в 1С сведениям, в том числе к хешам остальных учетных записей (также см. <a href=https://github.com/alex-bochkov/PasswordChanger1C>PasswordChanger1C</a>).</p></blockquote><p>Если данные хранятся в формате <code>dt</code>, то для их конвертации в формат 1cd можно использовать <a href=https://github.com/pasha1st/pfDTTools>утилиту</a>. После конвертации задача сводится к рассмотренной ранее.</p><blockquote><p><strong>Примечание:</strong> Версия pfDTTools, расположенная в открытом доступе, не позволяет выполнить конвертацию на текущий момент. Автор утилиты собирался в ближайшее время опубликовать закрытый релиз содержащий указанную возможность.</p></blockquote><p><strong>Рекомендации:</strong> провести инвентаризацию подконтрольных информационных ресурсов на предмет хранения резервных копий 1С в открытом виде в доступных для рядовых пользователей местах (сетевые папки, хранилища, файловые сервера). Хранить резервные копии 1С в защищенном виде, например с помощью криптоконтейнеров, изолированно от основной сети.</p><h2 id=вместо-заключения>Вместо заключения<a hidden class=anchor aria-hidden=true href=#вместо-заключения>#</a></h2><p><figure><img src=images/vectors.png alt=vectors.png><figcaption><p style=text-align:center>Mindmap по возможным атакам на 1С</p></figcaption></figure></p><h2 id=полезные-ссылки>Полезные ссылки<a hidden class=anchor aria-hidden=true href=#полезные-ссылки>#</a></h2><ul><li><a href=https://vk.com/video-221945088_456239212>1С глазами пентестера - Анастасия Прядко</a> + <a href=https://forumsoc.ru/upload/iblock/a0e/z5tk08dyww770v2i0gunzxvxkgpm7hc0.pdf>pdf</a></li><li><a href="https://m.youtube.com/watch?v=eZNHimUJxTk&embeds_referring_euri=https%3A%2F%2Finfostart.ru%2F&source_ve_path=Mjg2NjY&feature=emb_logo">1С глазами злоумышленника - Алексей Старев</a></li><li><a href=https://github.com/KraudSecurity/1C-Exploit-Kit>1C-Exploit-Kit</a></li><li><a href=https://habr.com/en/articles/352566/>Взламываем Windows Server через 1С</a></li><li><a href=https://habr.com/en/articles/695586/>История одного взлома 1С или проверьте вашу систему на безопасность</a> <a href="https://youtu.be/0ybtR1OK2jU?si=eaBzjj4XldhrRzUQ">видео</a></li><li><a href=https://www.klerk.ru/soft/articles/320734/>Технология восстановления пароля 1С v8</a></li><li><a href=https://infostart.ru/1c/articles/1865138/>Формат файлов выгрузки DT</a></li><li>Консоль кода для управляемых форм (<a href=https://infostart.ru/1c/tools/1266087/>пост</a> + <a href=https://github.com/salexdv/bsl_console>git</a>)</li><li><a href="https://youtu.be/cMTuT4bJoik?si=GcAV2UkFuAuYzyGs">Практический опыт построения защищенного контура для 1С-приложений - Олег Филиппов</a></li><li><a href="https://www.youtube.com/watch?v=fBHZKcV3VeA">Мастер класс по инструментам кластера 1С для повышения уровня защищённости системы - Антон Дорошкевич</a></li><li><a href="https://www.youtube.com/watch?v=Mo2Y5YVyJiM">Взломать сервер 1С за 15 минут - Антон Дорошкевич</a></li><li><a href="https://www.youtube.com/watch?v=Cy1i1h1jRFs">Найти и уничтожить Популярные уязвимости в проектах 1С - Олег Тымко</a></li><li><a href=https://infostart.ru/video/w1615162/>НеБезопасный прикладной программный интерфейс сервера - Владимир Бондаревский</a> <a href=https://infostart.ru/1c/articles/1615125/>статья</a></li><li><a href=https://is1c.ru/career/blog/vzlomat-za-60-sekund/>Взломать за 60 секунд! - Антон Дорошкевич</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.io/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.io/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.io/tags/1c/>1C</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on twitter" href="https://twitter.com/intent/tweet/?text=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1&url=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f&hashtags=ActiveDirectory%2cPentest%2c1C"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f&title=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1&summary=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1&source=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f&title=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on whatsapp" href="https://api.whatsapp.com/send?text=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1%20-%20https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Еще 1 раз про пентест 1С on telegram" href="https://telegram.me/share/url?text=%d0%95%d1%89%d0%b5%201%20%d1%80%d0%b0%d0%b7%20%d0%bf%d1%80%d0%be%20%d0%bf%d0%b5%d0%bd%d1%82%d0%b5%d1%81%d1%82%201%d0%a1&url=https%3a%2f%2fardent101.github.io%2fposts%2f1c%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://ardent101.github.io/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="копировать";function s(){e.innerText="скопировано!",setTimeout(()=>{e.innerText="копировать"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>