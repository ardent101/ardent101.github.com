<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование | Ardent101</title><meta name=keywords content="Active Directory,Kerberos,Pentest,Теория,Делегирование"><meta name=description content="В предыдущей части были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая вводная, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.
Ограниченное делегирование Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.
Сервис, обладающий правом на ограниченное делегирование, может обратиться к другим определенным сервисам от имени практически любого пользователя."><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.io/posts/kerberos_constrained/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.io/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.io/static/favicon-32x32.png><link rel=apple-touch-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование"><meta property="og:description" content="В предыдущей части были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая вводная, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.
Ограниченное делегирование Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.
Сервис, обладающий правом на ограниченное делегирование, может обратиться к другим определенным сервисам от имени практически любого пользователя."><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.io/posts/kerberos_constrained/"><meta property="og:image" content="https://ardent101.github.io/posts/kerberos_constrained/images/logo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-20T09:30:03+00:00"><meta property="article:modified_time" content="2022-09-20T09:30:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.io/posts/kerberos_constrained/images/logo.jpg"><meta name=twitter:title content="Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование"><meta name=twitter:description content="В предыдущей части были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая вводная, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.
Ограниченное делегирование Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.
Сервис, обладающий правом на ограниченное делегирование, может обратиться к другим определенным сервисам от имени практически любого пользователя."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование","item":"https://ardent101.github.io/posts/kerberos_constrained/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование","name":"Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование","description":"В предыдущей части были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая вводная, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.\nОграниченное делегирование Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.\nСервис, обладающий правом на ограниченное делегирование, может обратиться к другим определенным сервисам от имени практически любого пользователя.","keywords":["Active Directory","Kerberos","Pentest","Теория","Делегирование"],"articleBody":"В предыдущей части были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая вводная, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.\nОграниченное делегирование Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.\nСервис, обладающий правом на ограниченное делегирование, может обратиться к другим определенным сервисам от имени практически любого пользователя.\n\r\r\rОбщая идея ограниченного делегирования\r\r\rИзначально протокол Kerberos не поддерживал механизм ограниченного делегирования. Для его внедрения Microsoft выпустила два новых расширения: S4U2Self и S4U2Proxy.\nДля настройки ограниченного делегирования требуется наличие привилегии SeEnableDelegationPrivilege, которой по умолчанию обладают только учетные записи с правами уровня администратора домена.\nОграниченное делегирование с использованием только Kerberos (S4U2Proxy) Расширение S4U2Proxy (Service for User to Proxy) используется, когда аутентификация клиента к сервису с ограниченным делегированием может осуществляться только по протоколу Kerberos.\nДля настройки указанного вида делегирования в атрибуте msds-allowedtodelegateto учетной записи необходимо указать SPN при обращении к которым приведенной учетной записи требуется олицетворять других пользователей.\n\r\r\rПример: у учетной записи \"WEB01$\" настроено ограниченное делегирование с использованием только протокола Kerberos\r\r\r\r\r\rСодержимое атрибута msds-allowedtodelegateto у учетной записи \"WEB01$\"\r\r\rРассмотрим общую схему ограниченного делегирования с использованием только протокола Kerberos:\n\r\r\rИллюстрация обмена сообщений в S4U2Proxy\r\r\r User стандартно получает TGS-билет с флагом Forwardable для доступа к Сервису A и отправляет его на указанный сервис. Сервис А пересылает полученный TGS-билет на контроллер домена с целью получения доступа к Сервису Б от имени User. Как было замечено ранее, TGS-билет содержит имя пользователя для которого он предназначался. Таким образом Сервис А доказывает, что User действительно обращался к нему. Контроллер домена проверяет, что атрибут msds-allowedtodelegateto “Владельца А” содержит SPN Сервиса Б и в случае успешной проверки отправляет Сервису А Forwardable TGS-билет к Сервису Б для User.   Важно отметить, что в результате успешного выполнения S4U2Proxy запроса всегда возвращается Forwardable TGS-билет.\n \r\r\rПример содержимого сетевого трафика при ограниченном делегировании только с использованием Kerberos\r\r\rОграниченное делегирование со сменой протокола (S4U2Self и S4U2Proxy) Расширение S4U2Self (Service for User to Self) применяется, если для аутентификации клиента к сервису с ограниченным делегированием требуется использовать любой отличный от Kerberos протокол, например NTLM. В этом случае клиент проходит аутентификацию, но не может передать TGS-билет, так как протокол Kerberos не используется. S4U2Self позволяет сервису получить у контроллера домена Forwardable TGS-билет к самому себе от имени целевого пользователя.\nЧтобы учетная запись получила право на ограниченное делегирование со сменой протокола (S4U2Self) в атрибуте UserAccountControl указанной учетной записи необходимо установить флаг TRUSTED_TO_AUTH_FOR_DELEGATION, которому соответствует целочисленное значение 16777216.\n\r\r\rПример: у учетной записи \"WEB01$\" настроено ограниченное делегирование со сменой протокола\r\r\r\r\r\rСодержимое атрибутов userAccountControl, msds-allowedtodelegateto у учетной записи \"WEB01$\"\r\r\rНа примере рассмотрим механизм ограниченного делегирования со сменой протокола:\n\r\r\rИллюстрация обмена сообщений c использованием S4U2Self\r\r\r User проходит аутентификацию к Сервису А по любому отличному от Kerberos протоколу, допустим NTLM. Сервис А запрашивает у контроллера домена Forwardable TGS-билет к самому себе от имени User. Контроллер домена проверяет, что у учетной записи “Владелец А” в атрибуте UserAccountControl установлен флаг TRUSTED_TO_AUTH_FOR_AUTHENTICATION. В результате успешной проверки контроллер домена отправляет Сервису А Forwardable TGS-билет от имени User к самому Сервису А.   При неуспешной проверке, например в случае отсутствии активного флага TRUSTED_TO_AUTH_FOR_DELEGATION или если User состоит в группе “Protected Users”, в ответ будет передан TGS-билет без права передачи (Nonforwardable) для User к Сервису А.\nТаким образом билет, полученный в результате выполнения S4U2Self-запроса может отличаться наличием флага Forwardable в зависимости от настроек учетной записи и сервиса.\n В дальнейшем для получения Forwardable TGS-билет к Сервису Б от имени User используется расширение S4U2Proxy.  \r\r\rПример сетевого трафика при ограниченном делегировании с использованием любого протокола\r\r\rВажно отметить, что S4U2Self-запрос TGS-билета от имени произвольного пользователя может быть инициирован любой учетной записью, обладающей SPN, не дожидаясь аутентификации указанного пользователя.\nКлассическая атака на ограниченное делегирование Условие для проведения атаки: пароль (NT хэш) к учетной записи, обладающей правом на ограниченное делегирование со сменой протокола к определенному сервису.\nНекоторые варианты выполнения условия:\n Пароль к пользовательской учетной записи может быть получен в результате атаки Kerberoasting или подобран оффлайн в результате перехвата Net-NTLMv2 хэша Пароли (NT хэши) могут быть также извлечены из оперативной памяти сервера или рабочей станции  Результат успешной атаки: доступ с административными правами к серверу, предназначенному для функционирования сервиса к которому осуществляется делегирование.\nИдея атаки заключается в олицетворении привилегированного пользователя при обращении к сервису к которому настроено ограниченное делегирование.\nРассмотрим проведение атаки на практическом примере из лабораторной работы “Exploiting Active Directory” (доступна по платной подписке). У атакующего имеется учетная запись svcIIS со следующими настройками делегирования:\nfindDelegation.py $Domain_FQDN/$Username:$Password \r\r\rНастройки ограниченного делегирования у учетной записи svcIIS\r\r\rУ svcIIS настроено ограниченное делегирование со сменой протокола, а значит осуществлять принудительную аутентификацию нет необходимости. Также важно понимать, что для удаленного подключения зачастую требуется иметь TGS-билеты сразу к нескольким сервисам.\n\r\r\rПример соответствия способов удаленного выполнения команд и сервисов\r\r\rНастройки делегирования у svcIIS позволяют получить удаленный привилегированный доступ к THMSERVER1 при помощи службы WinRM.\nВ итоге, резюмируя выше изложенное, получается следующий порядок действия для проведения атаки:\n Запросить TGT для пользователя svcIIS С использованием полученного TGT запросить TGS-билеты к сервисам HTTP/THMSERVER1.za.tryhackme.loc и WSMAN/THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones С использованием полученных TGS-билетов подключиться к THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones при помощи PassTheTicket и WinRM  Для лучшего понимания проведем атаку двумя способами. Первый способ немного избыточный, но хорошо иллюстрирует каждый шаг по отдельности. Второй способ более автоматизированный и приближен к практике.\n“Детальный” способ (Kekeo + Windows) Запрашиваем TGT для учетной записи svcIIS:\ntgt::ask /user:$Username /domain:$Domain_FQDN /password:$Password \r\r\rПолучение TGT для svcIIS с помощью Kekeo\r\r\rЗапрашиваем TGS-билет к HTTP/THMSERVER1.za.tryhackme.loc от имени T1_Trevor.jones:\ntgs::s4u /tgt:$path_to_TGT /user:$Username /service:$SPN \r\r\rПолучение Forwardable TGS-билета от имени T1_Trevor.jones\r\r\r Аналогично запрашиваем TGS-билет к WSMAN/THMSERVER1.za.tryhackme.loc\n При помощи Mimikatz загружаем добытые TGS-билеты в LSA для PtT:\n\r\r\rPassTheTicket с Mimikatz\r\r\rДля наглядности убедимся, что билеты действительно загружены:\n\r\r\rCписок кэшированных билетов Kerberos\r\r\rСоздадим новую сессию:\n\rОсуществим вход в созданную сессию:\n\rAnySPN атака Рассмотренный выше вариант проведения атаки выглядит малоприменимым на практике, так как при его реализации требуется чтобы ограниченное делегирование было настроено к службам, соответствующим способу удаленного подключения. Тем не менее возможно обойти указанное условие с помощью ранее разобранной атаки AnySPN:\n\r\r\rПример атаки со сменой SPN\r\r\rИз представленной иллюстрации видно, что при наличии ограниченного делегирования хотя бы к одному из сервисов учетной записи, атакующий может также получить доступ к любому другому сервису указанной учетной записи.\n Тем не менее следует учитывать, что если в SPN указан порт, например, mssqlsvc\\server01.domain.local:1433, то получить TGS-билет для подменного сервиса не получится. При попытке изменить целевой SPN будет получено сообщение KDC_ERR_S_PRINCIPAL_UNKNOWN, означающее, что SPN не зарегистрирован.\n “Практический” способ (Impacket + Linux) Повторно проделаем атаку, но теперь с использованием набора скриптов Impacket. Сразу запросим TGS-билет к HTTP/THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones:\ngetST.py -spn $SPN -impersonate $ImpersonatedUsername $Domain_FQDN/$Username:$Password \r\r\rЗапрос TGS-билета\r\r\rЭкспортируем полученный TGS-билет в кэш и установим удаленное подключение, например с помощью wmiexec:\nexport KRB5CCNAME=$PathToCacheFile wmiexec.py -k -no-pass $Domain_FQDN/$ImpersonatedUsername@$TargetDnsName \r\r\rУдаленное подключение через wmiexec\r\r\rДоступ получен, атака успешно завершена.\nДля общего познания запустим ту же самую команду в режиме отладки:\n\r\r\rwmiexec в режиме отладке\r\r\rНемного мелко, но в целом видно, что wmiexec автоматически выполняет AnySPN атаку. Таким образом на практике эксплуатация классической атаки на ограниченное делегирование занимает 2.5 команды.\nПро другие атаки На ограниченное делегирование известны другие виды атак, но не все из них были описаны по различным причинам. Для ряда атак необходимо знать, как работает ограниченное делегирование на основе ресурсов, которое будет рассмотрено в будущем. Другие виды атак не пробовал на практике и писать о том, что не делал своими руками желание отсутствует. Также есть ощущение, что до эксплуатации указанных атак доходит редко, но тем не менее самостоятельно ознакомиться с ними есть смысл.\nЕсли интересно, для дальнейшего самостоятельного изучение можно посмотреть статью об атаке WriteSPN.\nТакже есть атака Double KCD описание которой представлено в презентации.\nРекомендации  Провести инвентаризацию домена на предмет наличия учетных записей с неиспользуемым настроенным ограниченным делегированием. Использовать ограниченное делегирование к определенным сервисам только при необходимости. Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию “Account is sensitive and cannot be delegated” в атрибутах указанных учетных записей. По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям. Указывать порт при создании SPN.  Используемые источники  Отличный доклад про делегацию в Kerberos: “You Do (Not) Understand Kerberos Delegation” от Daniel López Jiménez (видео и презентация) Доклад “Delegating Kerberos to bypass Kerberos delegation limitation” от Charlie Bromberg (видео и презентация) Материалы с Hacker Recipes от Charlie Bromberg (Shutdown) Статья: “Kerberos (III): How does delegation work?” от Eloy Pérez Посты из телеграмм канала “СyberSecrets” Delegate or Escalate? The Dangers of Kerberos Delegation (Jared Yeo) - презентация Delegate to the Top: Abusing Kerberos for arbitrary impersonations and RCE (Matan Hart) - доклад презентация  ","wordCount":"1408","inLanguage":"ru","image":"https://ardent101.github.io/posts/kerberos_constrained/images/logo.jpg","datePublished":"2022-09-20T09:30:03Z","dateModified":"2022-09-20T09:30:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.io/posts/kerberos_constrained/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.io/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.io/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование</h1><div class=post-meta><span title="2022-09-20 09:30:03 +0000 +0000">сентября 20, 2022</span>&nbsp;·&nbsp;7 мин&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.io/posts/kerberos_constrained/images/logo_hu76c7ec1facd090fbe01218e378efe48f_175178_360x0_resize_q75_box.jpg 360w ,https://ardent101.github.io/posts/kerberos_constrained/images/logo_hu76c7ec1facd090fbe01218e378efe48f_175178_480x0_resize_q75_box.jpg 480w ,https://ardent101.github.io/posts/kerberos_constrained/images/logo.jpg 600w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.io/posts/kerberos_constrained/images/logo.jpg alt width=600 height=691></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Оглавление</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#ограниченное-делегирование>Ограниченное делегирование</a><ul><li><a href=#ограниченное-делегирование-с-использованием-только-kerberos-s4u2proxy>Ограниченное делегирование с использованием только Kerberos (S4U2Proxy)</a></li><li><a href=#ограниченное-делегирование-со-сменой-протокола-s4u2self-и-s4u2proxy>Ограниченное делегирование со сменой протокола (S4U2Self и S4U2Proxy)</a></li><li><a href=#классическая-атака-на-ограниченное-делегирование>Классическая атака на ограниченное делегирование</a></li><li><a href=#про-другие-атаки>Про другие атаки</a></li><li><a href=#рекомендации>Рекомендации</a></li></ul></li><li><a href=#используемые-источники>Используемые источники</a></li></ul></nav></div></details></div><div class=post-content><p>В <a href=/posts/kerberos_delegation/>предыдущей части</a> были рассмотрены атаки на Active Directory, связанные с неограниченным делегированием с использованием Kerberos. Также была предоставлена небольшая теоретическая <a href=/posts/kerberos_delegation/#%D0%BE%D0%B1%D1%89%D0%B0%D1%8F-%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F>вводная</a>, которая будет полезна при прочтении настоящего материала. Теперь попробуем разобраться с атаками на ограниченное делегирование.</p><h2 id=ограниченное-делегирование>Ограниченное делегирование<a hidden class=anchor aria-hidden=true href=#ограниченное-делегирование>#</a></h2><p>Ограниченное делегирование появилось в Windows Server 2003 с целью предоставления возможности минимизировать область делегирования и тем самым повысить защищенность.</p><p>Сервис, обладающий правом на ограниченное делегирование, может обратиться к другим <strong>определенным</strong> сервисам от имени практически любого пользователя.</p><p><figure><img src=images/constrained_concept_sql.svg alt=constrained_concept><figcaption><p style=text-align:center>Общая идея ограниченного делегирования</p></figcaption></figure></p><p>Изначально протокол Kerberos не поддерживал механизм ограниченного делегирования. Для его внедрения Microsoft выпустила два новых расширения: <em>S4U2Self</em> и <em>S4U2Proxy</em>.</p><p>Для настройки ограниченного делегирования требуется наличие привилегии <em>SeEnableDelegationPrivilege</em>, которой по умолчанию обладают только учетные записи с правами уровня администратора домена.</p><h3 id=ограниченное-делегирование-с-использованием-только-kerberos-s4u2proxy>Ограниченное делегирование с использованием только Kerberos (S4U2Proxy)<a hidden class=anchor aria-hidden=true href=#ограниченное-делегирование-с-использованием-только-kerberos-s4u2proxy>#</a></h3><p>Расширение <em>S4U2Proxy</em> (Service for User to Proxy) используется, когда аутентификация клиента к сервису с ограниченным делегированием может осуществляться только по протоколу Kerberos.</p><p>Для настройки указанного вида делегирования в атрибуте <em>msds-allowedtodelegateto</em> учетной записи необходимо указать SPN при обращении к которым приведенной учетной записи требуется олицетворять других пользователей.</p><p><figure><img src=images/constrained_kerberos_only_option.png alt=kcd_ko_gui><figcaption><p style=text-align:center>Пример: у учетной записи "WEB01$" настроено ограниченное делегирование с использованием только протокола Kerberos</p></figcaption></figure></p><p><figure><img src=images/msds-allowedtodelegateto_example.png alt=kcd_ko_property><figcaption><p style=text-align:center>Содержимое атрибута msds-allowedtodelegateto у учетной записи "WEB01$"</p></figcaption></figure></p><p>Рассмотрим общую схему ограниченного делегирования с использованием только протокола Kerberos:</p><p><figure><img src=images/kerberos_only_general.svg alt=kcd_ko_scheme><figcaption><p style=text-align:center>Иллюстрация обмена сообщений в S4U2Proxy</p></figcaption></figure></p><ol><li>User стандартно получает TGS-билет с флагом Forwardable для доступа к Сервису A и отправляет его на указанный сервис.</li><li>Сервис А пересылает полученный TGS-билет на контроллер домена с целью получения доступа к Сервису Б от имени User. Как было замечено <a href=/posts/kerberos_theory/#krb_tgs_rep>ранее</a>, TGS-билет содержит имя пользователя для которого он предназначался. Таким образом Сервис А доказывает, что User действительно обращался к нему.</li><li>Контроллер домена проверяет, что атрибут <em>msds-allowedtodelegateto</em> &ldquo;Владельца А&rdquo; содержит SPN Сервиса Б и в случае успешной проверки отправляет Сервису А Forwardable TGS-билет к Сервису Б для User.</li></ol><blockquote><p>Важно отметить, что в результате успешного выполнения S4U2Proxy запроса всегда возвращается Forwardable TGS-билет.</p></blockquote><p><figure><img src=images/kcd_ko_traffic.png alt=kcd_ko_traffic><figcaption><p style=text-align:center>Пример содержимого сетевого трафика при ограниченном делегировании только с использованием Kerberos</p></figcaption></figure></p><h3 id=ограниченное-делегирование-со-сменой-протокола-s4u2self-и-s4u2proxy>Ограниченное делегирование со сменой протокола (S4U2Self и S4U2Proxy)<a hidden class=anchor aria-hidden=true href=#ограниченное-делегирование-со-сменой-протокола-s4u2self-и-s4u2proxy>#</a></h3><p>Расширение <em>S4U2Self</em> (Service for User to Self) применяется, если для аутентификации клиента к сервису с ограниченным делегированием требуется использовать любой отличный от Kerberos протокол, например NTLM. В этом случае клиент проходит аутентификацию, но не может передать TGS-билет, так как протокол Kerberos не используется. <em>S4U2Self</em> позволяет сервису получить у контроллера домена Forwardable TGS-билет к самому себе от имени целевого пользователя.</p><p>Чтобы учетная запись получила право на ограниченное делегирование со сменой протокола (<em>S4U2Self</em>) в атрибуте <em>UserAccountControl</em> указанной учетной записи необходимо установить флаг <em>TRUSTED_TO_AUTH_FOR_DELEGATION</em>, которому соответствует целочисленное значение 16777216.</p><p><figure><img src=images/kcd_ap_gui.png alt=kcd_ap_gui><figcaption><p style=text-align:center>Пример: у учетной записи "WEB01$" настроено ограниченное делегирование со сменой протокола</p></figcaption></figure></p><p><figure><img src=images/kcd_ap_property.png alt=kcd_ap_property><figcaption><p style=text-align:center>Содержимое атрибутов userAccountControl, msds-allowedtodelegateto у учетной записи "WEB01$"</p></figcaption></figure></p><p>На примере рассмотрим механизм ограниченного делегирования со сменой протокола:</p><p><figure><img src=images/KCD_AnyAuth_general.svg alt=kcd_AnyAuth_general><figcaption><p style=text-align:center>Иллюстрация обмена сообщений c использованием S4U2Self</p></figcaption></figure></p><ol><li>User проходит аутентификацию к Сервису А по любому отличному от Kerberos протоколу, допустим NTLM.</li><li>Сервис А запрашивает у контроллера домена <em>Forwardable</em> TGS-билет к самому себе от имени User.</li><li>Контроллер домена проверяет, что у учетной записи &ldquo;Владелец А&rdquo; в атрибуте <em>UserAccountControl</em> установлен флаг <em>TRUSTED_TO_AUTH_FOR_AUTHENTICATION</em>. В результате успешной проверки контроллер домена отправляет Сервису А <em>Forwardable</em> TGS-билет от имени User к самому Сервису А.</li></ol><blockquote><p>При неуспешной проверке, например в случае отсутствии активного флага <em>TRUSTED_TO_AUTH_FOR_DELEGATION</em> или если User состоит в группе &ldquo;<em>Protected Users</em>&rdquo;, в ответ будет передан TGS-билет без права передачи (<em>Nonforwardable</em>) для User к Сервису А.<br>Таким образом билет, полученный в результате выполнения S4U2Self-запроса может отличаться наличием флага <em>Forwardable</em> в зависимости от настроек учетной записи и сервиса.</p></blockquote><ol start=4><li>В дальнейшем для получения <em>Forwardable</em> TGS-билет к Сервису Б от имени User используется расширение <em>S4U2Proxy</em>.</li></ol><p><figure><img src=images/kcd_anyauth_traffic.png alt=kcd_AnyAuth_traffic><figcaption><p style=text-align:center>Пример сетевого трафика при ограниченном делегировании с использованием любого протокола</p></figcaption></figure></p><p>Важно отметить, что S4U2Self-запрос TGS-билета от имени произвольного пользователя может быть инициирован любой учетной записью, обладающей SPN, не дожидаясь аутентификации указанного пользователя.</p><h3 id=классическая-атака-на-ограниченное-делегирование>Классическая атака на ограниченное делегирование<a hidden class=anchor aria-hidden=true href=#классическая-атака-на-ограниченное-делегирование>#</a></h3><p><strong>Условие для проведения атаки</strong>: пароль (NT хэш) к учетной записи, обладающей правом на ограниченное делегирование со сменой протокола к определенному сервису.</p><p><strong>Некоторые варианты выполнения условия</strong>:</p><ul><li>Пароль к пользовательской учетной записи может быть получен в результате атаки <a href=/posts/kerberos_general_attacks/#kerberoasting>Kerberoasting</a> или подобран оффлайн в результате перехвата Net-NTLMv2 хэша</li><li>Пароли (NT хэши) могут быть также извлечены из оперативной памяти сервера или рабочей станции</li></ul><p><strong>Результат успешной атаки</strong>: доступ с административными правами к серверу, предназначенному для функционирования сервиса к которому осуществляется делегирование.</p><p>Идея атаки заключается в олицетворении привилегированного пользователя при обращении к сервису к которому настроено ограниченное делегирование.</p><p>Рассмотрим проведение атаки на практическом примере из лабораторной работы <a href=https://tryhackme.com/room/exploitingad>&ldquo;Exploiting Active Directory&rdquo;</a> (доступна по платной подписке).
У атакующего имеется учетная запись svcIIS со следующими настройками делегирования:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>findDelegation.py <span class=nv>$Domain_FQDN</span>/<span class=nv>$Username</span>:<span class=nv>$Password</span>
</span></span></code></pre></div><p><figure><img src=images/THM/findDelegation.png alt=kcd_svc_params><figcaption><p style=text-align:center>Настройки ограниченного делегирования у учетной записи svcIIS</p></figcaption></figure></p><p>У svcIIS настроено ограниченное делегирование со сменой протокола, а значит осуществлять принудительную аутентификацию нет необходимости. Также важно понимать, что для удаленного подключения зачастую требуется иметь TGS-билеты сразу к нескольким сервисам.</p><p><figure><img src=images/ticket_service_types.png alt=ticket_service><figcaption><p style=text-align:center>Пример соответствия способов удаленного выполнения команд и сервисов</p></figcaption></figure></p><p>Настройки делегирования у svcIIS позволяют получить удаленный привилегированный доступ к THMSERVER1 при помощи службы WinRM.</p><p>В итоге, резюмируя выше изложенное, получается следующий порядок действия для проведения атаки:</p><ol><li>Запросить TGT для пользователя svcIIS</li><li>С использованием полученного TGT запросить TGS-билеты к сервисам HTTP/THMSERVER1.za.tryhackme.loc и WSMAN/THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones</li><li>С использованием полученных TGS-билетов подключиться к THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones при помощи <a href=/posts/kerberos_general_attacks/#pass-the-ticket-ptt--pass-the-cache>PassTheTicket</a> и WinRM</li></ol><p>Для лучшего понимания проведем атаку двумя способами. Первый способ немного избыточный, но хорошо иллюстрирует каждый шаг по отдельности. Второй способ более автоматизированный и приближен к практике.</p><h4 id=детальный-способ-kekeo--windows>&ldquo;Детальный&rdquo; способ (Kekeo + Windows)<a hidden class=anchor aria-hidden=true href=#детальный-способ-kekeo--windows>#</a></h4><p>Запрашиваем TGT для учетной записи svcIIS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>tgt::ask /user:<span class=nv>$Username</span> /domain:<span class=nv>$Domain_FQDN</span> /password:<span class=nv>$Password</span>
</span></span></code></pre></div><p><figure><img src=images/THM/kekeo_tgt.png alt=kekeo_TGT><figcaption><p style=text-align:center>Получение TGT для svcIIS с помощью Kekeo</p></figcaption></figure></p><p>Запрашиваем TGS-билет к HTTP/THMSERVER1.za.tryhackme.loc от имени T1_Trevor.jones:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>tgs::s4u /tgt:<span class=nv>$path_to_TGT</span> /user:<span class=nv>$Username</span> /service:<span class=nv>$SPN</span>
</span></span></code></pre></div><p><figure><img src=images/THM/kekeo_ask_TGS_HTTP.png alt=kekeo_TGS><figcaption><p style=text-align:center>Получение Forwardable TGS-билета от имени T1_Trevor.jones</p></figcaption></figure></p><blockquote><p>Аналогично запрашиваем TGS-билет к WSMAN/THMSERVER1.za.tryhackme.loc</p></blockquote><p>При помощи Mimikatz загружаем добытые TGS-билеты в LSA для PtT:</p><p><figure><img src=images/THM/mimikatz_ptt.png alt=mimikatz_ptt><figcaption><p style=text-align:center>PassTheTicket с Mimikatz</p></figcaption></figure></p><p>Для наглядности убедимся, что билеты действительно загружены:</p><p><figure><img src=images/THM/klist.png alt=klist><figcaption><p style=text-align:center>Cписок кэшированных билетов Kerberos</p></figcaption></figure></p><p>Создадим новую сессию:</p><p><img src=images/THM/PSSession.png alt=newPSSesion></p><p>Осуществим вход в созданную сессию:</p><p><img src=images/THM/enterPSSession.png alt=enterPSSession></p><h4 id=anyspn-атака>AnySPN атака<a hidden class=anchor aria-hidden=true href=#anyspn-атака>#</a></h4><p>Рассмотренный выше вариант проведения атаки выглядит малоприменимым на практике, так как при его реализации требуется чтобы ограниченное делегирование было настроено к службам, соответствующим способу удаленного подключения. Тем не менее возможно обойти указанное условие с помощью ранее разобранной атаки <a href=/posts/kerberos_general_attacks/#kerberoasting--anyspn>AnySPN</a>:</p><p><figure><img src=images/kerberos_only_change_attack.svg alt=kcd_change_attack><figcaption><p style=text-align:center>Пример атаки со сменой SPN</p></figcaption></figure></p><p>Из представленной иллюстрации видно, что при наличии ограниченного делегирования хотя бы к одному из сервисов учетной записи, атакующий может также получить доступ к любому другому сервису указанной учетной записи.</p><blockquote><p>Тем не менее следует учитывать, что если в SPN указан порт, например, mssqlsvc\server01.domain.local:1433, то получить TGS-билет для подменного сервиса не получится. При попытке изменить целевой SPN будет получено сообщение KDC_ERR_S_PRINCIPAL_UNKNOWN, означающее, что SPN не зарегистрирован.</p></blockquote><h4 id=практический-способ-impacket--linux>&ldquo;Практический&rdquo; способ (Impacket + Linux)<a hidden class=anchor aria-hidden=true href=#практический-способ-impacket--linux>#</a></h4><p>Повторно проделаем атаку, но теперь с использованием набора скриптов Impacket.
Сразу запросим TGS-билет к HTTP/THMSERVER1.za.tryhackme.loc от имени привилегированного пользователя T1_Trevor.jones:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getST.py -spn <span class=nv>$SPN</span> -impersonate <span class=nv>$ImpersonatedUsername</span> <span class=nv>$Domain_FQDN</span>/<span class=nv>$Username</span>:<span class=nv>$Password</span>
</span></span></code></pre></div><p><figure><img src=images/THM/kcd_getST.PNG alt=kcd_change_attack><figcaption><p style=text-align:center>Запрос TGS-билета</p></figcaption></figure></p><p>Экспортируем полученный TGS-билет в кэш и установим удаленное подключение, например с помощью wmiexec:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KRB5CCNAME</span><span class=o>=</span><span class=nv>$PathToCacheFile</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>wmiexec.py -k -no-pass <span class=nv>$Domain_FQDN</span>/<span class=nv>$ImpersonatedUsername</span>@<span class=nv>$TargetDnsName</span>
</span></span></code></pre></div><p><figure><img src=images/THM/kcd_wmiexec_clear.PNG alt=kcd_wmiexec_clear><figcaption><p style=text-align:center>Удаленное подключение через wmiexec</p></figcaption></figure></p><p>Доступ получен, атака успешно завершена.</p><p>Для общего познания запустим ту же самую команду в режиме отладки:</p><p><figure><img src=images/THM/kcd_anyspn.PNG alt=kcd_wmiexec_debug><figcaption><p style=text-align:center>wmiexec в режиме отладке</p></figcaption></figure></p><p>Немного мелко, но в целом видно, что wmiexec автоматически выполняет AnySPN атаку. Таким образом на практике эксплуатация классической атаки на ограниченное делегирование занимает 2.5 команды.</p><h3 id=про-другие-атаки>Про другие атаки<a hidden class=anchor aria-hidden=true href=#про-другие-атаки>#</a></h3><p>На ограниченное делегирование известны другие виды атак, но не все из них были описаны по различным причинам. Для ряда атак необходимо знать, как работает ограниченное делегирование на основе ресурсов, которое будет рассмотрено в будущем. Другие виды атак не пробовал на практике и писать о том, что не делал своими руками желание отсутствует. Также есть ощущение, что до эксплуатации указанных атак доходит редко, но тем не менее самостоятельно ознакомиться с ними есть смысл.</p><p>Если интересно, для дальнейшего самостоятельного изучение можно посмотреть статью об атаке <a href=https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/>WriteSPN</a>.</p><p>Также есть атака <em>Double KCD</em> описание которой представлено в <a href="https://firebasestorage.googleapis.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-MHRw3PMJtbDDjbxm5ub%2Fuploads%2F1My6Zro1wos12oiKFvrT%2FInsomnihack%202022%20-%20Delegating%20Kerberos%20To%20Bypass%20Kerberos%20Delegation%20Limitations.pdf?alt=media&token=371ab075-79df-4725-8025-cf4be0609af9">презентации</a>.</p><h3 id=рекомендации>Рекомендации<a hidden class=anchor aria-hidden=true href=#рекомендации>#</a></h3><ul><li>Провести инвентаризацию домена на предмет наличия учетных записей с неиспользуемым настроенным ограниченным делегированием. Использовать ограниченное делегирование к определенным сервисам только при необходимости.</li><li>Добавить критически важные учетные записи домена в группу Protected Users или активировать опцию &ldquo;Account is sensitive and cannot be delegated&rdquo; в атрибутах указанных учетных записей.</li><li>По возможности назначать владельцами сервисов выделенные пользовательские учетные записи. Обеспечить сложность и периодическую сменяемость паролей к указанными учетным записям.</li><li>Указывать порт при создании SPN.</li></ul><h2 id=используемые-источники>Используемые источники<a hidden class=anchor aria-hidden=true href=#используемые-источники>#</a></h2><ul><li>Отличный доклад про делегацию в Kerberos: &ldquo;You Do (Not) Understand Kerberos Delegation&rdquo; от Daniel López Jiménez (<a href="https://www.youtube.com/watch?v=p9QFdITuvgU&list=PLwb6et4T42wwlxffjq9-F3KVDNDi9gQFs&index=1">видео</a> и <a href=https://attl4s.github.io/assets/pdf/You_do_(not)_Understand_Kerberos_Delegation.pdf>презентация</a>)</li><li>Доклад &ldquo;Delegating Kerberos to bypass Kerberos delegation limitation&rdquo; от Charlie Bromberg (<a href="https://www.youtube.com/watch?v=byykEId3FUs">видео</a> и <a href="https://firebasestorage.googleapis.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-MHRw3PMJtbDDjbxm5ub%2Fuploads%2F1My6Zro1wos12oiKFvrT%2FInsomnihack%202022%20-%20Delegating%20Kerberos%20To%20Bypass%20Kerberos%20Delegation%20Limitations.pdf?alt=media&token=371ab075-79df-4725-8025-cf4be0609af9">презентация</a>)</li><li><a href=https://www.thehacker.recipes/ad/movement/kerberos/delegations/constrained>Материалы</a> с Hacker Recipes от Charlie Bromberg (Shutdown)</li><li><a href=https://www.tarlogic.com/blog/kerberos-iii-how-does-delegation-work/>Статья</a>: &ldquo;Kerberos (III): How does delegation work?&rdquo; от Eloy Pérez</li><li>Посты из <a href=https://t.me/cyb3r53cr3t5>телеграмм канала</a> &ldquo;СyberSecrets&rdquo;</li><li>Delegate or Escalate? The Dangers of Kerberos Delegation (Jared Yeo) - <a href=https://www.aisp.sg/document/CRESTConSpeaker/Delegate_or_Escalate.pdf>презентация</a></li><li>Delegate to the Top: Abusing Kerberos for arbitrary impersonations and RCE (Matan Hart) - <a href=https://www.blackhat.com/docs/asia-17/materials/asia-17-Hart-Delegate-To-The-Top-Abusing-Kerberos-For-Arbitrary-Impersonations-And-RCE-wp.pdf>доклад</a> <a href=https://www.blackhat.com/docs/asia-17/materials/asia-17-Hart-Delegate-To-The-Top-Abusing-Kerberos-For-Arbitrary-Impersonations-And-RCE.pdf>презентация</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.io/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.io/tags/kerberos/>Kerberos</a></li><li><a href=https://ardent101.github.io/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.io/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F/>Теория</a></li><li><a href=https://ardent101.github.io/tags/%D0%B4%D0%B5%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/>Делегирование</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on twitter" href="https://twitter.com/intent/tweet/?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f&hashtags=ActiveDirectory%2cKerberos%2cPentest%2c%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f%2c%d0%94%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&summary=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&source=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on whatsapp" href="https://api.whatsapp.com/send?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5%20-%20https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 4. Ограниченное делегирование on telegram" href="https://telegram.me/share/url?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%204.%20%d0%9e%d0%b3%d1%80%d0%b0%d0%bd%d0%b8%d1%87%d0%b5%d0%bd%d0%bd%d0%be%d0%b5%20%d0%b4%d0%b5%d0%bb%d0%b5%d0%b3%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5&url=https%3a%2f%2fardent101.github.io%2fposts%2fkerberos_constrained%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://ardent101.github.io/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="копировать";function s(){e.innerText="скопировано!",setTimeout(()=>{e.innerText="копировать"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>