<!doctype html><html lang=ru dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Неприметные токены. Часть 1. Теория | Ardent101</title><meta name=keywords content="Active Directory,Токен,Pentest,Теория"><meta name=description content="Вступление В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.
Следующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:
 пароли в открытом виде NT-хэши паролей TGT MsCache v2 хеши секреты в DPAPI и др."><meta name=author content="Ardent101"><link rel=canonical href=https://ardent101.github.io/posts/tokens_theory/><link crossorigin=anonymous href=/assets/css/stylesheet.min.d6ed90c28450051e5bafcc0bf4bfe033ff2b04454909211dc9e97b8a50525621.css integrity="sha256-1u2QwoRQBR5br8wL9L/gM/8rBEVJCSEdyel7ilBSViE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://ardent101.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ardent101.github.io/static/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ardent101.github.io/static/favicon-32x32.png><link rel=apple-touch-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://ardent101.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Неприметные токены. Часть 1. Теория"><meta property="og:description" content="Вступление В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.
Следующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:
 пароли в открытом виде NT-хэши паролей TGT MsCache v2 хеши секреты в DPAPI и др."><meta property="og:type" content="article"><meta property="og:url" content="https://ardent101.github.io/posts/tokens_theory/"><meta property="og:image" content="https://ardent101.github.io/posts/tokens_theory/images/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-02T08:31:03+00:00"><meta property="article:modified_time" content="2023-03-02T08:31:03+00:00"><meta property="og:site_name" content="Ardent101"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ardent101.github.io/posts/tokens_theory/images/logo.png"><meta name=twitter:title content="Неприметные токены. Часть 1. Теория"><meta name=twitter:description content="Вступление В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.
Следующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:
 пароли в открытом виде NT-хэши паролей TGT MsCache v2 хеши секреты в DPAPI и др."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://ardent101.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Неприметные токены. Часть 1. Теория","item":"https://ardent101.github.io/posts/tokens_theory/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Неприметные токены. Часть 1. Теория","name":"Неприметные токены. Часть 1. Теория","description":"Вступление В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.\nСледующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:\n пароли в открытом виде NT-хэши паролей TGT MsCache v2 хеши секреты в DPAPI и др.","keywords":["Active Directory","Токен","Pentest","Теория"],"articleBody":"Вступление В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.\nСледующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:\n пароли в открытом виде NT-хэши паролей TGT MsCache v2 хеши секреты в DPAPI и др.  Приведенный метод неплохо изучен и хорошо себя зарекомендовал, но всегда интересно расширить свой арсенал возможностей другими подходами. Одним из таких подходов является манипулирование токенами. В предстоящей серии материалов попробую разобраться что из себя представляют токены в Windows и как они могут пригодиться для повышения привилегий.\nПервая часть содержит теорию необходимую для дальнейшего понимания материала.\nСессия пользователя Как обычно, основательно подойдем к изучению вопроса и начнем издалека. Прежде чем приступать к токенам необходимо разобраться с таким понятием, как сессия пользователя.\nБытовая аналогия Рассмотрим следующий пример - организация доступа на стадионы чемпионата мира по футболу 2018.\nПоверхностно опишем процедуру прохода:\n Каждый, кому требовалось пройти на стадион, сначала приходил в один из нескольких аккредитационных центров, где предоставлял свой паспорт и обоснование для прохода. Сотрудник аккредитационного центра проверял личность предъявителя и его обоснование, тем самым аутентифицируя его. Если личность была болельщиком, то обоснованием являлся билет на матч, если репортером, то требовалось наличие соответствующей записи в заранее согласованной базе данных. Кроме того требовалось смотреть в базу, чтобы выявлять нежелательных посетителей, входящих в черный список (пранкеры, агрессивные фанаты). Отметим, что процедуру проверки в базе данных можно считать довольно ресурсозатратной. В результате успешной проверки посетителю стадиона выдавалась аккредитация. Таким образом осуществлялась авторизация.  \r\r\rПример аккредитации\r\r\rКаждая аккредитация содержала следующую информацию:\n ФИО и фото владельца (замазаны березовым цветом) Перечень стадионов доступных для посещения Роль владельца (волонтер, обслуживающий персонал, сотрудник безопасности, журналист и т.д.) Перечень зон внутри стадиона, доступных для посещения (трибуны, раздевалки, подтрибунные помещения, микс зона и т.д.)  Каждый раз, когда посетитель стадиона пытался пройти в определенную зону, охрана осматривала его аккредитацию и принимала соответствующее решение о допуске. Аккредитация позволяла быстро идентифицировать человека, и понять какими полномочиями он обладает.\nТакже для простоты представим, что по выходу со стадиона аккредитация уничтожалась и в следующий раз процедура повторялась снова. На практике разумеется было по-другому, но для примера так лучше.\nНахождение посетителя на стадионе можно назвать сессией посетителя. Удобство заключается в том, что в рамках заданной сессии проверка личности осуществляется только один раз и нет необходимости при каждом действии заново требовать паспорт и сверять записи в базе данных.\nСессия в Windows Рассмотрим, что происходит при входе пользователя в Windows:\n Пользователь садится за компьютер и предоставляет системе свои аутентификационные данные (логин, пароль, название домена, smart карту или другие). Система передает полученную информацию в свой локальный центр безопасности (далее - LSA). LSA осуществляет аутентификацию пользователя.   Как именно это происходит выходит за рамки настоящего материала. Для желающих ознакомиться с тонкостями процедуры аутентификации ранее были написаны другие материалы, где рассматриваются принципы работы протокола Kerberos.\n В результате успешной аутентификации пользователю предоставляется сессия, позволяющая получать доступ к защищаемым объектам операционной системы при наличии соответствующих прав.  В Windows в качестве защищаемых объектов выступают совершенно различные объекты, например: файлы, именованные каналы, ключи реестра, процессы, потоки, сетевые папки, службы, устройства, объекты Active Directory и т.д.\nПользователю не требуется заново вводить свой пароль при каждом открытии файла или запуске прикладной программы. Это называется концепцией единого входа (Single Sign On - SSO), которая реализуется, в том числе с помощью механизма сессий.\nВ рамках сессии для получения доступа к защищаемому объекту пользователю необходимо обладать определенным контекстом безопасности.\n\r\r\rСвязь пользователя, сессии и контекста безопасности\r\r\rКонтекст безопасности представляет собой набор специальных атрибутов необходимых операционной системе для принятия решений о предоставлении пользователю доступа к защищаемому объекту или разрешении выполнить системную операцию.\nПод системной операцией понимается действие, требующее наличия определенной привилегии для его выполнения, например выключение системы или изменение значения счетчика времени.\nВажно отметить, что по сути контекст безопасности является своеобразной “аккредитацией” пользователя. Всякий раз, когда пользователь обращается к защищаемому объекту, система смотрит сессию пользователя и проверяет связанную с ней “аккредитацию”.\nПроцессы в Windows Пользователь использует систему для выполнения различных программ. Программа представляет собой некоторый код (набор команд и инструкций), который хранится в системе в виде файлов. Программа используется в рамках процесса.\nПроцесс - это объект операционной системы, содержащий набор ресурсов (в частности выделенный диапазон адресов виртуальной памяти) и данных используемых в ходе работы программы.\nУместно провести следующую аналогию:\n Программа - это рецепт в поваренной книге, то есть описание какого-то порядка действий, алгоритма. Процесс - это кухня, на которой работает повар, нарезаны ингредиенты, кипит кастрюля, где-то лежит листочек с рецептом, а также посуда и приборы необходимые для приготовления блюда.  Процессы позволяют системе изолировать работу программ. Таким образом исполняющая среда получается гораздо более надежной и стабильной, поскольку выход из строя одного процесса никак не сказывается на работе других процессов.\nТокены в первом приближении Что происходит, когда пользователь открывает файл в текстовом редакторе?\nСистема должна определить обладает ли процесс программы, запущенной от имени определенного пользователя, необходимыми правами доступа. Внимательный читатель может предположить, что это несложно сделать с помощью контекста безопасности, связанного с сессией пользователя.\nВ целом, так и есть, но на практике реализовано немного сложнее. Пользователь работает с множеством программ, то есть процессов. Некоторым процессам может не требоваться наличия определенных прав пользователя, например небезопасно запускать браузер с правами на просмотр различных директорий, которыми в свою очередь может обладать проводник.\nЕсли бы все процессы в рамках пользовательской сессии ссылались на один и тот же контекст безопасности, хранящийся в атрибутах указанной сессии, то изменение контекста безопасности одного процесса повлияло бы на контекст безопасности всех остальных процессов.\nРассмотренный пример, лишь один из многих иллюстрирующих, почему разработчики операционной системы Windows решили наделить каждый процесс своим собственным контекстом безопасности, который называется токеном доступа.\nПервоначально токен создается в ходе авторизации пользователя, на одном из последних этапов входа в систему. Указанный токен присваивается первому процессу, созданному для работы от имени авторизованного пользователя.\nВажно понимать, что процесс, не имеющий токена, не может существовать. В дальнейшем новые процессы по умолчанию наследуют токен доступа от родительского процесса.\nОтметим, что создать токен “вручную” нельзя. Прямой доступ к отдельным атрибутам токенов из пользовательского режима невозможен. Это сделано, во избежание несанкционированного изменения полномочий пользователя путем редактирования токенов. Только программный код, выполняющийся в режиме ядра, может получить прямой доступ к атрибутам токена (равно как и к любым другим объектам операционной системы).\n Чуть более подробно о локальном повышении привилегий в результате эксплуатации критической уязвимости с последующим выполнением кода в пространстве ядра и манипуляцией токеном доступа можно почитать здесь.\n Таким образом между пользователем, его сессией, процессами и токенами имеется следующая связь:\n\rТеперь в первом приближении можно ввести следующее определение:\nТокен доступа пользователя - объект ядра ОС Windows, описывающий контекст безопасности процесса, работающего от имени указанного пользователя.\nСинонимы: токен, токен доступа, маркер доступа, маркер безопасности.\nАтрибуты токена Перечислим некоторые основные атрибуты, содержащиеся в токене доступа пользователя:\n Идентификатор пользователя Идентификатор входа в систему (Logon ID - LUID) Перечень локальных и доменных групп, в которые входит пользователь Список привилегий, которыми обладает пользователь  \r\r\rПример отображения некоторых атрибутов токена\r\r\r Более наглядно посмотреть токены и их атрибуты можно с помощью утилиты TokenViewer\n Разумеется атрибутов гораздо больше. Для первого знакомства приведенного списка достаточно. Далее постепенно рассмотрим другие важные атрибуты, а также различные виды токенов доступа.\nУровни целостности Начиная с Windows Vista, в операционных системах семейства Windows реализован механизм мандатного контроля целостности (mandatory integrity control, MIC).\nСогласно MIC в Windows каждому защищаемому объекту операционной системы присваивается мандатная метка, соответствующая определенному уровню целостности. Физически мандатная метка представляет собой целое число. Чем больше число, тем выше уровень целостности.\nУровень целостности процесса хранится в токене указанного процесса в списке групп:\n\rВ современных версиях Windows поддерживаются следующие уровни целостности:\n   Числовой идентификатор Название Описание     0 Untrusted Используется редко, например в ходе анонимного подключения.   4096 Low Назначается процессам браузеров или контейнеров, чтобы ограничить права на запись в отношения системных файлов или ключей реестра.   8192 Medium По умолчанию назначается большинству процессов прикладных программ.   8448 Medium Plus Недокументирован.   12288 High Назначается процессам прикладных программ администратором.   16384 System Автоматически назначается всем системным процессам. Процессам прикладных программ назначаться не может.   20480 Protected Process Назначается специальным защищаемыми процессам    Основная идея мандатного контроля целостности заключается в том, что “низкоцелостные” субъекты не могут изменять “высокоцелостные” объекты.\nРассмотрим, как это используется на практике.\nТокены привилегированных учетных записей Как отмечалось ранее, токен доступа создается в результате успешной аутентификации при взаимодействии с LSA. Важный момент заключается в том, что помимо прочего LSA выполняет проверку учетной записи на предмет членства в особо привилегированных группах, например:\n Builtin Administrators Domain / Enterprise Administrators Policy Administrators Account Operators Backup Operators  а также на предмет наличия следующих “опасных” привилегий:\n SeBackupPrivilege SeCreateTokenPrivilege SeDebugPrivilege SeImpersonatePrivilege SeLabelPrivilege SeLoadDriverPrivilege SeRestorePrivilege SeTakeOwnershipPrivilege SeTcbPrivilege  Если учетная запись пользователя состоит в одной из подобных групп или обладает хотя бы одной из перечисленных привилегий, то по умолчанию LSA создает два раздельных токена:\n Полный токен (в англ. “elevated token”), содержащий все назначенные права, группы, привилегии и имеющий высокий уровень целостности. Отфильтрованный токен, в частности обладающий следующими ограничениями:  отсутствуют “опасные” привилегии присваивается средний уровень целостности    \r\r\rСравнение логона администратора и обычного пользователя\r\r\rТаким образом, полномочия процесса, выполняющегося на среднем уровне мандатной целостности от имени административной учетной записи, практически не отличаются от полномочий процесса, выполняющегося от имени непривилегированного пользователя. Это позволяет реализовать принцип минимизации полномочий без создания отдельных учетных записей для повседневной работы и для администрирования операционной системы.\n\r\r\rСодержимое токена процесса администратора, запущенного в обычном режиме\r\r\rКогда пользователю необходимо выполнить задачу, требующую повышенного токена доступа, Windows автоматически запрашивает подтверждение. Этот запрос называется запросом на повышение прав и реализуется с помощью специального компонента - UAC (User Account Control).\n\r\r\rПример оконных сообщений UAC\r\r\r\r\r\rСодержимое токена процесса, запущенного от имени администратора\r\r\r Более детальное описание механизма UAC выходит за рамки настоящего материала.\n Источники:\n Официальная документация Microsoft Better know a data source: Process integrity levels  Виды логонов Вход в Windows можно осуществить по-разному. Для простоты можно выделить следующие два типа входа (строго говоря их больше):\n Интерактивный Сетевой (неинтерактивный)  Интерактивный вход подразумевался всюду ранее. По сути это обычный вход через графическую оболочку, который например осуществляют рядовые пользователи к своим домашним персональным компьютерам или администраторы к удаленным серверам с помощью RDP.\nНо что происходит, когда пользователь пытается посмотреть содержимое удаленной сетевой папки, например с помощью следующей команды?\n\r\r\rПросмотр содержимого сетевой папки\r\r\rПользователь не может просто взять и отправить по сети свой токен удаленной системе. Действительно, токен должен быть связан с какой-то определенной сессией. Таким образом, прежде чем посмотреть содержимое сетевой папки, пользователь должен осуществить вход на удаленную систему на которой располагается эта папка. Другими словами пользователь должен аутентифицироваться к удаленной системе.\nЕсли сессия пользователя, в рамках которой запрашивается доступ к сетевой папке, создавалась с помощью интерактивного входа, то используемые для входа учетные данные пользователя были сохранены в LSASS. В этом случае система автоматически использует сохраненные учетные данные пользователя (NT хеш или TGT) для аутентификации на удаленной машине.\n Это еще один из примеров, иллюстрирующий поддержку принципа единого входа в Windows.\n Отметим, что между токеном процесса, работающего от имени определенного пользователя в рамках определенной сессии и учетными данными указанного пользователя имеется следующая связь:\n\r\r\rСвязь между токенами, различными видами сессий и учетными данными\r\r\rЕще раз отдельно отметим:\n При интерактивном входе создается интерактивная сессия и учетные данные пользователя сохраняются в LSASS. При сетевой сессии пользователь подтверждает, что обладает учетными данными, но при этом никуда их не передает. В дальнейшем в LSASS указанные учетные данные не хранятся.   Более подробно о различных видах входа и кешируемых учетных данных можно прочитать в следующих статьях “Fantastic windows logon types and where to find credentials in them”, “Network vs Interactive Logons”.\n Теперь рассмотрим, что происходит с другой стороны в удаленной системе.\nСетевая папка по сути является сервисом, предоставляемым некоторым SMB сервером. Процесс “SMB сервера” обрабатывает запрос на аутентификацию и передает полученные учетные данные в LSA, где проверяется их подлинность. Самое интересное, что происходит в результате успешной аутентификации пользователя, запрашивающего просмотр содержимого сетевой папки.\nПроцесс “SMB сервера” работает от имени и с правами псевдопользователя SYSTEM. Предоставление прав системы всякому аутентифицированному к SMB серверу пользователю однозначно избыточно. Более того указанный пользователь может обладать доступом не ко всему содержимому сетевой папки.\nТо есть, процессу “SMB сервера” было бы очень удобно как-то работать от имени своих клиентов. В Windows такой механизм предусмотрен и называется олицетворением (англ. Impersonation).\nОлицетворение До этого уже немного была затронута тема процессов в операционной системе Windows. Теперь расширим это понятие. У каждого процесса есть как минимум один поток, выделяемый при создании процесса (как правило, на практике потоков больше). Этот поток может породить другие потоки, те в свою очередь новые и т.д.\nРассматриваемый всюду ранее токен доступа, назначаемый процессу операционной системы при его создании, называется первоначальным токеном или токеном процесса (англ. primary token).\nПо умолчанию первоначальный токен наследуется дочерними потоками, но существует механизм олицетворения, который позволяет процессу назначать дочерним потокам специальные токены, отличающиеся от первоначального токена.\nТокен потока, применяемый для заимствования контекста безопасности другого пользователя, называется олицетворяющим токеном (англ. impersonation token).\nТаким образом появляется еще одна классификация токена: первоначальный или олицетворяющий.\nВ связи изложенным можно уточнить определение токена:\nТокен доступа пользователя - объект ядра ОС Windows, описывающий контекст безопасности процессов или потоков, работающих от имени указанного пользователя.\nSMB сервер представляет собой многопоточное приложение. Сервер обслуживает каждого клиента в рамках соответствующего выделенного потока, обладающего токеном, олицетворяющим указанного клиента.\n\r\r\rВыдача олицетворяющего токена при сетевом входе\r\r\rВ данном случае олицетворяющий токен также будет связан с сессией, возникшей в результате сетевого входа.\n\r\r\rАутентификации при сетевом входе\r\r\rЕще раз обратим внимание, что токен доступа не содержит в себе никаких учетных данных пользователя. По сути токен используется для идентификации пользователя, так как в нем хранится информация о группах и привилегиях. На основе этой информации принимается решение о предоставлении доступа к защищаемым объектам. Вспомните аналогию с аккредитационной картой. Аккредитация не аутентифицирует, но дает возможность быстро понять куда разрешен доступ.\nУровни олицетворения Олицетворяющие токены имеют следующую важную характеристику - уровень олицетворения, который отражает степень того, насколько сервер может олицетворять клиента. Всего существуют следующие четыре уровня олицетворения:\n   Название Описание     Anonymous Удаленный сервер не может идентифицировать или олицетворять клиента. Используется для анонимного подключения.   Identification Удаленный сервер может идентифицировать, но не может олицетворять клиента.   Impersonation Удаленный сервер может идентифицировать и олицетворять клиента локально в системе. Подобные токены обычно создаются в результате сетевого входа, например при доступе к FTP серверу.   Delegation Удаленный сервер может идентифицировать и олицетворять клиента в удаленных системах. Подобные токены обычно создаются в результате интерактивного входа, например по RDP.    Классификации токенов Обобщая написанное выше, получается, что токен:\n Содержит перечень групп и привилегий пользователя Может быть полным, а может быть фильтрованным Может быть связан с интерактивной или неинтерактивной сессией, то есть иметь связь с учетными данными или не иметь Может быть первоначальным, а может быть олицетворяющим. Если токен олицетворяющий, то он обладает одним из четырех уровней олицетворения  Заключение В настоящей статье было рассмотрено устройство токенов доступа в Windows. Был представлен обзор основных атрибутов по которым можно классифицировать токены, а также рассказано о связи токенов, сессий и аутентификационных данных. Изложенные сведения полезны для понимания атак, связанных с манипуляциями токенами.\nИспользуемые источники Статьи и презентации из сети Интернет:\n Introduction to Windows tokens for security practitioners How attackers abuse Access Token Manipulation (ATT\u0026CK T1134) Privilege escalation through Token Manipulation Официальная документация Microsoft A Process is No One Hunting for Token Manipulation Abusing Windows’ tokens to compromise Active Directory without touching LSASS Security Implications of Windows Access Tokens – A Penetration Tester’s Guide Understanding Windows Lateral Movements  Книги:\n “Защита в операционных системах” - Проскурин В.Г. Programming Windows Security - Keith Brown Windows Internals Pt. 1 - Pavel Yosifovich, Alex Ionescu, Mark Russinovich and David Solomon  ","wordCount":"2520","inLanguage":"ru","image":"https://ardent101.github.io/posts/tokens_theory/images/logo.png","datePublished":"2023-03-02T08:31:03Z","dateModified":"2023-03-02T08:31:03Z","author":{"@type":"Person","name":"Ardent101"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ardent101.github.io/posts/tokens_theory/"},"publisher":{"@type":"Organization","name":"Ardent101","logo":{"@type":"ImageObject","url":"https://ardent101.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ardent101.github.io/ accesskey=h title="Главная (Alt + H)"><img src=https://ardent101.github.io/apple-touch-icon.png alt=logo aria-label=logo height=35>Главная</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://ardent101.github.io/archives/ title=Архив><span>Архив</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Неприметные токены. Часть 1. Теория</h1><div class=post-meta><span title="2023-03-02 08:31:03 +0000 +0000">марта 2, 2023</span>&nbsp;·&nbsp;12 мин&nbsp;·&nbsp;Ardent101</div></header><figure class=entry-cover><img loading=lazy srcset="https://ardent101.github.io/posts/tokens_theory/images/logo_hu29e34afcedc152b9b4c47e0166b9c1f8_1105883_360x0_resize_box_3.png 360w ,https://ardent101.github.io/posts/tokens_theory/images/logo_hu29e34afcedc152b9b4c47e0166b9c1f8_1105883_480x0_resize_box_3.png 480w ,https://ardent101.github.io/posts/tokens_theory/images/logo_hu29e34afcedc152b9b4c47e0166b9c1f8_1105883_720x0_resize_box_3.png 720w ,https://ardent101.github.io/posts/tokens_theory/images/logo_hu29e34afcedc152b9b4c47e0166b9c1f8_1105883_1080x0_resize_box_3.png 1080w ,https://ardent101.github.io/posts/tokens_theory/images/logo.png 1198w" sizes="(min-width: 768px) 720px, 100vw" src=https://ardent101.github.io/posts/tokens_theory/images/logo.png alt width=1198 height=670></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Оглавление</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#вступление>Вступление</a></li><li><a href=#сессия-пользователя>Сессия пользователя</a><ul><li><a href=#бытовая-аналогия>Бытовая аналогия</a></li><li><a href=#сессия-в-windows>Сессия в Windows</a></li></ul></li><li><a href=#процессы-в-windows>Процессы в Windows</a></li><li><a href=#токены-в-первом-приближении>Токены в первом приближении</a><ul><li><a href=#атрибуты-токена>Атрибуты токена</a></li><li><a href=#уровни-целостности>Уровни целостности</a></li><li><a href=#токены-привилегированных-учетных-записей>Токены привилегированных учетных записей</a></li></ul></li><li><a href=#виды-логонов>Виды логонов</a><ul><li><a href=#олицетворение>Олицетворение</a></li><li><a href=#уровни-олицетворения>Уровни олицетворения</a></li></ul></li><li><a href=#классификации-токенов>Классификации токенов</a></li><li><a href=#заключение>Заключение</a></li><li><a href=#используемые-источники>Используемые источники</a></li></ul></nav></div></details></div><div class=post-content><h2 id=вступление>Вступление<a hidden class=anchor aria-hidden=true href=#вступление>#</a></h2><p>В ходе тестирования на проникновение нередко удается получить доступ с правами уровня локального администратора к какому-то сетевому объекту, функционирующему под управлением операционной системы семейства Windows.</p><p>Следующим этапом, как правило, является повышение привилегий до администратора домена. Существует множество способов пост эксплуатации конечной системы при наличии к ней административного доступа. Наиболее перспективным методом представляется поиск учетных данных, таких как:</p><ul><li>пароли в открытом виде</li><li>NT-хэши паролей</li><li>TGT</li><li>MsCache v2 хеши</li><li>секреты в DPAPI и др.</li></ul><p>Приведенный метод неплохо изучен и хорошо себя зарекомендовал, но всегда интересно расширить свой арсенал возможностей другими подходами. Одним из таких подходов является манипулирование токенами. В предстоящей серии материалов попробую разобраться что из себя представляют токены в Windows и как они могут пригодиться для повышения привилегий.</p><p>Первая часть содержит теорию необходимую для дальнейшего понимания материала.</p><h2 id=сессия-пользователя>Сессия пользователя<a hidden class=anchor aria-hidden=true href=#сессия-пользователя>#</a></h2><p>Как обычно, основательно подойдем к изучению вопроса и начнем издалека. Прежде чем приступать к токенам необходимо разобраться с таким понятием, как сессия пользователя.</p><h3 id=бытовая-аналогия>Бытовая аналогия<a hidden class=anchor aria-hidden=true href=#бытовая-аналогия>#</a></h3><p>Рассмотрим следующий пример - организация доступа на стадионы чемпионата мира по футболу 2018.</p><p>Поверхностно опишем процедуру прохода:</p><ol><li>Каждый, кому требовалось пройти на стадион, сначала приходил в один из нескольких аккредитационных центров, где предоставлял свой паспорт и обоснование для прохода.</li><li>Сотрудник аккредитационного центра проверял личность предъявителя и его обоснование, тем самым аутентифицируя его. Если личность была болельщиком, то обоснованием являлся билет на матч, если репортером, то требовалось наличие соответствующей записи в заранее согласованной базе данных. Кроме того требовалось смотреть в базу, чтобы выявлять нежелательных посетителей, входящих в черный список (пранкеры, агрессивные фанаты). Отметим, что процедуру проверки в базе данных можно считать довольно ресурсозатратной.</li><li>В результате успешной проверки посетителю стадиона выдавалась аккредитация. Таким образом осуществлялась авторизация.</li></ol><p><figure><img src=images/FifaCard.png alt=card_example><figcaption><p style=text-align:center>Пример аккредитации</p></figcaption></figure></p><p>Каждая аккредитация содержала следующую информацию:</p><ul><li>ФИО и фото владельца (замазаны березовым цветом)</li><li>Перечень стадионов доступных для посещения</li><li>Роль владельца (волонтер, обслуживающий персонал, сотрудник безопасности, журналист и т.д.)</li><li>Перечень зон внутри стадиона, доступных для посещения (трибуны, раздевалки, подтрибунные помещения, микс зона и т.д.)</li></ul><p>Каждый раз, когда посетитель стадиона пытался пройти в определенную зону, охрана осматривала его аккредитацию и принимала соответствующее решение о допуске. Аккредитация позволяла быстро идентифицировать человека, и понять какими полномочиями он обладает.</p><p>Также для простоты представим, что по выходу со стадиона аккредитация уничтожалась и в следующий раз процедура повторялась снова. На практике разумеется было по-другому, но для примера так лучше.</p><p>Нахождение посетителя на стадионе можно назвать сессией посетителя. Удобство заключается в том, что в рамках заданной сессии проверка личности осуществляется только один раз и нет необходимости при каждом действии заново требовать паспорт и сверять записи в базе данных.</p><h3 id=сессия-в-windows>Сессия в Windows<a hidden class=anchor aria-hidden=true href=#сессия-в-windows>#</a></h3><p>Рассмотрим, что происходит при входе пользователя в Windows:</p><ol><li>Пользователь садится за компьютер и предоставляет системе свои аутентификационные данные (логин, пароль, название домена, smart карту или другие).</li><li>Система передает полученную информацию в свой локальный центр безопасности (далее - LSA).</li><li>LSA осуществляет аутентификацию пользователя.</li></ol><blockquote><p>Как именно это происходит выходит за рамки настоящего материала. Для желающих ознакомиться с тонкостями процедуры аутентификации ранее были написаны другие <a href=https://ardent101.github.io/posts/kerberos_theory/#%D0%B4%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8F-%D0%BA-%D1%80%D0%B0%D0%B1%D0%BE%D1%87%D0%B5%D0%B9-%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B8-%D0%B2-active-directory>материалы</a>, где рассматриваются принципы работы протокола Kerberos.</p></blockquote><ol start=4><li>В результате успешной аутентификации пользователю предоставляется сессия, позволяющая получать доступ к защищаемым объектам операционной системы при наличии соответствующих прав.</li></ol><p>В Windows в качестве защищаемых объектов выступают совершенно различные объекты, например: файлы, именованные каналы, ключи реестра, процессы, потоки, сетевые папки, службы, устройства, объекты Active Directory и т.д.</p><p>Пользователю не требуется заново вводить свой пароль при каждом открытии файла или запуске прикладной программы. Это называется концепцией единого входа (Single Sign On - SSO), которая реализуется, в том числе с помощью механизма сессий.</p><p>В рамках сессии для получения доступа к защищаемому объекту пользователю необходимо обладать определенным контекстом безопасности.</p><p><figure><img src=images/User_Session_Context.png alt=User_Session_Context><figcaption><p style=text-align:center>Связь пользователя, сессии и контекста безопасности</p></figcaption></figure></p><p>Контекст безопасности представляет собой набор специальных атрибутов необходимых операционной системе для принятия решений о предоставлении пользователю доступа к защищаемому объекту или разрешении выполнить системную операцию.</p><p>Под системной операцией понимается действие, требующее наличия определенной привилегии для его выполнения, например выключение системы или изменение значения счетчика времени.</p><p>Важно отметить, что по сути контекст безопасности является своеобразной &ldquo;аккредитацией&rdquo; пользователя. Всякий раз, когда пользователь обращается к защищаемому объекту, система смотрит сессию пользователя и проверяет связанную с ней &ldquo;аккредитацию&rdquo;.</p><h2 id=процессы-в-windows>Процессы в Windows<a hidden class=anchor aria-hidden=true href=#процессы-в-windows>#</a></h2><p>Пользователь использует систему для выполнения различных программ. Программа представляет собой некоторый код (набор команд и инструкций), который хранится в системе в виде файлов. Программа используется в рамках процесса.</p><p>Процесс - это объект операционной системы, содержащий набор ресурсов (в частности выделенный диапазон адресов виртуальной памяти) и данных используемых в ходе работы программы.</p><p>Уместно провести следующую аналогию:</p><ul><li>Программа - это рецепт в поваренной книге, то есть описание какого-то порядка действий, алгоритма.</li><li>Процесс - это кухня, на которой работает повар, нарезаны ингредиенты, кипит кастрюля, где-то лежит листочек с рецептом, а также посуда и приборы необходимые для приготовления блюда.</li></ul><p>Процессы позволяют системе изолировать работу программ. Таким образом исполняющая среда получается гораздо более надежной и стабильной, поскольку выход из строя одного процесса никак не сказывается на работе других процессов.</p><h2 id=токены-в-первом-приближении>Токены в первом приближении<a hidden class=anchor aria-hidden=true href=#токены-в-первом-приближении>#</a></h2><p>Что происходит, когда пользователь открывает файл в текстовом редакторе?</p><p>Система должна определить обладает ли процесс программы, запущенной от имени определенного пользователя, необходимыми правами доступа. Внимательный читатель может предположить, что это несложно сделать с помощью контекста безопасности, связанного с сессией пользователя.</p><p>В целом, так и есть, но на практике реализовано немного сложнее. Пользователь работает с множеством программ, то есть процессов. Некоторым процессам может не требоваться наличия определенных прав пользователя, например небезопасно запускать браузер с правами на просмотр различных директорий, которыми в свою очередь может обладать проводник.</p><p>Если бы все процессы в рамках пользовательской сессии ссылались на один и тот же контекст безопасности, хранящийся в атрибутах указанной сессии, то изменение контекста безопасности одного процесса повлияло бы на контекст безопасности всех остальных процессов.</p><p>Рассмотренный пример, лишь один из многих иллюстрирующих, почему разработчики операционной системы Windows решили наделить каждый процесс своим собственным контекстом безопасности, который называется токеном доступа.</p><p>Первоначально токен создается в ходе авторизации пользователя, на одном из последних этапов входа в систему. Указанный токен присваивается первому процессу, созданному для работы от имени авторизованного пользователя.</p><p>Важно понимать, что процесс, не имеющий токена, не может существовать.
В дальнейшем новые процессы по умолчанию наследуют токен доступа от родительского процесса.</p><p>Отметим, что создать токен &ldquo;вручную&rdquo; нельзя. Прямой доступ к отдельным атрибутам токенов из пользовательского режима невозможен. Это сделано, во избежание несанкционированного изменения полномочий пользователя путем редактирования токенов. Только программный код, выполняющийся в режиме ядра, может получить прямой доступ к атрибутам токена (равно как и к любым другим объектам операционной системы).</p><blockquote><p>Чуть более подробно о локальном повышении привилегий в результате эксплуатации критической уязвимости с последующим выполнением кода в пространстве ядра и манипуляцией токеном доступа можно почитать <a href=https://habr.com/ru/company/otus/blog/530596/>здесь</a>.</p></blockquote><p>Таким образом между пользователем, его сессией, процессами и токенами имеется следующая связь:</p><p><img src=images/Token-Process-Session_restricted.png alt=Token-Process-Session_restricted></p><p>Теперь в первом приближении можно ввести следующее определение:</p><p><em><strong>Токен доступа пользователя</strong></em> - объект ядра ОС Windows, описывающий контекст безопасности процесса, работающего от имени указанного пользователя.</p><p>Синонимы: токен, токен доступа, маркер доступа, маркер безопасности.</p><h3 id=атрибуты-токена>Атрибуты токена<a hidden class=anchor aria-hidden=true href=#атрибуты-токена>#</a></h3><p>Перечислим некоторые основные атрибуты, содержащиеся в токене доступа пользователя:</p><ul><li>Идентификатор пользователя</li><li>Идентификатор входа в систему (Logon ID - LUID)</li><li>Перечень локальных и доменных групп, в которые входит пользователь</li><li>Список привилегий, которыми обладает пользователь</li></ul><p><figure><img src=images/process_token_properties.png alt=process_token_properties><figcaption><p style=text-align:center>Пример отображения некоторых атрибутов токена</p></figcaption></figure></p><blockquote><p>Более наглядно посмотреть токены и их атрибуты можно с помощью утилиты <a href=https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools>TokenViewer</a></p></blockquote><p>Разумеется атрибутов гораздо больше. Для первого знакомства приведенного списка достаточно. Далее постепенно рассмотрим другие важные атрибуты, а также различные виды токенов доступа.</p><h3 id=уровни-целостности>Уровни целостности<a hidden class=anchor aria-hidden=true href=#уровни-целостности>#</a></h3><p>Начиная с Windows Vista, в операционных системах семейства Windows реализован механизм мандатного контроля целостности (mandatory integrity control, MIC).</p><p>Согласно MIC в Windows каждому защищаемому объекту операционной системы присваивается мандатная метка, соответствующая определенному уровню целостности. Физически мандатная метка представляет собой целое число. Чем больше число, тем выше уровень целостности.</p><p>Уровень целостности процесса хранится в токене указанного процесса в списке групп:</p><p><img src=images/integrity_level.png alt=integrity_levels></p><p>В современных версиях Windows поддерживаются следующие уровни целостности:</p><table><thead><tr><th>Числовой идентификатор</th><th>Название</th><th>Описание</th></tr></thead><tbody><tr><td>0</td><td>Untrusted</td><td>Используется редко, например в ходе анонимного подключения.</td></tr><tr><td>4096</td><td>Low</td><td>Назначается процессам браузеров или контейнеров, чтобы ограничить права на запись в отношения системных файлов или ключей реестра.</td></tr><tr><td>8192</td><td>Medium</td><td>По умолчанию назначается большинству процессов прикладных программ.</td></tr><tr><td>8448</td><td>Medium Plus</td><td>Недокументирован.</td></tr><tr><td>12288</td><td>High</td><td>Назначается процессам прикладных программ администратором.</td></tr><tr><td>16384</td><td>System</td><td>Автоматически назначается всем системным процессам. Процессам прикладных программ назначаться не может.</td></tr><tr><td>20480</td><td>Protected Process</td><td>Назначается специальным защищаемыми процессам</td></tr></tbody></table><p>Основная идея мандатного контроля целостности заключается в том, что &ldquo;низкоцелостные&rdquo; субъекты не могут изменять &ldquo;высокоцелостные&rdquo; объекты.</p><p>Рассмотрим, как это используется на практике.</p><h3 id=токены-привилегированных-учетных-записей>Токены привилегированных учетных записей<a hidden class=anchor aria-hidden=true href=#токены-привилегированных-учетных-записей>#</a></h3><p>Как отмечалось ранее, токен доступа создается в результате успешной аутентификации при взаимодействии с LSA. Важный момент заключается в том, что помимо прочего LSA выполняет проверку учетной записи на предмет членства в особо привилегированных группах, например:</p><ul><li>Builtin Administrators</li><li>Domain / Enterprise Administrators</li><li>Policy Administrators</li><li>Account Operators</li><li>Backup Operators</li></ul><p>а также на предмет наличия следующих &ldquo;опасных&rdquo; привилегий:</p><ul><li>SeBackupPrivilege</li><li>SeCreateTokenPrivilege</li><li>SeDebugPrivilege</li><li>SeImpersonatePrivilege</li><li>SeLabelPrivilege</li><li>SeLoadDriverPrivilege</li><li>SeRestorePrivilege</li><li>SeTakeOwnershipPrivilege</li><li>SeTcbPrivilege</li></ul><p>Если учетная запись пользователя состоит в одной из подобных групп или обладает хотя бы одной из перечисленных привилегий, то по умолчанию LSA создает два раздельных токена:</p><ol><li>Полный токен (в англ. &ldquo;elevated token&rdquo;), содержащий все назначенные права, группы, привилегии и имеющий высокий уровень целостности.</li><li>Отфильтрованный токен, в частности обладающий следующими ограничениями:<ul><li>отсутствуют &ldquo;опасные&rdquo; привилегии</li><li>присваивается средний уровень целостности</li></ul></li></ol><p><figure><img src=images/uacwindowslogonprocess.gif alt=uacwindowslogonprocess><figcaption><p style=text-align:center>Сравнение логона администратора и обычного пользователя</p></figcaption></figure></p><p>Таким образом, полномочия процесса, выполняющегося на среднем уровне мандатной целостности от имени административной учетной записи, практически не отличаются от полномочий процесса, выполняющегося от имени непривилегированного пользователя. Это позволяет реализовать принцип минимизации полномочий без создания отдельных учетных записей для повседневной работы и для администрирования операционной системы.</p><p><figure><img src=images/cmd_medium.png alt=cmd_medium><figcaption><p style=text-align:center>Содержимое токена процесса администратора, запущенного в обычном режиме</p></figcaption></figure></p><p>Когда пользователю необходимо выполнить задачу, требующую повышенного токена доступа, Windows автоматически запрашивает подтверждение. Этот запрос называется запросом на повышение прав и реализуется с помощью специального компонента - UAC (User Account Control).</p><p><figure><img src=images/UAC_Prompt.png alt=uac_prompt><figcaption><p style=text-align:center>Пример оконных сообщений UAC</p></figcaption></figure></p><p><figure><img src=images/cmd_high.png alt=cmd_high><figcaption><p style=text-align:center>Содержимое токена процесса, запущенного от имени администратора</p></figcaption></figure></p><blockquote><p>Более детальное описание механизма UAC выходит за рамки настоящего материала.</p></blockquote><p>Источники:</p><ul><li><a href=https://learn.microsoft.com/ru-ru/windows/security/identity-protection/user-account-control/how-user-account-control-works>Официальная документация Microsoft</a></li><li><a href=https://redcanary.com/blog/process-integrity-levels/>Better know a data source: Process integrity levels</a></li></ul><h2 id=виды-логонов>Виды логонов<a hidden class=anchor aria-hidden=true href=#виды-логонов>#</a></h2><p>Вход в Windows можно осуществить по-разному. Для простоты можно выделить следующие два типа входа (строго говоря их больше):</p><ul><li>Интерактивный</li><li>Сетевой (неинтерактивный)</li></ul><p>Интерактивный вход подразумевался всюду ранее. По сути это обычный вход через графическую оболочку, который например осуществляют рядовые пользователи к своим домашним персональным компьютерам или администраторы к удаленным серверам с помощью RDP.</p><p>Но что происходит, когда пользователь пытается посмотреть содержимое удаленной сетевой папки, например с помощью следующей команды?</p><p><figure><img src=images/share_view.png alt=share_view><figcaption><p style=text-align:center>Просмотр содержимого сетевой папки</p></figcaption></figure></p><p>Пользователь не может просто взять и отправить по сети свой токен удаленной системе. Действительно, токен должен быть связан с какой-то определенной сессией. Таким образом, прежде чем посмотреть содержимое сетевой папки, пользователь должен осуществить вход на удаленную систему на которой располагается эта папка. Другими словами пользователь должен аутентифицироваться к удаленной системе.</p><p>Если сессия пользователя, в рамках которой запрашивается доступ к сетевой папке, создавалась с помощью интерактивного входа, то используемые для входа учетные данные пользователя были сохранены в LSASS. В этом случае система автоматически использует сохраненные учетные данные пользователя (NT хеш или TGT) для аутентификации на удаленной машине.</p><blockquote><p>Это еще один из примеров, иллюстрирующий поддержку принципа единого входа в Windows.</p></blockquote><p>Отметим, что между токеном процесса, работающего от имени определенного пользователя в рамках определенной сессии и учетными данными указанного пользователя имеется следующая связь:</p><p><figure><img src=images/LogonTypes.png alt=LogonTypes><figcaption><p style=text-align:center>Связь между токенами, различными видами сессий и учетными данными</p></figcaption></figure></p><p>Еще раз отдельно отметим:</p><ul><li>При интерактивном входе создается интерактивная сессия и учетные данные пользователя сохраняются в LSASS.</li><li>При сетевой сессии пользователь подтверждает, что обладает учетными данными, но при этом никуда их не передает. В дальнейшем в LSASS указанные учетные данные не хранятся.</li></ul><blockquote><p>Более подробно о различных видах входа и кешируемых учетных данных можно прочитать в следующих статьях <a href=https://www.alteredsecurity.com/post/fantastic-windows-logon-types-and-where-to-find-credentials-in-them#viewer-5t3rc>&ldquo;Fantastic windows logon types and where to find credentials in them&rdquo;</a>, <a href=https://www.ired.team/offensive-security/credential-access-and-credential-dumping/network-vs-interactive-logons>&ldquo;Network vs Interactive Logons&rdquo;</a>.</p></blockquote><p>Теперь рассмотрим, что происходит с другой стороны в удаленной системе.</p><p>Сетевая папка по сути является сервисом, предоставляемым некоторым SMB сервером. Процесс &ldquo;SMB сервера&rdquo; обрабатывает запрос на аутентификацию и передает полученные учетные данные в LSA, где проверяется их подлинность. Самое интересное, что происходит в результате успешной аутентификации пользователя, запрашивающего просмотр содержимого сетевой папки.</p><p>Процесс &ldquo;SMB сервера&rdquo; работает от имени и с правами псевдопользователя SYSTEM. Предоставление прав системы всякому аутентифицированному к SMB серверу пользователю однозначно избыточно. Более того указанный пользователь может обладать доступом не ко всему содержимому сетевой папки.</p><p>То есть, процессу &ldquo;SMB сервера&rdquo; было бы очень удобно как-то работать от имени своих клиентов. В Windows такой механизм предусмотрен и называется олицетворением (англ. Impersonation).</p><h3 id=олицетворение>Олицетворение<a hidden class=anchor aria-hidden=true href=#олицетворение>#</a></h3><p>До этого уже немного была затронута тема процессов в операционной системе Windows. Теперь расширим это понятие. У каждого процесса есть как минимум один поток, выделяемый при создании процесса (как правило, на практике потоков больше).
Этот поток может породить другие потоки, те в свою очередь новые и т.д.</p><p>Рассматриваемый всюду ранее токен доступа, назначаемый процессу операционной системы при его создании, называется первоначальным токеном или токеном процесса (англ. primary token).</p><p>По умолчанию первоначальный токен наследуется дочерними потоками, но существует механизм олицетворения, который позволяет процессу назначать дочерним потокам специальные токены, отличающиеся от первоначального токена.</p><p>Токен потока, применяемый для заимствования контекста безопасности другого пользователя, называется олицетворяющим токеном (англ. impersonation token).</p><p>Таким образом появляется еще одна классификация токена: первоначальный или олицетворяющий.</p><p>В связи изложенным можно уточнить определение токена:</p><p><em><strong>Токен доступа пользователя</strong></em> - объект ядра ОС Windows, описывающий контекст безопасности процессов или потоков, работающих от имени указанного пользователя.</p><p>SMB сервер представляет собой многопоточное приложение. Сервер обслуживает каждого клиента в рамках соответствующего выделенного потока, обладающего токеном, олицетворяющим указанного клиента.</p><p><figure><img src=images/remote_logon.png alt=remote_logon><figcaption><p style=text-align:center>Выдача олицетворяющего токена при сетевом входе</p></figcaption></figure></p><p>В данном случае олицетворяющий токен также будет связан с сессией, возникшей в результате сетевого входа.</p><p><figure><img src=images/network_logon_impersonation_token.png alt=network_logon_impersonation_token><figcaption><p style=text-align:center>Аутентификации при сетевом входе</p></figcaption></figure></p><p>Еще раз обратим внимание, что токен доступа не содержит в себе никаких учетных данных пользователя. По сути токен используется для идентификации пользователя, так как в нем хранится информация о группах и привилегиях. На основе этой информации принимается решение о предоставлении доступа к защищаемым объектам. Вспомните аналогию с аккредитационной картой. Аккредитация не аутентифицирует, но дает возможность быстро понять куда разрешен доступ.</p><h3 id=уровни-олицетворения>Уровни олицетворения<a hidden class=anchor aria-hidden=true href=#уровни-олицетворения>#</a></h3><p>Олицетворяющие токены имеют следующую важную характеристику - уровень олицетворения, который отражает степень того, насколько сервер может олицетворять клиента. Всего существуют следующие четыре уровня олицетворения:</p><table><thead><tr><th>Название</th><th>Описание</th></tr></thead><tbody><tr><td><strong>Anonymous</strong></td><td>Удаленный сервер не может идентифицировать или олицетворять клиента. Используется для анонимного подключения.</td></tr><tr><td><strong>Identification</strong></td><td>Удаленный сервер может идентифицировать, но не может олицетворять клиента.</td></tr><tr><td><strong>Impersonation</strong></td><td>Удаленный сервер может идентифицировать и олицетворять клиента локально в системе. Подобные токены обычно создаются в результате сетевого входа, например при доступе к FTP серверу.</td></tr><tr><td><strong>Delegation</strong></td><td>Удаленный сервер может идентифицировать и олицетворять клиента в удаленных системах. Подобные токены обычно создаются в результате интерактивного входа, например по RDP.</td></tr></tbody></table><h2 id=классификации-токенов>Классификации токенов<a hidden class=anchor aria-hidden=true href=#классификации-токенов>#</a></h2><p>Обобщая написанное выше, получается, что токен:</p><ol><li>Содержит перечень групп и привилегий пользователя</li><li>Может быть полным, а может быть фильтрованным</li><li>Может быть связан с интерактивной или неинтерактивной сессией, то есть иметь связь с учетными данными или не иметь</li><li>Может быть первоначальным, а может быть олицетворяющим. Если токен олицетворяющий, то он обладает одним из четырех уровней олицетворения</li></ol><h2 id=заключение>Заключение<a hidden class=anchor aria-hidden=true href=#заключение>#</a></h2><p>В настоящей статье было рассмотрено устройство токенов доступа в Windows. Был представлен обзор основных атрибутов по которым можно классифицировать токены, а также рассказано о связи токенов, сессий и аутентификационных данных. Изложенные сведения полезны для понимания атак, связанных с манипуляциями токенами.</p><h2 id=используемые-источники>Используемые источники<a hidden class=anchor aria-hidden=true href=#используемые-источники>#</a></h2><p>Статьи и презентации из сети Интернет:</p><ul><li><a href=https://www.elastic.co/blog/introduction-to-windows-tokens-for-security-practitioners>Introduction to Windows tokens for security practitioners</a></li><li><a href=https://www.elastic.co/blog/how-attackers-abuse-access-token-manipulation>How attackers abuse Access Token Manipulation (ATT&CK T1134)</a></li><li><a href=https://web.archive.org/web/20200222172112/https://hacknpentest.com/privilege-escalation-through-token-manipulation/>Privilege escalation through Token Manipulation</a></li><li><a href=https://learn.microsoft.com/ru-ru/windows/win32/secauthz/access-tokens>Официальная документация Microsoft</a></li><li><a href=https://www.blackhat.com/docs/eu-17/materials/eu-17-Atkinson-A-Process-Is-No-One-Hunting-For-Token-Manipulation-wp.pdf>A Process is No One Hunting for Token Manipulation</a></li><li><a href=https://sensepost.com/blog/2022/abusing-windows-tokens-to-compromise-active-directory-without-touching-lsass/>Abusing Windows’ tokens to compromise Active Directory without touching LSASS</a></li><li><a href=https://labs.withsecure.com/content/dam/labs/docs/mwri-security-implications-of-windows-access-tokens-2008-04-14.pdf>Security Implications of Windows Access Tokens – A Penetration Tester’s Guide</a></li><li><a href=https://attl4s.github.io/assets/pdf/Understanding_Windows_Lateral_Movements.pdf>Understanding Windows Lateral Movements</a></li></ul><p>Книги:</p><ul><li>&ldquo;Защита в операционных системах&rdquo; - Проскурин В.Г.</li><li>Programming Windows Security - Keith Brown</li><li>Windows Internals Pt. 1 - Pavel Yosifovich, Alex Ionescu, Mark Russinovich and David Solomon</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://ardent101.github.io/tags/active-directory/>Active Directory</a></li><li><a href=https://ardent101.github.io/tags/%D1%82%D0%BE%D0%BA%D0%B5%D0%BD/>Токен</a></li><li><a href=https://ardent101.github.io/tags/pentest/>Pentest</a></li><li><a href=https://ardent101.github.io/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F/>Теория</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on twitter" href="https://twitter.com/intent/tweet/?text=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f&url=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f&hashtags=ActiveDirectory%2c%d0%a2%d0%be%d0%ba%d0%b5%d0%bd%2cPentest%2c%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f&title=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f&summary=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f&source=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f&title=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on whatsapp" href="https://api.whatsapp.com/send?text=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f%20-%20https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Неприметные токены. Часть 1. Теория on telegram" href="https://telegram.me/share/url?text=%d0%9d%d0%b5%d0%bf%d1%80%d0%b8%d0%bc%d0%b5%d1%82%d0%bd%d1%8b%d0%b5%20%d1%82%d0%be%d0%ba%d0%b5%d0%bd%d1%8b.%20%d0%a7%d0%b0%d1%81%d1%82%d1%8c%201.%20%d0%a2%d0%b5%d0%be%d1%80%d0%b8%d1%8f&url=https%3a%2f%2fardent101.github.io%2fposts%2ftokens_theory%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://ardent101.github.io/>Ardent101</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="копировать";function s(){e.innerText="скопировано!",setTimeout(()=>{e.innerText="копировать"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>